{"ast":null,"code":"/*\n\tThe MIT License (MIT)\n\n\tCopyright (c) 2016 Meetecho\n\n\tPermission is hereby granted, free of charge, to any person obtaining\n\ta copy of this software and associated documentation files (the \"Software\"),\n\tto deal in the Software without restriction, including without limitation\n\tthe rights to use, copy, modify, merge, publish, distribute, sublicense,\n\tand/or sell copies of the Software, and to permit persons to whom the\n\tSoftware is furnished to do so, subject to the following conditions:\n\n\tThe above copyright notice and this permission notice shall be included\n\tin all copies or substantial portions of the Software.\n\n\tTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS\n\tOR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n\tFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL\n\tTHE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR\n\tOTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,\n\tARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR\n\tOTHER DEALINGS IN THE SOFTWARE.\n */\n// List of sessions\nJanus.sessions = {}; // Screensharing Chrome Extension ID\n\nJanus.extensionId = \"hapfgfdkleiggjjpfpenajgdnfckjpaj\";\n\nJanus.isExtensionEnabled = function () {\n  if (window.navigator.userAgent.match('Chrome')) {\n    var chromever = parseInt(window.navigator.userAgent.match(/Chrome\\/(.*) /)[1], 10);\n    var maxver = 33;\n    if (window.navigator.userAgent.match('Linux')) maxver = 35; // \"known\" crash in chrome 34 and 35 on linux\n\n    if (chromever >= 26 && chromever <= maxver) {\n      // Older versions of Chrome don't support this extension-based approach, so lie\n      return true;\n    }\n\n    return $('#janus-extension-installed').length > 0;\n  } else {\n    // Firefox of others, no need for the extension (but this doesn't mean it will work)\n    return true;\n  }\n};\n\nJanus.noop = function () {}; // Initialization\n\n\nJanus.init = function (options) {\n  options = options || {};\n  options.callback = typeof options.callback == \"function\" ? options.callback : Janus.noop;\n\n  if (Janus.initDone === true) {\n    // Already initialized\n    options.callback();\n  } else {\n    if (typeof console == \"undefined\" || typeof console.log == \"undefined\") console = {\n      log: function () {}\n    }; // Console logging (all debugging disabled by default)\n\n    Janus.trace = Janus.noop;\n    Janus.debug = Janus.noop;\n    Janus.vdebug = Janus.noop;\n    Janus.log = Janus.noop;\n    Janus.warn = Janus.noop;\n    Janus.error = Janus.noop;\n\n    if (options.debug === true || options.debug === \"all\") {\n      // Enable all debugging levels\n      Janus.trace = console.trace.bind(console);\n      Janus.debug = console.debug.bind(console);\n      Janus.vdebug = console.debug.bind(console);\n      Janus.log = console.log.bind(console);\n      Janus.warn = console.warn.bind(console);\n      Janus.error = console.error.bind(console);\n    } else if (Array.isArray(options.debug)) {\n      for (var i in options.debug) {\n        var d = options.debug[i];\n\n        switch (d) {\n          case \"trace\":\n            Janus.trace = console.trace.bind(console);\n            break;\n\n          case \"debug\":\n            Janus.debug = console.debug.bind(console);\n            break;\n\n          case \"vdebug\":\n            Janus.vdebug = console.debug.bind(console);\n            break;\n\n          case \"log\":\n            Janus.log = console.log.bind(console);\n            break;\n\n          case \"warn\":\n            Janus.warn = console.warn.bind(console);\n            break;\n\n          case \"error\":\n            Janus.error = console.error.bind(console);\n            break;\n\n          default:\n            console.error(\"Unknown debugging option '\" + d + \"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')\");\n            break;\n        }\n      }\n    }\n\n    Janus.log(\"Initializing library\"); // Helper method to enumerate devices\n\n    Janus.listDevices = function (callback, config) {\n      callback = typeof callback == \"function\" ? callback : Janus.noop;\n      if (config == null) config = {\n        audio: true,\n        video: true\n      };\n\n      if (navigator.mediaDevices) {\n        navigator.mediaDevices.getUserMedia(config).then(function (stream) {\n          navigator.mediaDevices.enumerateDevices().then(function (devices) {\n            Janus.debug(devices);\n            callback(devices); // Get rid of the now useless stream\n\n            try {\n              stream.stop();\n            } catch (e) {}\n\n            try {\n              var tracks = stream.getTracks();\n\n              for (var i in tracks) {\n                var mst = tracks[i];\n                if (mst !== null && mst !== undefined) mst.stop();\n              }\n            } catch (e) {}\n          });\n        }).catch(function (err) {\n          Janus.error(err);\n          callback([]);\n        });\n      } else {\n        Janus.warn(\"navigator.mediaDevices unavailable\");\n        callback([]);\n      }\n    }; // Helper methods to attach/reattach a stream to a video element (previously part of adapter.js)\n\n\n    Janus.attachMediaStream = function (element, stream) {\n      if (adapter.browserDetails.browser === 'chrome') {\n        var chromever = adapter.browserDetails.version;\n\n        if (chromever >= 43) {\n          element.srcObject = stream;\n        } else if (typeof element.src !== 'undefined') {\n          element.src = URL.createObjectURL(stream);\n        } else {\n          Janus.error(\"Error attaching stream to element\");\n        }\n      } else {\n        element.srcObject = stream;\n      }\n    };\n\n    Janus.reattachMediaStream = function (to, from) {\n      if (adapter.browserDetails.browser === 'chrome') {\n        var chromever = adapter.browserDetails.version;\n\n        if (chromever >= 43) {\n          to.srcObject = from.srcObject;\n        } else if (typeof to.src !== 'undefined') {\n          to.src = from.src;\n        }\n      } else if (adapter.browserDetails.browser === 'safari' || window.navigator.userAgent.match(/iPad/i) || window.navigator.userAgent.match(/iPhone/i)) {\n        to.src = from.src;\n      } else {\n        to.srcObject = from.srcObject;\n      }\n    }; // Detect tab close: make sure we don't loose existing onbeforeunload handlers\n\n\n    var oldOBF = window.onbeforeunload;\n\n    window.onbeforeunload = function () {\n      Janus.log(\"Closing window\");\n\n      for (var s in Janus.sessions) {\n        if (Janus.sessions[s] !== null && Janus.sessions[s] !== undefined && Janus.sessions[s].destroyOnUnload) {\n          Janus.log(\"Destroying session \" + s);\n          Janus.sessions[s].destroy({\n            asyncRequest: false\n          });\n        }\n      }\n\n      if (oldOBF && typeof oldOBF == \"function\") oldOBF();\n    };\n\n    Janus.initDone = true;\n    options.callback();\n  }\n}; // Helper method to check whether WebRTC is supported by this browser\n\n\nJanus.isWebrtcSupported = function () {\n  return window.RTCPeerConnection !== undefined && window.RTCPeerConnection !== null && navigator.getUserMedia !== undefined && navigator.getUserMedia !== null;\n}; // Helper method to create random identifiers (e.g., transaction)\n\n\nJanus.randomString = function (len) {\n  var charSet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\n  var randomString = '';\n\n  for (var i = 0; i < len; i++) {\n    var randomPoz = Math.floor(Math.random() * charSet.length);\n    randomString += charSet.substring(randomPoz, randomPoz + 1);\n  }\n\n  return randomString;\n};\n\nfunction Janus(gatewayCallbacks) {\n  if (Janus.initDone === undefined) {\n    gatewayCallbacks.error(\"Library not initialized\");\n    return {};\n  }\n\n  if (!Janus.isWebrtcSupported()) {\n    gatewayCallbacks.error(\"WebRTC not supported by this browser\");\n    return {};\n  }\n\n  Janus.log(\"Library initialized: \" + Janus.initDone);\n  gatewayCallbacks = gatewayCallbacks || {};\n  gatewayCallbacks.success = typeof gatewayCallbacks.success == \"function\" ? gatewayCallbacks.success : jQuery.noop;\n  gatewayCallbacks.error = typeof gatewayCallbacks.error == \"function\" ? gatewayCallbacks.error : jQuery.noop;\n  gatewayCallbacks.destroyed = typeof gatewayCallbacks.destroyed == \"function\" ? gatewayCallbacks.destroyed : jQuery.noop;\n\n  if (gatewayCallbacks.server === null || gatewayCallbacks.server === undefined) {\n    gatewayCallbacks.error(\"Invalid gateway url\");\n    return {};\n  }\n\n  var websockets = false;\n  var ws = null;\n  var wsHandlers = {};\n  var wsKeepaliveTimeoutId = null;\n  var servers = null,\n      serversIndex = 0;\n  var server = gatewayCallbacks.server;\n\n  if ($.isArray(server)) {\n    Janus.log(\"Multiple servers provided (\" + server.length + \"), will use the first that works\");\n    server = null;\n    servers = gatewayCallbacks.server;\n    Janus.debug(servers);\n  } else {\n    if (server.indexOf(\"ws\") === 0) {\n      websockets = true;\n      Janus.log(\"Using WebSockets to contact Janus: \" + server);\n    } else {\n      websockets = false;\n      Janus.log(\"Using REST API to contact Janus: \" + server);\n    }\n  }\n\n  var iceServers = gatewayCallbacks.iceServers;\n  if (iceServers === undefined || iceServers === null) iceServers = [{\n    urls: \"stun:stun.l.google.com:19302\"\n  }];\n  var iceTransportPolicy = gatewayCallbacks.iceTransportPolicy; // Whether IPv6 candidates should be gathered\n\n  var ipv6Support = gatewayCallbacks.ipv6;\n  if (ipv6Support === undefined || ipv6Support === null) ipv6Support = false; // Whether we should enable the withCredentials flag for XHR requests\n\n  var withCredentials = false;\n  if (gatewayCallbacks.withCredentials !== undefined && gatewayCallbacks.withCredentials !== null) withCredentials = gatewayCallbacks.withCredentials === true; // Optional max events\n\n  var maxev = null;\n  if (gatewayCallbacks.max_poll_events !== undefined && gatewayCallbacks.max_poll_events !== null) maxev = gatewayCallbacks.max_poll_events;\n  if (maxev < 1) maxev = 1; // Token to use (only if the token based authentication mechanism is enabled)\n\n  var token = null;\n  if (gatewayCallbacks.token !== undefined && gatewayCallbacks.token !== null) token = gatewayCallbacks.token; // API secret to use (only if the shared API secret is enabled)\n\n  var apisecret = null;\n  if (gatewayCallbacks.apisecret !== undefined && gatewayCallbacks.apisecret !== null) apisecret = gatewayCallbacks.apisecret; // Whether we should destroy this session when onbeforeunload is called\n\n  this.destroyOnUnload = true;\n  if (gatewayCallbacks.destroyOnUnload !== undefined && gatewayCallbacks.destroyOnUnload !== null) this.destroyOnUnload = gatewayCallbacks.destroyOnUnload === true;\n  var connected = false;\n  var sessionId = null;\n  var pluginHandles = {};\n  var that = this;\n  var retries = 0;\n  var transactions = {};\n  createSession(gatewayCallbacks); // Public methods\n\n  this.getServer = function () {\n    return server;\n  };\n\n  this.isConnected = function () {\n    return connected;\n  };\n\n  this.getSessionId = function () {\n    return sessionId;\n  };\n\n  this.destroy = function (callbacks) {\n    destroySession(callbacks);\n  };\n\n  this.attach = function (callbacks) {\n    createHandle(callbacks);\n  };\n\n  function eventHandler() {\n    if (sessionId == null) return;\n    Janus.debug('Long poll...');\n\n    if (!connected) {\n      Janus.warn(\"Is the gateway down? (connected=false)\");\n      return;\n    }\n\n    var longpoll = server + \"/\" + sessionId + \"?rid=\" + new Date().getTime();\n    if (maxev !== undefined && maxev !== null) longpoll = longpoll + \"&maxev=\" + maxev;\n    if (token !== null && token !== undefined) longpoll = longpoll + \"&token=\" + token;\n    if (apisecret !== null && apisecret !== undefined) longpoll = longpoll + \"&apisecret=\" + apisecret;\n    $.ajax({\n      type: 'GET',\n      url: longpoll,\n      xhrFields: {\n        withCredentials: withCredentials\n      },\n      cache: false,\n      timeout: 60000,\n      // FIXME\n      success: handleEvent,\n      error: function (XMLHttpRequest, textStatus, errorThrown) {\n        Janus.error(textStatus + \": \" + errorThrown);\n        retries++;\n\n        if (retries > 3) {\n          // Did we just lose the gateway? :-(\n          connected = false;\n          gatewayCallbacks.error(\"Lost connection to the gateway (is it down?)\");\n          return;\n        }\n\n        eventHandler();\n      },\n      dataType: \"json\"\n    });\n  } // Private event handler: this will trigger plugin callbacks, if set\n\n\n  function handleEvent(json, skipTimeout) {\n    retries = 0;\n    if (!websockets && sessionId !== undefined && sessionId !== null && skipTimeout !== true) setTimeout(eventHandler, 200);\n\n    if (!websockets && $.isArray(json)) {\n      // We got an array: it means we passed a maxev > 1, iterate on all objects\n      for (var i = 0; i < json.length; i++) {\n        handleEvent(json[i], true);\n      }\n\n      return;\n    }\n\n    if (json[\"janus\"] === \"keepalive\") {\n      // Nothing happened\n      Janus.vdebug(\"Got a keepalive on session \" + sessionId);\n      return;\n    } else if (json[\"janus\"] === \"ack\") {\n      // Just an ack, we can probably ignore\n      Janus.debug(\"Got an ack on session \" + sessionId);\n      Janus.debug(json);\n      var transaction = json[\"transaction\"];\n\n      if (transaction !== null && transaction !== undefined) {\n        var reportSuccess = transactions[transaction];\n\n        if (reportSuccess !== null && reportSuccess !== undefined) {\n          reportSuccess(json);\n        }\n\n        delete transactions[transaction];\n      }\n\n      return;\n    } else if (json[\"janus\"] === \"success\") {\n      // Success!\n      Janus.debug(\"Got a success on session \" + sessionId);\n      Janus.debug(json);\n      var transaction = json[\"transaction\"];\n\n      if (transaction !== null && transaction !== undefined) {\n        var reportSuccess = transactions[transaction];\n\n        if (reportSuccess !== null && reportSuccess !== undefined) {\n          reportSuccess(json);\n        }\n\n        delete transactions[transaction];\n      }\n\n      return;\n    } else if (json[\"janus\"] === \"webrtcup\") {\n      // The PeerConnection with the gateway is up! Notify this\n      Janus.debug(\"Got a webrtcup event on session \" + sessionId);\n      Janus.debug(json);\n      var sender = json[\"sender\"];\n\n      if (sender === undefined || sender === null) {\n        Janus.warn(\"Missing sender...\");\n        return;\n      }\n\n      var pluginHandle = pluginHandles[sender];\n\n      if (pluginHandle === undefined || pluginHandle === null) {\n        Janus.debug(\"This handle is not attached to this session\");\n        return;\n      }\n\n      pluginHandle.webrtcState(true);\n      return;\n    } else if (json[\"janus\"] === \"hangup\") {\n      // A plugin asked the core to hangup a PeerConnection on one of our handles\n      Janus.debug(\"Got a hangup event on session \" + sessionId);\n      Janus.debug(json);\n      var sender = json[\"sender\"];\n\n      if (sender === undefined || sender === null) {\n        Janus.warn(\"Missing sender...\");\n        return;\n      }\n\n      var pluginHandle = pluginHandles[sender];\n\n      if (pluginHandle === undefined || pluginHandle === null) {\n        Janus.debug(\"This handle is not attached to this session\");\n        return;\n      }\n\n      pluginHandle.webrtcState(false, json[\"reason\"]);\n      pluginHandle.hangup();\n    } else if (json[\"janus\"] === \"detached\") {\n      // A plugin asked the core to detach one of our handles\n      Janus.debug(\"Got a detached event on session \" + sessionId);\n      Janus.debug(json);\n      var sender = json[\"sender\"];\n\n      if (sender === undefined || sender === null) {\n        Janus.warn(\"Missing sender...\");\n        return;\n      }\n\n      var pluginHandle = pluginHandles[sender];\n\n      if (pluginHandle === undefined || pluginHandle === null) {\n        // Don't warn here because destroyHandle causes this situation.\n        return;\n      }\n\n      pluginHandle.detached = true;\n      pluginHandle.ondetached();\n      pluginHandle.detach();\n    } else if (json[\"janus\"] === \"media\") {\n      // Media started/stopped flowing\n      Janus.debug(\"Got a media event on session \" + sessionId);\n      Janus.debug(json);\n      var sender = json[\"sender\"];\n\n      if (sender === undefined || sender === null) {\n        Janus.warn(\"Missing sender...\");\n        return;\n      }\n\n      var pluginHandle = pluginHandles[sender];\n\n      if (pluginHandle === undefined || pluginHandle === null) {\n        Janus.debug(\"This handle is not attached to this session\");\n        return;\n      }\n\n      pluginHandle.mediaState(json[\"type\"], json[\"receiving\"]);\n    } else if (json[\"janus\"] === \"slowlink\") {\n      Janus.debug(\"Got a slowlink event on session \" + sessionId);\n      Janus.debug(json); // Trouble uplink or downlink\n\n      var sender = json[\"sender\"];\n\n      if (sender === undefined || sender === null) {\n        Janus.warn(\"Missing sender...\");\n        return;\n      }\n\n      var pluginHandle = pluginHandles[sender];\n\n      if (pluginHandle === undefined || pluginHandle === null) {\n        Janus.debug(\"This handle is not attached to this session\");\n        return;\n      }\n\n      pluginHandle.slowLink(json[\"uplink\"], json[\"nacks\"]);\n    } else if (json[\"janus\"] === \"error\") {\n      // Oops, something wrong happened\n      Janus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason); // FIXME\n\n      Janus.debug(json);\n      var transaction = json[\"transaction\"];\n\n      if (transaction !== null && transaction !== undefined) {\n        var reportSuccess = transactions[transaction];\n\n        if (reportSuccess !== null && reportSuccess !== undefined) {\n          reportSuccess(json);\n        }\n\n        delete transactions[transaction];\n      }\n\n      return;\n    } else if (json[\"janus\"] === \"event\") {\n      Janus.debug(\"Got a plugin event on session \" + sessionId);\n      Janus.debug(json);\n      var sender = json[\"sender\"];\n\n      if (sender === undefined || sender === null) {\n        Janus.warn(\"Missing sender...\");\n        return;\n      }\n\n      var plugindata = json[\"plugindata\"];\n\n      if (plugindata === undefined || plugindata === null) {\n        Janus.warn(\"Missing plugindata...\");\n        return;\n      }\n\n      Janus.debug(\"  -- Event is coming from \" + sender + \" (\" + plugindata[\"plugin\"] + \")\");\n      var data = plugindata[\"data\"];\n      Janus.debug(data);\n      var pluginHandle = pluginHandles[sender];\n\n      if (pluginHandle === undefined || pluginHandle === null) {\n        Janus.warn(\"This handle is not attached to this session\");\n        return;\n      }\n\n      var jsep = json[\"jsep\"];\n\n      if (jsep !== undefined && jsep !== null) {\n        Janus.debug(\"Handling SDP as well...\");\n        Janus.debug(jsep);\n      }\n\n      var callback = pluginHandle.onmessage;\n\n      if (callback !== null && callback !== undefined) {\n        Janus.debug(\"Notifying application...\"); // Send to callback specified when attaching plugin handle\n\n        callback(data, jsep);\n      } else {\n        // Send to generic callback (?)\n        Janus.debug(\"No provided notification callback\");\n      }\n    } else {\n      Janus.warn(\"Unkown message/event  '\" + json[\"janus\"] + \"' on session \" + sessionId);\n      Janus.debug(json);\n    }\n  } // Private helper to send keep-alive messages on WebSockets\n\n\n  function keepAlive() {\n    if (server === null || !websockets || !connected) return;\n    wsKeepaliveTimeoutId = setTimeout(keepAlive, 30000);\n    var request = {\n      \"janus\": \"keepalive\",\n      \"session_id\": sessionId,\n      \"transaction\": Janus.randomString(12)\n    };\n    if (token !== null && token !== undefined) request[\"token\"] = token;\n    if (apisecret !== null && apisecret !== undefined) request[\"apisecret\"] = apisecret;\n    ws.send(JSON.stringify(request));\n  } // Private method to create a session\n\n\n  function createSession(callbacks) {\n    var transaction = Janus.randomString(12);\n    var request = {\n      \"janus\": \"create\",\n      \"transaction\": transaction\n    };\n    if (token !== null && token !== undefined) request[\"token\"] = token;\n    if (apisecret !== null && apisecret !== undefined) request[\"apisecret\"] = apisecret;\n\n    if (server === null && $.isArray(servers)) {\n      // We still need to find a working server from the list we were given\n      server = servers[serversIndex];\n\n      if (server.indexOf(\"ws\") === 0) {\n        websockets = true;\n        Janus.log(\"Server #\" + (serversIndex + 1) + \": trying WebSockets to contact Janus (\" + server + \")\");\n      } else {\n        websockets = false;\n        Janus.log(\"Server #\" + (serversIndex + 1) + \": trying REST API to contact Janus (\" + server + \")\");\n      }\n    }\n\n    if (websockets) {\n      ws = new WebSocket(server, 'janus-protocol');\n      wsHandlers = {\n        'error': function () {\n          Janus.error(\"Error connecting to the Janus WebSockets server... \" + server);\n\n          if ($.isArray(servers)) {\n            serversIndex++;\n\n            if (serversIndex == servers.length) {\n              // We tried all the servers the user gave us and they all failed\n              callbacks.error(\"Error connecting to any of the provided Janus servers: Is the gateway down?\");\n              return;\n            } // Let's try the next server\n\n\n            server = null;\n            setTimeout(function () {\n              createSession(callbacks);\n            }, 200);\n            return;\n          }\n\n          callbacks.error(\"Error connecting to the Janus WebSockets server: Is the gateway down?\");\n        },\n        'open': function () {\n          // We need to be notified about the success\n          transactions[transaction] = function (json) {\n            Janus.debug(json);\n\n            if (json[\"janus\"] !== \"success\") {\n              Janus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason); // FIXME\n\n              callbacks.error(json[\"error\"].reason);\n              return;\n            }\n\n            wsKeepaliveTimeoutId = setTimeout(keepAlive, 30000);\n            connected = true;\n            sessionId = json.data[\"id\"];\n            Janus.log(\"Created session: \" + sessionId);\n            Janus.sessions[sessionId] = that;\n            callbacks.success();\n          };\n\n          ws.send(JSON.stringify(request));\n        },\n        'message': function (event) {\n          handleEvent(JSON.parse(event.data));\n        },\n        'close': function () {\n          if (server === null || !connected) {\n            return;\n          }\n\n          connected = false; // FIXME What if this is called when the page is closed?\n\n          gatewayCallbacks.error(\"Lost connection to the gateway (is it down?)\");\n        }\n      };\n\n      for (var eventName in wsHandlers) {\n        ws.addEventListener(eventName, wsHandlers[eventName]);\n      }\n\n      return;\n    }\n\n    $.ajax({\n      type: 'POST',\n      url: server,\n      xhrFields: {\n        withCredentials: withCredentials\n      },\n      cache: false,\n      contentType: \"application/json\",\n      data: JSON.stringify(request),\n      success: function (json) {\n        Janus.debug(json);\n\n        if (json[\"janus\"] !== \"success\") {\n          Janus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason); // FIXME\n\n          callbacks.error(json[\"error\"].reason);\n          return;\n        }\n\n        connected = true;\n        sessionId = json.data[\"id\"];\n        Janus.log(\"Created session: \" + sessionId);\n        Janus.sessions[sessionId] = that;\n        eventHandler();\n        callbacks.success();\n      },\n      error: function (XMLHttpRequest, textStatus, errorThrown) {\n        Janus.error(textStatus + \": \" + errorThrown); // FIXME\n\n        if ($.isArray(servers)) {\n          serversIndex++;\n\n          if (serversIndex == servers.length) {\n            // We tried all the servers the user gave us and they all failed\n            callbacks.error(\"Error connecting to any of the provided Janus servers: Is the gateway down?\");\n            return;\n          } // Let's try the next server\n\n\n          server = null;\n          setTimeout(function () {\n            createSession(callbacks);\n          }, 200);\n          return;\n        }\n\n        if (errorThrown === \"\") callbacks.error(textStatus + \": Is the gateway down?\");else callbacks.error(textStatus + \": \" + errorThrown);\n      },\n      dataType: \"json\"\n    });\n  } // Private method to destroy a session\n\n\n  function destroySession(callbacks) {\n    callbacks = callbacks || {}; // FIXME This method triggers a success even when we fail\n\n    callbacks.success = typeof callbacks.success == \"function\" ? callbacks.success : jQuery.noop;\n    var asyncRequest = true;\n    if (callbacks.asyncRequest !== undefined && callbacks.asyncRequest !== null) asyncRequest = callbacks.asyncRequest === true;\n    Janus.log(\"Destroying session \" + sessionId + \" (async=\" + asyncRequest + \")\");\n\n    if (!connected) {\n      Janus.warn(\"Is the gateway down? (connected=false)\");\n      callbacks.success();\n      return;\n    }\n\n    if (sessionId === undefined || sessionId === null) {\n      Janus.warn(\"No session to destroy\");\n      callbacks.success();\n      gatewayCallbacks.destroyed();\n      return;\n    }\n\n    delete Janus.sessions[sessionId]; // No need to destroy all handles first, Janus will do that itself\n\n    var request = {\n      \"janus\": \"destroy\",\n      \"transaction\": Janus.randomString(12)\n    };\n    if (token !== null && token !== undefined) request[\"token\"] = token;\n    if (apisecret !== null && apisecret !== undefined) request[\"apisecret\"] = apisecret;\n\n    if (websockets) {\n      request[\"session_id\"] = sessionId;\n\n      var unbindWebSocket = function () {\n        for (var eventName in wsHandlers) {\n          ws.removeEventListener(eventName, wsHandlers[eventName]);\n        }\n\n        ws.removeEventListener('message', onUnbindMessage);\n        ws.removeEventListener('error', onUnbindError);\n\n        if (wsKeepaliveTimeoutId) {\n          clearTimeout(wsKeepaliveTimeoutId);\n        }\n      };\n\n      var onUnbindMessage = function (event) {\n        var data = JSON.parse(event.data);\n\n        if (data.session_id == request.session_id && data.transaction == request.transaction) {\n          unbindWebSocket();\n          callbacks.success();\n          gatewayCallbacks.destroyed();\n        }\n      };\n\n      var onUnbindError = function (event) {\n        unbindWebSocket();\n        callbacks.error(\"Failed to destroy the gateway: Is the gateway down?\");\n        gatewayCallbacks.destroyed();\n      };\n\n      ws.addEventListener('message', onUnbindMessage);\n      ws.addEventListener('error', onUnbindError);\n      ws.send(JSON.stringify(request));\n      return;\n    }\n\n    $.ajax({\n      type: 'POST',\n      url: server + \"/\" + sessionId,\n      async: asyncRequest,\n      // Sometimes we need false here, or destroying in onbeforeunload won't work\n      xhrFields: {\n        withCredentials: withCredentials\n      },\n      cache: false,\n      contentType: \"application/json\",\n      data: JSON.stringify(request),\n      success: function (json) {\n        Janus.log(\"Destroyed session:\");\n        Janus.debug(json);\n        sessionId = null;\n        connected = false;\n\n        if (json[\"janus\"] !== \"success\") {\n          Janus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason); // FIXME\n        }\n\n        callbacks.success();\n        gatewayCallbacks.destroyed();\n      },\n      error: function (XMLHttpRequest, textStatus, errorThrown) {\n        Janus.error(textStatus + \": \" + errorThrown); // FIXME\n        // Reset everything anyway\n\n        sessionId = null;\n        connected = false;\n        callbacks.success();\n        gatewayCallbacks.destroyed();\n      },\n      dataType: \"json\"\n    });\n  } // Private method to create a plugin handle\n\n\n  function createHandle(callbacks) {\n    callbacks = callbacks || {};\n    callbacks.success = typeof callbacks.success == \"function\" ? callbacks.success : jQuery.noop;\n    callbacks.error = typeof callbacks.error == \"function\" ? callbacks.error : jQuery.noop;\n    callbacks.consentDialog = typeof callbacks.consentDialog == \"function\" ? callbacks.consentDialog : jQuery.noop;\n    callbacks.iceState = typeof callbacks.iceState == \"function\" ? callbacks.iceState : jQuery.noop;\n    callbacks.mediaState = typeof callbacks.mediaState == \"function\" ? callbacks.mediaState : jQuery.noop;\n    callbacks.webrtcState = typeof callbacks.webrtcState == \"function\" ? callbacks.webrtcState : jQuery.noop;\n    callbacks.slowLink = typeof callbacks.slowLink == \"function\" ? callbacks.slowLink : jQuery.noop;\n    callbacks.onmessage = typeof callbacks.onmessage == \"function\" ? callbacks.onmessage : jQuery.noop;\n    callbacks.onlocalstream = typeof callbacks.onlocalstream == \"function\" ? callbacks.onlocalstream : jQuery.noop;\n    callbacks.onremotestream = typeof callbacks.onremotestream == \"function\" ? callbacks.onremotestream : jQuery.noop;\n    callbacks.ondata = typeof callbacks.ondata == \"function\" ? callbacks.ondata : jQuery.noop;\n    callbacks.ondataopen = typeof callbacks.ondataopen == \"function\" ? callbacks.ondataopen : jQuery.noop;\n    callbacks.oncleanup = typeof callbacks.oncleanup == \"function\" ? callbacks.oncleanup : jQuery.noop;\n    callbacks.ondetached = typeof callbacks.ondetached == \"function\" ? callbacks.ondetached : jQuery.noop;\n\n    if (!connected) {\n      Janus.warn(\"Is the gateway down? (connected=false)\");\n      callbacks.error(\"Is the gateway down? (connected=false)\");\n      return;\n    }\n\n    var plugin = callbacks.plugin;\n\n    if (plugin === undefined || plugin === null) {\n      Janus.error(\"Invalid plugin\");\n      callbacks.error(\"Invalid plugin\");\n      return;\n    }\n\n    var opaqueId = callbacks.opaqueId;\n    var transaction = Janus.randomString(12);\n    var request = {\n      \"janus\": \"attach\",\n      \"plugin\": plugin,\n      \"opaque_id\": opaqueId,\n      \"transaction\": transaction\n    };\n    if (token !== null && token !== undefined) request[\"token\"] = token;\n    if (apisecret !== null && apisecret !== undefined) request[\"apisecret\"] = apisecret; // If we know the browser supports BUNDLE and/or rtcp-mux, let's advertise those right away\n\n    if (adapter.browserDetails.browser == \"chrome\" || adapter.browserDetails.browser == \"firefox\") {\n      request[\"force-bundle\"] = true;\n      request[\"force-rtcp-mux\"] = true;\n    }\n\n    if (websockets) {\n      transactions[transaction] = function (json) {\n        Janus.debug(json);\n\n        if (json[\"janus\"] !== \"success\") {\n          Janus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason); // FIXME\n\n          callbacks.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason);\n          return;\n        }\n\n        var handleId = json.data[\"id\"];\n        Janus.log(\"Created handle: \" + handleId);\n        var pluginHandle = {\n          session: that,\n          plugin: plugin,\n          id: handleId,\n          detached: false,\n          webrtcStuff: {\n            started: false,\n            myStream: null,\n            streamExternal: false,\n            remoteStream: null,\n            mySdp: null,\n            pc: null,\n            dataChannel: null,\n            dtmfSender: null,\n            trickle: true,\n            iceDone: false,\n            sdpSent: false,\n            volume: {\n              value: null,\n              timer: null\n            },\n            bitrate: {\n              value: null,\n              bsnow: null,\n              bsbefore: null,\n              tsnow: null,\n              tsbefore: null,\n              timer: null\n            }\n          },\n          getId: function () {\n            return handleId;\n          },\n          getPlugin: function () {\n            return plugin;\n          },\n          getVolume: function () {\n            return getVolume(handleId);\n          },\n          isAudioMuted: function () {\n            return isMuted(handleId, false);\n          },\n          muteAudio: function () {\n            return mute(handleId, false, true);\n          },\n          unmuteAudio: function () {\n            return mute(handleId, false, false);\n          },\n          isVideoMuted: function () {\n            return isMuted(handleId, true);\n          },\n          muteVideo: function () {\n            return mute(handleId, true, true);\n          },\n          unmuteVideo: function () {\n            return mute(handleId, true, false);\n          },\n          getBitrate: function () {\n            return getBitrate(handleId);\n          },\n          send: function (callbacks) {\n            sendMessage(handleId, callbacks);\n          },\n          data: function (callbacks) {\n            sendData(handleId, callbacks);\n          },\n          dtmf: function (callbacks) {\n            sendDtmf(handleId, callbacks);\n          },\n          consentDialog: callbacks.consentDialog,\n          iceState: callbacks.iceState,\n          mediaState: callbacks.mediaState,\n          webrtcState: callbacks.webrtcState,\n          slowLink: callbacks.slowLink,\n          onmessage: callbacks.onmessage,\n          createOffer: function (callbacks) {\n            prepareWebrtc(handleId, callbacks);\n          },\n          createAnswer: function (callbacks) {\n            prepareWebrtc(handleId, callbacks);\n          },\n          handleRemoteJsep: function (callbacks) {\n            prepareWebrtcPeer(handleId, callbacks);\n          },\n          onlocalstream: callbacks.onlocalstream,\n          onremotestream: callbacks.onremotestream,\n          ondata: callbacks.ondata,\n          ondataopen: callbacks.ondataopen,\n          oncleanup: callbacks.oncleanup,\n          ondetached: callbacks.ondetached,\n          hangup: function (sendRequest) {\n            cleanupWebrtc(handleId, sendRequest === true);\n          },\n          detach: function (callbacks) {\n            destroyHandle(handleId, callbacks);\n          }\n        };\n        pluginHandles[handleId] = pluginHandle;\n        callbacks.success(pluginHandle);\n      };\n\n      request[\"session_id\"] = sessionId;\n      ws.send(JSON.stringify(request));\n      return;\n    }\n\n    $.ajax({\n      type: 'POST',\n      url: server + \"/\" + sessionId,\n      xhrFields: {\n        withCredentials: withCredentials\n      },\n      cache: false,\n      contentType: \"application/json\",\n      data: JSON.stringify(request),\n      success: function (json) {\n        Janus.debug(json);\n\n        if (json[\"janus\"] !== \"success\") {\n          Janus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason); // FIXME\n\n          callbacks.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason);\n          return;\n        }\n\n        var handleId = json.data[\"id\"];\n        Janus.log(\"Created handle: \" + handleId);\n        var pluginHandle = {\n          session: that,\n          plugin: plugin,\n          id: handleId,\n          detached: false,\n          webrtcStuff: {\n            started: false,\n            myStream: null,\n            streamExternal: false,\n            remoteStream: null,\n            mySdp: null,\n            pc: null,\n            dataChannel: null,\n            dtmfSender: null,\n            trickle: true,\n            iceDone: false,\n            sdpSent: false,\n            volume: {\n              value: null,\n              timer: null\n            },\n            bitrate: {\n              value: null,\n              bsnow: null,\n              bsbefore: null,\n              tsnow: null,\n              tsbefore: null,\n              timer: null\n            }\n          },\n          getId: function () {\n            return handleId;\n          },\n          getPlugin: function () {\n            return plugin;\n          },\n          getVolume: function () {\n            return getVolume(handleId);\n          },\n          isAudioMuted: function () {\n            return isMuted(handleId, false);\n          },\n          muteAudio: function () {\n            return mute(handleId, false, true);\n          },\n          unmuteAudio: function () {\n            return mute(handleId, false, false);\n          },\n          isVideoMuted: function () {\n            return isMuted(handleId, true);\n          },\n          muteVideo: function () {\n            return mute(handleId, true, true);\n          },\n          unmuteVideo: function () {\n            return mute(handleId, true, false);\n          },\n          getBitrate: function () {\n            return getBitrate(handleId);\n          },\n          send: function (callbacks) {\n            sendMessage(handleId, callbacks);\n          },\n          data: function (callbacks) {\n            sendData(handleId, callbacks);\n          },\n          dtmf: function (callbacks) {\n            sendDtmf(handleId, callbacks);\n          },\n          consentDialog: callbacks.consentDialog,\n          iceState: callbacks.iceState,\n          mediaState: callbacks.mediaState,\n          webrtcState: callbacks.webrtcState,\n          slowLink: callbacks.slowLink,\n          onmessage: callbacks.onmessage,\n          createOffer: function (callbacks) {\n            prepareWebrtc(handleId, callbacks);\n          },\n          createAnswer: function (callbacks) {\n            prepareWebrtc(handleId, callbacks);\n          },\n          handleRemoteJsep: function (callbacks) {\n            prepareWebrtcPeer(handleId, callbacks);\n          },\n          onlocalstream: callbacks.onlocalstream,\n          onremotestream: callbacks.onremotestream,\n          ondata: callbacks.ondata,\n          ondataopen: callbacks.ondataopen,\n          oncleanup: callbacks.oncleanup,\n          ondetached: callbacks.ondetached,\n          hangup: function (sendRequest) {\n            cleanupWebrtc(handleId, sendRequest === true);\n          },\n          detach: function (callbacks) {\n            destroyHandle(handleId, callbacks);\n          }\n        };\n        pluginHandles[handleId] = pluginHandle;\n        callbacks.success(pluginHandle);\n      },\n      error: function (XMLHttpRequest, textStatus, errorThrown) {\n        Janus.error(textStatus + \": \" + errorThrown); // FIXME\n      },\n      dataType: \"json\"\n    });\n  } // Private method to send a message\n\n\n  function sendMessage(handleId, callbacks) {\n    callbacks = callbacks || {};\n    callbacks.success = typeof callbacks.success == \"function\" ? callbacks.success : jQuery.noop;\n    callbacks.error = typeof callbacks.error == \"function\" ? callbacks.error : jQuery.noop;\n\n    if (!connected) {\n      Janus.warn(\"Is the gateway down? (connected=false)\");\n      callbacks.error(\"Is the gateway down? (connected=false)\");\n      return;\n    }\n\n    var message = callbacks.message;\n    var jsep = callbacks.jsep;\n    var transaction = Janus.randomString(12);\n    var request = {\n      \"janus\": \"message\",\n      \"body\": message,\n      \"transaction\": transaction\n    };\n    if (token !== null && token !== undefined) request[\"token\"] = token;\n    if (apisecret !== null && apisecret !== undefined) request[\"apisecret\"] = apisecret;\n    if (jsep !== null && jsep !== undefined) request.jsep = jsep;\n    Janus.debug(\"Sending message to plugin (handle=\" + handleId + \"):\");\n    Janus.debug(request);\n\n    if (websockets) {\n      request[\"session_id\"] = sessionId;\n      request[\"handle_id\"] = handleId;\n\n      transactions[transaction] = function (json) {\n        Janus.debug(\"Message sent!\");\n        Janus.debug(json);\n\n        if (json[\"janus\"] === \"success\") {\n          // We got a success, must have been a synchronous transaction\n          var plugindata = json[\"plugindata\"];\n\n          if (plugindata === undefined || plugindata === null) {\n            Janus.warn(\"Request succeeded, but missing plugindata...\");\n            callbacks.success();\n            return;\n          }\n\n          Janus.log(\"Synchronous transaction successful (\" + plugindata[\"plugin\"] + \")\");\n          var data = plugindata[\"data\"];\n          Janus.debug(data);\n          callbacks.success(data);\n          return;\n        } else if (json[\"janus\"] !== \"ack\") {\n          // Not a success and not an ack, must be an error\n          if (json[\"error\"] !== undefined && json[\"error\"] !== null) {\n            Janus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason); // FIXME\n\n            callbacks.error(json[\"error\"].code + \" \" + json[\"error\"].reason);\n          } else {\n            Janus.error(\"Unknown error\"); // FIXME\n\n            callbacks.error(\"Unknown error\");\n          }\n\n          return;\n        } // If we got here, the plugin decided to handle the request asynchronously\n\n\n        callbacks.success();\n      };\n\n      ws.send(JSON.stringify(request));\n      return;\n    }\n\n    $.ajax({\n      type: 'POST',\n      url: server + \"/\" + sessionId + \"/\" + handleId,\n      xhrFields: {\n        withCredentials: withCredentials\n      },\n      cache: false,\n      contentType: \"application/json\",\n      data: JSON.stringify(request),\n      success: function (json) {\n        Janus.debug(\"Message sent!\");\n        Janus.debug(json);\n\n        if (json[\"janus\"] === \"success\") {\n          // We got a success, must have been a synchronous transaction\n          var plugindata = json[\"plugindata\"];\n\n          if (plugindata === undefined || plugindata === null) {\n            Janus.warn(\"Request succeeded, but missing plugindata...\");\n            callbacks.success();\n            return;\n          }\n\n          Janus.log(\"Synchronous transaction successful (\" + plugindata[\"plugin\"] + \")\");\n          var data = plugindata[\"data\"];\n          Janus.debug(data);\n          callbacks.success(data);\n          return;\n        } else if (json[\"janus\"] !== \"ack\") {\n          // Not a success and not an ack, must be an error\n          if (json[\"error\"] !== undefined && json[\"error\"] !== null) {\n            Janus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason); // FIXME\n\n            callbacks.error(json[\"error\"].code + \" \" + json[\"error\"].reason);\n          } else {\n            Janus.error(\"Unknown error\"); // FIXME\n\n            callbacks.error(\"Unknown error\");\n          }\n\n          return;\n        } // If we got here, the plugin decided to handle the request asynchronously\n\n\n        callbacks.success();\n      },\n      error: function (XMLHttpRequest, textStatus, errorThrown) {\n        Janus.error(textStatus + \": \" + errorThrown); // FIXME\n\n        callbacks.error(textStatus + \": \" + errorThrown);\n      },\n      dataType: \"json\"\n    });\n  } // Private method to send a trickle candidate\n\n\n  function sendTrickleCandidate(handleId, candidate) {\n    if (!connected) {\n      Janus.warn(\"Is the gateway down? (connected=false)\");\n      return;\n    }\n\n    var request = {\n      \"janus\": \"trickle\",\n      \"candidate\": candidate,\n      \"transaction\": Janus.randomString(12)\n    };\n    if (token !== null && token !== undefined) request[\"token\"] = token;\n    if (apisecret !== null && apisecret !== undefined) request[\"apisecret\"] = apisecret;\n    Janus.vdebug(\"Sending trickle candidate (handle=\" + handleId + \"):\");\n    Janus.vdebug(request);\n\n    if (websockets) {\n      request[\"session_id\"] = sessionId;\n      request[\"handle_id\"] = handleId;\n      ws.send(JSON.stringify(request));\n      return;\n    }\n\n    $.ajax({\n      type: 'POST',\n      url: server + \"/\" + sessionId + \"/\" + handleId,\n      xhrFields: {\n        withCredentials: withCredentials\n      },\n      cache: false,\n      contentType: \"application/json\",\n      data: JSON.stringify(request),\n      success: function (json) {\n        Janus.vdebug(\"Candidate sent!\");\n        Janus.vdebug(json);\n\n        if (json[\"janus\"] !== \"ack\") {\n          Janus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason); // FIXME\n\n          return;\n        }\n      },\n      error: function (XMLHttpRequest, textStatus, errorThrown) {\n        Janus.error(textStatus + \": \" + errorThrown); // FIXME\n      },\n      dataType: \"json\"\n    });\n  } // Private method to send a data channel message\n\n\n  function sendData(handleId, callbacks) {\n    callbacks = callbacks || {};\n    callbacks.success = typeof callbacks.success == \"function\" ? callbacks.success : jQuery.noop;\n    callbacks.error = typeof callbacks.error == \"function\" ? callbacks.error : jQuery.noop;\n    var pluginHandle = pluginHandles[handleId];\n\n    if (pluginHandle === null || pluginHandle === undefined || pluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n      Janus.warn(\"Invalid handle\");\n      callbacks.error(\"Invalid handle\");\n      return;\n    }\n\n    var config = pluginHandle.webrtcStuff;\n    var text = callbacks.text;\n\n    if (text === null || text === undefined) {\n      Janus.warn(\"Invalid text\");\n      callbacks.error(\"Invalid text\");\n      return;\n    }\n\n    Janus.log(\"Sending string on data channel: \" + text);\n    config.dataChannel.send(text);\n    callbacks.success();\n  } // Private method to send a DTMF tone\n\n\n  function sendDtmf(handleId, callbacks) {\n    callbacks = callbacks || {};\n    callbacks.success = typeof callbacks.success == \"function\" ? callbacks.success : jQuery.noop;\n    callbacks.error = typeof callbacks.error == \"function\" ? callbacks.error : jQuery.noop;\n    var pluginHandle = pluginHandles[handleId];\n\n    if (pluginHandle === null || pluginHandle === undefined || pluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n      Janus.warn(\"Invalid handle\");\n      callbacks.error(\"Invalid handle\");\n      return;\n    }\n\n    var config = pluginHandle.webrtcStuff;\n\n    if (config.dtmfSender === null || config.dtmfSender === undefined) {\n      // Create the DTMF sender, if possible\n      if (config.myStream !== undefined && config.myStream !== null) {\n        var tracks = config.myStream.getAudioTracks();\n\n        if (tracks !== null && tracks !== undefined && tracks.length > 0) {\n          var local_audio_track = tracks[0];\n          config.dtmfSender = config.pc.createDTMFSender(local_audio_track);\n          Janus.log(\"Created DTMF Sender\");\n\n          config.dtmfSender.ontonechange = function (tone) {\n            Janus.debug(\"Sent DTMF tone: \" + tone.tone);\n          };\n        }\n      }\n\n      if (config.dtmfSender === null || config.dtmfSender === undefined) {\n        Janus.warn(\"Invalid DTMF configuration\");\n        callbacks.error(\"Invalid DTMF configuration\");\n        return;\n      }\n    }\n\n    var dtmf = callbacks.dtmf;\n\n    if (dtmf === null || dtmf === undefined) {\n      Janus.warn(\"Invalid DTMF parameters\");\n      callbacks.error(\"Invalid DTMF parameters\");\n      return;\n    }\n\n    var tones = dtmf.tones;\n\n    if (tones === null || tones === undefined) {\n      Janus.warn(\"Invalid DTMF string\");\n      callbacks.error(\"Invalid DTMF string\");\n      return;\n    }\n\n    var duration = dtmf.duration;\n    if (duration === null || duration === undefined) duration = 500; // We choose 500ms as the default duration for a tone\n\n    var gap = dtmf.gap;\n    if (gap === null || gap === undefined) gap = 50; // We choose 50ms as the default gap between tones\n\n    Janus.debug(\"Sending DTMF string \" + tones + \" (duration \" + duration + \"ms, gap \" + gap + \"ms)\");\n    config.dtmfSender.insertDTMF(tones, duration, gap);\n  } // Private method to destroy a plugin handle\n\n\n  function destroyHandle(handleId, callbacks) {\n    callbacks = callbacks || {};\n    callbacks.success = typeof callbacks.success == \"function\" ? callbacks.success : jQuery.noop;\n    callbacks.error = typeof callbacks.error == \"function\" ? callbacks.error : jQuery.noop;\n    Janus.warn(callbacks);\n    var asyncRequest = true;\n    if (callbacks.asyncRequest !== undefined && callbacks.asyncRequest !== null) asyncRequest = callbacks.asyncRequest === true;\n    Janus.log(\"Destroying handle \" + handleId + \" (async=\" + asyncRequest + \")\");\n    cleanupWebrtc(handleId);\n\n    if (pluginHandles[handleId].detached) {\n      // Plugin was already detached by Janus, calling detach again will return a handle not found error, so just exit here\n      delete pluginHandles[handleId];\n      callbacks.success();\n      return;\n    }\n\n    if (!connected) {\n      Janus.warn(\"Is the gateway down? (connected=false)\");\n      callbacks.error(\"Is the gateway down? (connected=false)\");\n      return;\n    }\n\n    var request = {\n      \"janus\": \"detach\",\n      \"transaction\": Janus.randomString(12)\n    };\n    if (token !== null && token !== undefined) request[\"token\"] = token;\n    if (apisecret !== null && apisecret !== undefined) request[\"apisecret\"] = apisecret;\n\n    if (websockets) {\n      request[\"session_id\"] = sessionId;\n      request[\"handle_id\"] = handleId;\n      ws.send(JSON.stringify(request));\n      delete pluginHandles[handleId];\n      callbacks.success();\n      return;\n    }\n\n    $.ajax({\n      type: 'POST',\n      url: server + \"/\" + sessionId + \"/\" + handleId,\n      async: asyncRequest,\n      // Sometimes we need false here, or destroying in onbeforeunload won't work\n      xhrFields: {\n        withCredentials: withCredentials\n      },\n      cache: false,\n      contentType: \"application/json\",\n      data: JSON.stringify(request),\n      success: function (json) {\n        Janus.log(\"Destroyed handle:\");\n        Janus.debug(json);\n\n        if (json[\"janus\"] !== \"success\") {\n          Janus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason); // FIXME\n        }\n\n        delete pluginHandles[handleId];\n        callbacks.success();\n      },\n      error: function (XMLHttpRequest, textStatus, errorThrown) {\n        Janus.error(textStatus + \": \" + errorThrown); // FIXME\n        // We cleanup anyway\n\n        delete pluginHandles[handleId];\n        callbacks.success();\n      },\n      dataType: \"json\"\n    });\n  } // WebRTC stuff\n\n\n  function streamsDone(handleId, jsep, media, callbacks, stream) {\n    var pluginHandle = pluginHandles[handleId];\n\n    if (pluginHandle === null || pluginHandle === undefined || pluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n      Janus.warn(\"Invalid handle\");\n      callbacks.error(\"Invalid handle\");\n      return;\n    }\n\n    var config = pluginHandle.webrtcStuff;\n    Janus.debug(\"streamsDone:\", stream);\n    config.myStream = stream;\n    var pc_config = {\n      \"iceServers\": iceServers,\n      \"iceTransportPolicy\": iceTransportPolicy\n    }; //~ var pc_constraints = {'mandatory': {'MozDontOfferDataChannel':true}};\n\n    var pc_constraints = {\n      \"optional\": [{\n        \"DtlsSrtpKeyAgreement\": true\n      }]\n    };\n\n    if (ipv6Support === true) {\n      // FIXME This is only supported in Chrome right now\n      // For support in Firefox track this: https://bugzilla.mozilla.org/show_bug.cgi?id=797262\n      pc_constraints.optional.push({\n        \"googIPv6\": true\n      });\n    }\n\n    if (adapter.browserDetails.browser === \"edge\") {\n      // This is Edge, enable BUNDLE explicitly\n      pc_config.bundlePolicy = \"max-bundle\";\n    }\n\n    Janus.log(\"Creating PeerConnection\");\n    Janus.debug(pc_constraints);\n    config.pc = new RTCPeerConnection(pc_config, pc_constraints);\n    Janus.debug(config.pc);\n\n    if (config.pc.getStats) {\n      // FIXME\n      config.volume.value = 0;\n      config.bitrate.value = \"0 kbits/sec\";\n    }\n\n    Janus.log(\"Preparing local SDP and gathering candidates (trickle=\" + config.trickle + \")\");\n\n    config.pc.oniceconnectionstatechange = function (e) {\n      if (config.pc) pluginHandle.iceState(config.pc.iceConnectionState);\n    };\n\n    config.pc.onicecandidate = function (event) {\n      if (event.candidate == null || adapter.browserDetails.browser === 'edge' && event.candidate.candidate.indexOf('endOfCandidates') > 0) {\n        Janus.log(\"End of candidates.\");\n        config.iceDone = true;\n\n        if (config.trickle === true) {\n          // Notify end of candidates\n          sendTrickleCandidate(handleId, {\n            \"completed\": true\n          });\n        } else {\n          // No trickle, time to send the complete SDP (including all candidates)\n          sendSDP(handleId, callbacks);\n        }\n      } else {\n        // JSON.stringify doesn't work on some WebRTC objects anymore\n        // See https://code.google.com/p/chromium/issues/detail?id=467366\n        var candidate = {\n          \"candidate\": event.candidate.candidate,\n          \"sdpMid\": event.candidate.sdpMid,\n          \"sdpMLineIndex\": event.candidate.sdpMLineIndex\n        };\n\n        if (config.trickle === true) {\n          // Send candidate\n          sendTrickleCandidate(handleId, candidate);\n        }\n      }\n    };\n\n    if (stream !== null && stream !== undefined) {\n      Janus.log('Adding local stream');\n      config.pc.addStream(stream);\n      pluginHandle.onlocalstream(stream);\n    }\n\n    config.pc.onaddstream = function (remoteStream) {\n      Janus.log(\"Handling Remote Stream\");\n      Janus.debug(remoteStream);\n      config.remoteStream = remoteStream;\n      pluginHandle.onremotestream(remoteStream.stream);\n    }; // Any data channel to create?\n\n\n    if (isDataEnabled(media)) {\n      Janus.log(\"Creating data channel\");\n\n      var onDataChannelMessage = function (event) {\n        Janus.log('Received message on data channel: ' + event.data);\n        pluginHandle.ondata(event.data); // FIXME\n      };\n\n      var onDataChannelStateChange = function () {\n        var dcState = config.dataChannel !== null ? config.dataChannel.readyState : \"null\";\n        Janus.log('State change on data channel: ' + dcState);\n\n        if (dcState === 'open') {\n          pluginHandle.ondataopen(); // FIXME\n        }\n      };\n\n      var onDataChannelError = function (error) {\n        Janus.error('Got error on data channel:', error); // TODO\n      }; // Until we implement the proxying of open requests within the Janus core, we open a channel ourselves whatever the case\n\n\n      config.dataChannel = config.pc.createDataChannel(\"JanusDataChannel\", {\n        ordered: false\n      }); // FIXME Add options (ordered, maxRetransmits, etc.)\n\n      config.dataChannel.onmessage = onDataChannelMessage;\n      config.dataChannel.onopen = onDataChannelStateChange;\n      config.dataChannel.onclose = onDataChannelStateChange;\n      config.dataChannel.onerror = onDataChannelError;\n    } // Create offer/answer now\n\n\n    if (jsep === null || jsep === undefined) {\n      createOffer(handleId, media, callbacks);\n    } else {\n      if (adapter.browserDetails.browser === \"edge\") {\n        // This is Edge, add an a=end-of-candidates at the end\n        jsep.sdp += \"a=end-of-candidates\\r\\n\";\n      }\n\n      config.pc.setRemoteDescription(new RTCSessionDescription(jsep), function () {\n        Janus.log(\"Remote description accepted!\");\n        createAnswer(handleId, media, callbacks);\n      }, callbacks.error);\n    }\n  }\n\n  function prepareWebrtc(handleId, callbacks) {\n    callbacks = callbacks || {};\n    callbacks.success = typeof callbacks.success == \"function\" ? callbacks.success : jQuery.noop;\n    callbacks.error = typeof callbacks.error == \"function\" ? callbacks.error : webrtcError;\n    var jsep = callbacks.jsep;\n    var media = callbacks.media;\n    var pluginHandle = pluginHandles[handleId];\n\n    if (pluginHandle === null || pluginHandle === undefined || pluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n      Janus.warn(\"Invalid handle\");\n      callbacks.error(\"Invalid handle\");\n      return;\n    }\n\n    var config = pluginHandle.webrtcStuff; // Are we updating a session?\n\n    if (config.pc !== undefined && config.pc !== null) {\n      Janus.log(\"Updating existing media session\"); // Create offer/answer now\n\n      if (jsep === null || jsep === undefined) {\n        createOffer(handleId, media, callbacks);\n      } else {\n        if (adapter.browserDetails.browser === \"edge\") {\n          // This is Edge, add an a=end-of-candidates at the end\n          jsep.sdp += \"a=end-of-candidates\\r\\n\";\n        }\n\n        config.pc.setRemoteDescription(new RTCSessionDescription(jsep), function () {\n          Janus.log(\"Remote description accepted!\");\n          createAnswer(handleId, media, callbacks);\n        }, callbacks.error);\n      }\n\n      return;\n    } // Was a MediaStream object passed, or do we need to take care of that?\n\n\n    if (callbacks.stream !== null && callbacks.stream !== undefined) {\n      var stream = callbacks.stream;\n      Janus.log(\"MediaStream provided by the application\");\n      Janus.debug(stream); // Skip the getUserMedia part\n\n      config.streamExternal = true;\n      streamsDone(handleId, jsep, media, callbacks, stream);\n      return;\n    }\n\n    config.trickle = isTrickleEnabled(callbacks.trickle);\n\n    if (isAudioSendEnabled(media) || isVideoSendEnabled(media)) {\n      var constraints = {\n        mandatory: {},\n        optional: []\n      };\n      pluginHandle.consentDialog(true);\n      var audioSupport = isAudioSendEnabled(media);\n\n      if (audioSupport === true && media != undefined && media != null) {\n        if (typeof media.audio === 'object') {\n          audioSupport = media.audio;\n        }\n      }\n\n      var videoSupport = isVideoSendEnabled(media);\n\n      if (videoSupport === true && media != undefined && media != null) {\n        if (media.video && media.video != 'screen' && media.video != 'window') {\n          var width = 0;\n          var height = 0,\n              maxHeight = 0;\n\n          if (media.video === 'lowres') {\n            // Small resolution, 4:3\n            height = 240;\n            maxHeight = 240;\n            width = 320;\n          } else if (media.video === 'lowres-16:9') {\n            // Small resolution, 16:9\n            height = 180;\n            maxHeight = 180;\n            width = 320;\n          } else if (media.video === 'hires' || media.video === 'hires-16:9') {\n            // High resolution is only 16:9\n            height = 720;\n            maxHeight = 720;\n            width = 1280;\n\n            if (navigator.mozGetUserMedia) {\n              var firefoxVer = parseInt(window.navigator.userAgent.match(/Firefox\\/(.*)/)[1], 10);\n\n              if (firefoxVer < 38) {\n                // Unless this is and old Firefox, which doesn't support it\n                Janus.warn(media.video + \" unsupported, falling back to stdres (old Firefox)\");\n                height = 480;\n                maxHeight = 480;\n                width = 640;\n              }\n            }\n          } else if (media.video === 'stdres') {\n            // Normal resolution, 4:3\n            height = 480;\n            maxHeight = 480;\n            width = 640;\n          } else if (media.video === 'stdres-16:9') {\n            // Normal resolution, 16:9\n            height = 360;\n            maxHeight = 360;\n            width = 640;\n          } else {\n            Janus.log(\"Default video setting (\" + media.video + \") is stdres 4:3\");\n            height = 480;\n            maxHeight = 480;\n            width = 640;\n          }\n\n          Janus.log(\"Adding media constraint \" + media.video);\n\n          if (navigator.mozGetUserMedia) {\n            var firefoxVer = parseInt(window.navigator.userAgent.match(/Firefox\\/(.*)/)[1], 10);\n\n            if (firefoxVer < 38) {\n              videoSupport = {\n                'require': ['height', 'width'],\n                'height': {\n                  'max': maxHeight,\n                  'min': height\n                },\n                'width': {\n                  'max': width,\n                  'min': width\n                }\n              };\n            } else {\n              // http://stackoverflow.com/questions/28282385/webrtc-firefox-constraints/28911694#28911694\n              // https://github.com/meetecho/janus-gateway/pull/246\n              videoSupport = {\n                'height': {\n                  'ideal': height\n                },\n                'width': {\n                  'ideal': width\n                }\n              };\n            }\n          } else {\n            videoSupport = {\n              'mandatory': {\n                'maxHeight': maxHeight,\n                'minHeight': height,\n                'maxWidth': width,\n                'minWidth': width\n              },\n              'optional': []\n            };\n          }\n\n          if (typeof media.video === 'object') {\n            videoSupport = media.video;\n          }\n\n          Janus.debug(videoSupport);\n        } else if (media.video === 'screen' || media.video === 'window') {\n          if (!media.screenshareFrameRate) {\n            media.screenshareFrameRate = 3;\n          } // Not a webcam, but screen capture\n\n\n          if (window.location.protocol !== 'https:') {\n            // Screen sharing mandates HTTPS\n            Janus.warn(\"Screen sharing only works on HTTPS, try the https:// version of this page\");\n            pluginHandle.consentDialog(false);\n            callbacks.error(\"Screen sharing only works on HTTPS, try the https:// version of this page\");\n            return;\n          } // We're going to try and use the extension for Chrome 34+, the old approach\n          // for older versions of Chrome, or the experimental support in Firefox 33+\n\n\n          var cache = {};\n\n          function callbackUserMedia(error, stream) {\n            pluginHandle.consentDialog(false);\n\n            if (error) {\n              callbacks.error({\n                code: error.code,\n                name: error.name,\n                message: error.message\n              });\n            } else {\n              streamsDone(handleId, jsep, media, callbacks, stream);\n            }\n          }\n\n          ;\n\n          function getScreenMedia(constraints, gsmCallback, useAudio) {\n            Janus.log(\"Adding media constraint (screen capture)\");\n            Janus.debug(constraints);\n            navigator.mediaDevices.getUserMedia(constraints).then(function (stream) {\n              if (useAudio) {\n                navigator.mediaDevices.getUserMedia({\n                  audio: true,\n                  video: false\n                }).then(function (audioStream) {\n                  stream.addTrack(audioStream.getAudioTracks()[0]);\n                  gsmCallback(null, stream);\n                });\n              } else {\n                gsmCallback(null, stream);\n              }\n            }).catch(function (error) {\n              pluginHandle.consentDialog(false);\n              gsmCallback(error);\n            });\n          }\n\n          ;\n\n          if (adapter.browserDetails.browser === 'chrome') {\n            var chromever = adapter.browserDetails.version;\n            var maxver = 33;\n            if (window.navigator.userAgent.match('Linux')) maxver = 35; // \"known\" crash in chrome 34 and 35 on linux\n\n            if (chromever >= 26 && chromever <= maxver) {\n              // Chrome 26->33 requires some awkward chrome://flags manipulation\n              constraints = {\n                video: {\n                  mandatory: {\n                    googLeakyBucket: true,\n                    maxWidth: window.screen.width,\n                    maxHeight: window.screen.height,\n                    minFrameRate: media.screenshareFrameRate,\n                    maxFrameRate: media.screenshareFrameRate,\n                    chromeMediaSource: 'screen'\n                  }\n                },\n                audio: isAudioSendEnabled(media)\n              };\n              getScreenMedia(constraints, callbackUserMedia);\n            } else {\n              // Chrome 34+ requires an extension\n              var pending = window.setTimeout(function () {\n                error = new Error('NavigatorUserMediaError');\n                error.name = 'The required Chrome extension is not installed: click <a href=\"#\">here</a> to install it. (NOTE: this will need you to refresh the page)';\n                pluginHandle.consentDialog(false);\n                return callbacks.error(error);\n              }, 1000);\n              cache[pending] = [callbackUserMedia, null];\n              window.postMessage({\n                type: 'janusGetScreen',\n                id: pending\n              }, '*');\n            }\n          } else if (window.navigator.userAgent.match('Firefox')) {\n            var ffver = parseInt(window.navigator.userAgent.match(/Firefox\\/(.*)/)[1], 10);\n\n            if (ffver >= 33) {\n              // Firefox 33+ has experimental support for screen sharing\n              constraints = {\n                video: {\n                  mozMediaSource: media.video,\n                  mediaSource: media.video\n                },\n                audio: isAudioSendEnabled(media)\n              };\n              getScreenMedia(constraints, function (err, stream) {\n                callbackUserMedia(err, stream); // Workaround for https://bugzilla.mozilla.org/show_bug.cgi?id=1045810\n\n                if (!err) {\n                  var lastTime = stream.currentTime;\n                  var polly = window.setInterval(function () {\n                    if (!stream) window.clearInterval(polly);\n\n                    if (stream.currentTime == lastTime) {\n                      window.clearInterval(polly);\n\n                      if (stream.onended) {\n                        stream.onended();\n                      }\n                    }\n\n                    lastTime = stream.currentTime;\n                  }, 500);\n                }\n              });\n            } else {\n              var error = new Error('NavigatorUserMediaError');\n              error.name = 'Your version of Firefox does not support screen sharing, please install Firefox 33 (or more recent versions)';\n              pluginHandle.consentDialog(false);\n              callbacks.error(error);\n              return;\n            }\n          } // Wait for events from the Chrome Extension\n\n\n          window.addEventListener('message', function (event) {\n            if (event.origin != window.location.origin) return;\n\n            if (event.data.type == 'janusGotScreen' && cache[event.data.id]) {\n              var data = cache[event.data.id];\n              var callback = data[0];\n              delete cache[event.data.id];\n\n              if (event.data.sourceId === '') {\n                // user canceled\n                var error = new Error('NavigatorUserMediaError');\n                error.name = 'You cancelled the request for permission, giving up...';\n                pluginHandle.consentDialog(false);\n                callbacks.error(error);\n              } else {\n                constraints = {\n                  audio: false,\n                  video: {\n                    mandatory: {\n                      chromeMediaSource: 'desktop',\n                      maxWidth: window.screen.width,\n                      maxHeight: window.screen.height,\n                      minFrameRate: media.screenshareFrameRate,\n                      maxFrameRate: media.screenshareFrameRate\n                    },\n                    optional: [{\n                      googLeakyBucket: true\n                    }, {\n                      googTemporalLayeredScreencast: true\n                    }]\n                  }\n                };\n                constraints.video.mandatory.chromeMediaSourceId = event.data.sourceId;\n                getScreenMedia(constraints, callback, isAudioSendEnabled(media));\n              }\n            } else if (event.data.type == 'janusGetScreenPending') {\n              window.clearTimeout(event.data.id);\n            }\n          });\n          return;\n        }\n      } // If we got here, we're not screensharing\n\n\n      if (media === null || media === undefined || media.video !== 'screen') {\n        // Check whether all media sources are actually available or not\n        navigator.mediaDevices.enumerateDevices().then(function (devices) {\n          var audioExist = devices.some(function (device) {\n            return device.kind === 'audioinput';\n          }),\n              videoExist = devices.some(function (device) {\n            return device.kind === 'videoinput';\n          }); // Check whether a missing device is really a problem\n\n          var audioSend = isAudioSendEnabled(media);\n          var videoSend = isVideoSendEnabled(media);\n          var needAudioDevice = isAudioSendRequired(media);\n          var needVideoDevice = isVideoSendRequired(media);\n\n          if (audioSend || videoSend || needAudioDevice || needVideoDevice) {\n            // We need to send either audio or video\n            var haveAudioDevice = audioSend ? audioExist : false;\n            var haveVideoDevice = videoSend ? videoExist : false;\n\n            if (!haveAudioDevice && !haveVideoDevice) {\n              // FIXME Should we really give up, or just assume recvonly for both?\n              pluginHandle.consentDialog(false);\n              callbacks.error('No capture device found');\n              return false;\n            } else if (!haveAudioDevice && needAudioDevice) {\n              pluginHandle.consentDialog(false);\n              callbacks.error('Audio capture is required, but no capture device found');\n              return false;\n            } else if (!haveVideoDevice && needVideoDevice) {\n              pluginHandle.consentDialog(false);\n              callbacks.error('Video capture is required, but no capture device found');\n              return false;\n            }\n          }\n\n          navigator.mediaDevices.getUserMedia({\n            audio: audioExist ? audioSupport : false,\n            video: videoExist ? videoSupport : false\n          }).then(function (stream) {\n            pluginHandle.consentDialog(false);\n            streamsDone(handleId, jsep, media, callbacks, stream);\n          }).catch(function (error) {\n            pluginHandle.consentDialog(false);\n            callbacks.error({\n              code: error.code,\n              name: error.name,\n              message: error.message\n            });\n          });\n        }).catch(function (error) {\n          pluginHandle.consentDialog(false);\n          callbacks.error('enumerateDevices error', error);\n        });\n      }\n    } else {\n      // No need to do a getUserMedia, create offer/answer right away\n      streamsDone(handleId, jsep, media, callbacks);\n    }\n  }\n\n  function prepareWebrtcPeer(handleId, callbacks) {\n    callbacks = callbacks || {};\n    callbacks.success = typeof callbacks.success == \"function\" ? callbacks.success : jQuery.noop;\n    callbacks.error = typeof callbacks.error == \"function\" ? callbacks.error : webrtcError;\n    var jsep = callbacks.jsep;\n    var pluginHandle = pluginHandles[handleId];\n\n    if (pluginHandle === null || pluginHandle === undefined || pluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n      Janus.warn(\"Invalid handle\");\n      callbacks.error(\"Invalid handle\");\n      return;\n    }\n\n    var config = pluginHandle.webrtcStuff;\n\n    if (jsep !== undefined && jsep !== null) {\n      if (config.pc === null) {\n        Janus.warn(\"Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep\");\n        callbacks.error(\"No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep\");\n        return;\n      }\n\n      if (adapter.browserDetails.browser === \"edge\") {\n        // This is Edge, add an a=end-of-candidates at the end\n        jsep.sdp += \"a=end-of-candidates\\r\\n\";\n      }\n\n      config.pc.setRemoteDescription(new RTCSessionDescription(jsep), function () {\n        Janus.log(\"Remote description accepted!\");\n        callbacks.success();\n      }, callbacks.error);\n    } else {\n      callbacks.error(\"Invalid JSEP\");\n    }\n  }\n\n  function createOffer(handleId, media, callbacks) {\n    callbacks = callbacks || {};\n    callbacks.success = typeof callbacks.success == \"function\" ? callbacks.success : jQuery.noop;\n    callbacks.error = typeof callbacks.error == \"function\" ? callbacks.error : jQuery.noop;\n    var pluginHandle = pluginHandles[handleId];\n\n    if (pluginHandle === null || pluginHandle === undefined || pluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n      Janus.warn(\"Invalid handle\");\n      callbacks.error(\"Invalid handle\");\n      return;\n    }\n\n    var config = pluginHandle.webrtcStuff;\n    Janus.log(\"Creating offer (iceDone=\" + config.iceDone + \")\"); // https://code.google.com/p/webrtc/issues/detail?id=3508\n\n    var mediaConstraints = null;\n\n    if (adapter.browserDetails.browser == \"firefox\" || adapter.browserDetails.browser == \"edge\") {\n      mediaConstraints = {\n        'offerToReceiveAudio': isAudioRecvEnabled(media),\n        'offerToReceiveVideo': isVideoRecvEnabled(media)\n      };\n    } else {\n      mediaConstraints = {\n        'mandatory': {\n          'OfferToReceiveAudio': isAudioRecvEnabled(media),\n          'OfferToReceiveVideo': isVideoRecvEnabled(media)\n        }\n      };\n    }\n\n    Janus.debug(mediaConstraints);\n    config.pc.createOffer(function (offer) {\n      Janus.debug(offer);\n\n      if (config.mySdp === null || config.mySdp === undefined) {\n        Janus.log(\"Setting local description\");\n        config.mySdp = offer.sdp;\n        config.pc.setLocalDescription(offer);\n      }\n\n      if (!config.iceDone && !config.trickle) {\n        // Don't do anything until we have all candidates\n        Janus.log(\"Waiting for all candidates...\");\n        return;\n      }\n\n      if (config.sdpSent) {\n        Janus.log(\"Offer already sent, not sending it again\");\n        return;\n      }\n\n      Janus.log(\"Offer ready\");\n      Janus.debug(callbacks);\n      config.sdpSent = true; // JSON.stringify doesn't work on some WebRTC objects anymore\n      // See https://code.google.com/p/chromium/issues/detail?id=467366\n\n      var jsep = {\n        \"type\": offer.type,\n        \"sdp\": offer.sdp\n      };\n      callbacks.success(jsep);\n    }, callbacks.error, mediaConstraints);\n  }\n\n  function createAnswer(handleId, media, callbacks) {\n    callbacks = callbacks || {};\n    callbacks.success = typeof callbacks.success == \"function\" ? callbacks.success : jQuery.noop;\n    callbacks.error = typeof callbacks.error == \"function\" ? callbacks.error : jQuery.noop;\n    var pluginHandle = pluginHandles[handleId];\n\n    if (pluginHandle === null || pluginHandle === undefined || pluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n      Janus.warn(\"Invalid handle\");\n      callbacks.error(\"Invalid handle\");\n      return;\n    }\n\n    var config = pluginHandle.webrtcStuff;\n    Janus.log(\"Creating answer (iceDone=\" + config.iceDone + \")\");\n    var mediaConstraints = null;\n\n    if (adapter.browserDetails.browser == \"firefox\" || adapter.browserDetails.browser == \"edge\") {\n      mediaConstraints = {\n        'offerToReceiveAudio': isAudioRecvEnabled(media),\n        'offerToReceiveVideo': isVideoRecvEnabled(media)\n      };\n    } else {\n      mediaConstraints = {\n        'mandatory': {\n          'OfferToReceiveAudio': isAudioRecvEnabled(media),\n          'OfferToReceiveVideo': isVideoRecvEnabled(media)\n        }\n      };\n    }\n\n    Janus.debug(mediaConstraints);\n    config.pc.createAnswer(function (answer) {\n      Janus.debug(answer);\n\n      if (config.mySdp === null || config.mySdp === undefined) {\n        Janus.log(\"Setting local description\");\n        config.mySdp = answer.sdp;\n        config.pc.setLocalDescription(answer);\n      }\n\n      if (!config.iceDone && !config.trickle) {\n        // Don't do anything until we have all candidates\n        Janus.log(\"Waiting for all candidates...\");\n        return;\n      }\n\n      if (config.sdpSent) {\n        // FIXME badly\n        Janus.log(\"Answer already sent, not sending it again\");\n        return;\n      }\n\n      config.sdpSent = true; // JSON.stringify doesn't work on some WebRTC objects anymore\n      // See https://code.google.com/p/chromium/issues/detail?id=467366\n\n      var jsep = {\n        \"type\": answer.type,\n        \"sdp\": answer.sdp\n      };\n      callbacks.success(jsep);\n    }, callbacks.error, mediaConstraints);\n  }\n\n  function sendSDP(handleId, callbacks) {\n    callbacks = callbacks || {};\n    callbacks.success = typeof callbacks.success == \"function\" ? callbacks.success : jQuery.noop;\n    callbacks.error = typeof callbacks.error == \"function\" ? callbacks.error : jQuery.noop;\n    var pluginHandle = pluginHandles[handleId];\n\n    if (pluginHandle === null || pluginHandle === undefined || pluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n      Janus.warn(\"Invalid handle, not sending anything\");\n      return;\n    }\n\n    var config = pluginHandle.webrtcStuff;\n    Janus.log(\"Sending offer/answer SDP...\");\n\n    if (config.mySdp === null || config.mySdp === undefined) {\n      Janus.warn(\"Local SDP instance is invalid, not sending anything...\");\n      return;\n    }\n\n    config.mySdp = {\n      \"type\": config.pc.localDescription.type,\n      \"sdp\": config.pc.localDescription.sdp\n    };\n\n    if (config.sdpSent) {\n      Janus.log(\"Offer/Answer SDP already sent, not sending it again\");\n      return;\n    }\n\n    if (config.trickle === false) config.mySdp[\"trickle\"] = false;\n    Janus.debug(callbacks);\n    config.sdpSent = true;\n    callbacks.success(config.mySdp);\n  }\n\n  function getVolume(handleId) {\n    var pluginHandle = pluginHandles[handleId];\n\n    if (pluginHandle === null || pluginHandle === undefined || pluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n      Janus.warn(\"Invalid handle\");\n      return 0;\n    }\n\n    var config = pluginHandle.webrtcStuff; // Start getting the volume, if getStats is supported\n\n    if (config.pc.getStats && adapter.browserDetails.browser == \"chrome\") {\n      // FIXME\n      if (config.remoteStream === null || config.remoteStream === undefined) {\n        Janus.warn(\"Remote stream unavailable\");\n        return 0;\n      } // http://webrtc.googlecode.com/svn/trunk/samples/js/demos/html/constraints-and-stats.html\n\n\n      if (config.volume.timer === null || config.volume.timer === undefined) {\n        Janus.log(\"Starting volume monitor\");\n        config.volume.timer = setInterval(function () {\n          config.pc.getStats(function (stats) {\n            var results = stats.result();\n\n            for (var i = 0; i < results.length; i++) {\n              var res = results[i];\n\n              if (res.type == 'ssrc' && res.stat('audioOutputLevel')) {\n                config.volume.value = res.stat('audioOutputLevel');\n              }\n            }\n          });\n        }, 200);\n        return 0; // We don't have a volume to return yet\n      }\n\n      return config.volume.value;\n    } else {\n      Janus.log(\"Getting the remote volume unsupported by browser\");\n      return 0;\n    }\n  }\n\n  function isMuted(handleId, video) {\n    var pluginHandle = pluginHandles[handleId];\n\n    if (pluginHandle === null || pluginHandle === undefined || pluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n      Janus.warn(\"Invalid handle\");\n      return true;\n    }\n\n    var config = pluginHandle.webrtcStuff;\n\n    if (config.pc === null || config.pc === undefined) {\n      Janus.warn(\"Invalid PeerConnection\");\n      return true;\n    }\n\n    if (config.myStream === undefined || config.myStream === null) {\n      Janus.warn(\"Invalid local MediaStream\");\n      return true;\n    }\n\n    if (video) {\n      // Check video track\n      if (config.myStream.getVideoTracks() === null || config.myStream.getVideoTracks() === undefined || config.myStream.getVideoTracks().length === 0) {\n        Janus.warn(\"No video track\");\n        return true;\n      }\n\n      return !config.myStream.getVideoTracks()[0].enabled;\n    } else {\n      // Check audio track\n      if (config.myStream.getAudioTracks() === null || config.myStream.getAudioTracks() === undefined || config.myStream.getAudioTracks().length === 0) {\n        Janus.warn(\"No audio track\");\n        return true;\n      }\n\n      return !config.myStream.getAudioTracks()[0].enabled;\n    }\n  }\n\n  function mute(handleId, video, mute) {\n    var pluginHandle = pluginHandles[handleId];\n\n    if (pluginHandle === null || pluginHandle === undefined || pluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n      Janus.warn(\"Invalid handle\");\n      return false;\n    }\n\n    var config = pluginHandle.webrtcStuff;\n\n    if (config.pc === null || config.pc === undefined) {\n      Janus.warn(\"Invalid PeerConnection\");\n      return false;\n    }\n\n    if (config.myStream === undefined || config.myStream === null) {\n      Janus.warn(\"Invalid local MediaStream\");\n      return false;\n    }\n\n    if (video) {\n      // Mute/unmute video track\n      if (config.myStream.getVideoTracks() === null || config.myStream.getVideoTracks() === undefined || config.myStream.getVideoTracks().length === 0) {\n        Janus.warn(\"No video track\");\n        return false;\n      }\n\n      config.myStream.getVideoTracks()[0].enabled = mute ? false : true;\n      return true;\n    } else {\n      // Mute/unmute audio track\n      if (config.myStream.getAudioTracks() === null || config.myStream.getAudioTracks() === undefined || config.myStream.getAudioTracks().length === 0) {\n        Janus.warn(\"No audio track\");\n        return false;\n      }\n\n      config.myStream.getAudioTracks()[0].enabled = mute ? false : true;\n      return true;\n    }\n  }\n\n  function getBitrate(handleId) {\n    var pluginHandle = pluginHandles[handleId];\n\n    if (pluginHandle === null || pluginHandle === undefined || pluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n      Janus.warn(\"Invalid handle\");\n      return \"Invalid handle\";\n    }\n\n    var config = pluginHandle.webrtcStuff;\n    if (config.pc === null || config.pc === undefined) return \"Invalid PeerConnection\"; // Start getting the bitrate, if getStats is supported\n\n    if (config.pc.getStats && adapter.browserDetails.browser == \"chrome\") {\n      // Do it the Chrome way\n      if (config.remoteStream === null || config.remoteStream === undefined) {\n        Janus.warn(\"Remote stream unavailable\");\n        return \"Remote stream unavailable\";\n      } // http://webrtc.googlecode.com/svn/trunk/samples/js/demos/html/constraints-and-stats.html\n\n\n      if (config.bitrate.timer === null || config.bitrate.timer === undefined) {\n        Janus.log(\"Starting bitrate timer (Chrome)\");\n        config.bitrate.timer = setInterval(function () {\n          config.pc.getStats(function (stats) {\n            var results = stats.result();\n\n            for (var i = 0; i < results.length; i++) {\n              var res = results[i];\n\n              if (res.type == 'ssrc' && res.stat('googFrameHeightReceived')) {\n                config.bitrate.bsnow = res.stat('bytesReceived');\n                config.bitrate.tsnow = res.timestamp;\n\n                if (config.bitrate.bsbefore === null || config.bitrate.tsbefore === null) {\n                  // Skip this round\n                  config.bitrate.bsbefore = config.bitrate.bsnow;\n                  config.bitrate.tsbefore = config.bitrate.tsnow;\n                } else {\n                  // Calculate bitrate\n                  var bitRate = Math.round((config.bitrate.bsnow - config.bitrate.bsbefore) * 8 / (config.bitrate.tsnow - config.bitrate.tsbefore));\n                  config.bitrate.value = bitRate + ' kbits/sec'; //~ Janus.log(\"Estimated bitrate is \" + config.bitrate.value);\n\n                  config.bitrate.bsbefore = config.bitrate.bsnow;\n                  config.bitrate.tsbefore = config.bitrate.tsnow;\n                }\n              }\n            }\n          });\n        }, 1000);\n        return \"0 kbits/sec\"; // We don't have a bitrate value yet\n      }\n\n      return config.bitrate.value;\n    } else if (config.pc.getStats && adapter.browserDetails.browser == \"firefox\") {\n      // Do it the Firefox way\n      if (config.remoteStream === null || config.remoteStream === undefined || config.remoteStream.streams[0] === null || config.remoteStream.streams[0] === undefined) {\n        Janus.warn(\"Remote stream unavailable\");\n        return \"Remote stream unavailable\";\n      }\n\n      var videoTracks = config.remoteStream.streams[0].getVideoTracks();\n\n      if (videoTracks === null || videoTracks === undefined || videoTracks.length < 1) {\n        Janus.warn(\"No video track\");\n        return \"No video track\";\n      } // https://github.com/muaz-khan/getStats/blob/master/getStats.js\n\n\n      if (config.bitrate.timer === null || config.bitrate.timer === undefined) {\n        Janus.log(\"Starting bitrate timer (Firefox)\");\n        config.bitrate.timer = setInterval(function () {\n          // We need a helper callback\n          var cb = function (res) {\n            if (res === null || res === undefined || res.inbound_rtp_video_1 == null || res.inbound_rtp_video_1 == null) {\n              config.bitrate.value = \"Missing inbound_rtp_video_1\";\n              return;\n            }\n\n            config.bitrate.bsnow = res.inbound_rtp_video_1.bytesReceived;\n            config.bitrate.tsnow = res.inbound_rtp_video_1.timestamp;\n\n            if (config.bitrate.bsbefore === null || config.bitrate.tsbefore === null) {\n              // Skip this round\n              config.bitrate.bsbefore = config.bitrate.bsnow;\n              config.bitrate.tsbefore = config.bitrate.tsnow;\n            } else {\n              // Calculate bitrate\n              var bitRate = Math.round((config.bitrate.bsnow - config.bitrate.bsbefore) * 8 / (config.bitrate.tsnow - config.bitrate.tsbefore));\n              config.bitrate.value = bitRate + ' kbits/sec';\n              config.bitrate.bsbefore = config.bitrate.bsnow;\n              config.bitrate.tsbefore = config.bitrate.tsnow;\n            }\n          }; // Actually get the stats\n\n\n          config.pc.getStats(videoTracks[0], function (stats) {\n            cb(stats);\n          }, cb);\n        }, 1000);\n        return \"0 kbits/sec\"; // We don't have a bitrate value yet\n      }\n\n      return config.bitrate.value;\n    } else {\n      Janus.warn(\"Getting the video bitrate unsupported by browser\");\n      return \"Feature unsupported by browser\";\n    }\n  }\n\n  function webrtcError(error) {\n    Janus.error(\"WebRTC error:\", error);\n  }\n\n  function cleanupWebrtc(handleId, hangupRequest) {\n    Janus.log(\"Cleaning WebRTC stuff\");\n    var pluginHandle = pluginHandles[handleId];\n\n    if (pluginHandle === null || pluginHandle === undefined) {\n      // Nothing to clean\n      return;\n    }\n\n    var config = pluginHandle.webrtcStuff;\n\n    if (config !== null && config !== undefined) {\n      if (hangupRequest === true) {\n        // Send a hangup request (we don't really care about the response)\n        var request = {\n          \"janus\": \"hangup\",\n          \"transaction\": Janus.randomString(12)\n        };\n        if (token !== null && token !== undefined) request[\"token\"] = token;\n        if (apisecret !== null && apisecret !== undefined) request[\"apisecret\"] = apisecret;\n        Janus.debug(\"Sending hangup request (handle=\" + handleId + \"):\");\n        Janus.debug(request);\n\n        if (websockets) {\n          request[\"session_id\"] = sessionId;\n          request[\"handle_id\"] = handleId;\n          ws.send(JSON.stringify(request));\n        } else {\n          $.ajax({\n            type: 'POST',\n            url: server + \"/\" + sessionId + \"/\" + handleId,\n            xhrFields: {\n              withCredentials: withCredentials\n            },\n            cache: false,\n            contentType: \"application/json\",\n            data: JSON.stringify(request),\n            dataType: \"json\"\n          });\n        }\n      } // Cleanup stack\n\n\n      config.remoteStream = null;\n      if (config.volume.timer) clearInterval(config.volume.timer);\n      config.volume.value = null;\n      if (config.bitrate.timer) clearInterval(config.bitrate.timer);\n      config.bitrate.timer = null;\n      config.bitrate.bsnow = null;\n      config.bitrate.bsbefore = null;\n      config.bitrate.tsnow = null;\n      config.bitrate.tsbefore = null;\n      config.bitrate.value = null;\n\n      try {\n        // Try a MediaStream.stop() first\n        if (!config.streamExternal && config.myStream !== null && config.myStream !== undefined) {\n          Janus.log(\"Stopping local stream\");\n          config.myStream.stop();\n        }\n      } catch (e) {// Do nothing if this fails\n      }\n\n      try {\n        // Try a MediaStreamTrack.stop() for each track as well\n        if (!config.streamExternal && config.myStream !== null && config.myStream !== undefined) {\n          Janus.log(\"Stopping local stream tracks\");\n          var tracks = config.myStream.getTracks();\n\n          for (var i in tracks) {\n            var mst = tracks[i];\n            Janus.log(mst);\n            if (mst !== null && mst !== undefined) mst.stop();\n          }\n        }\n      } catch (e) {// Do nothing if this fails\n      }\n\n      config.streamExternal = false;\n      config.myStream = null; // Close PeerConnection\n\n      try {\n        config.pc.close();\n      } catch (e) {// Do nothing\n      }\n\n      config.pc = null;\n      config.mySdp = null;\n      config.iceDone = false;\n      config.sdpSent = false;\n      config.dataChannel = null;\n      config.dtmfSender = null;\n    }\n\n    pluginHandle.oncleanup();\n  } // Helper methods to parse a media object\n\n\n  function isAudioSendEnabled(media) {\n    Janus.debug(\"isAudioSendEnabled:\", media);\n    if (media === undefined || media === null) return true; // Default\n\n    if (media.audio === false) return false; // Generic audio has precedence\n\n    if (media.audioSend === undefined || media.audioSend === null) return true; // Default\n\n    return media.audioSend === true;\n  }\n\n  function isAudioSendRequired(media) {\n    Janus.debug(\"isAudioSendRequired:\", media);\n    if (media === undefined || media === null) return false; // Default\n\n    if (media.audio === false || media.audioSend === false) return false; // If we're not asking to capture audio, it's not required\n\n    if (media.failIfNoAudio === undefined || media.failIfNoAudio === null) return false; // Default\n\n    return media.failIfNoAudio === true;\n  }\n\n  function isAudioRecvEnabled(media) {\n    Janus.debug(\"isAudioRecvEnabled:\", media);\n    if (media === undefined || media === null) return true; // Default\n\n    if (media.audio === false) return false; // Generic audio has precedence\n\n    if (media.audioRecv === undefined || media.audioRecv === null) return true; // Default\n\n    return media.audioRecv === true;\n  }\n\n  function isVideoSendEnabled(media) {\n    Janus.debug(\"isVideoSendEnabled:\", media);\n    if (media === undefined || media === null) return true; // Default\n\n    if (media.video === false) return false; // Generic video has precedence\n\n    if (media.videoSend === undefined || media.videoSend === null) return true; // Default\n\n    return media.videoSend === true;\n  }\n\n  function isVideoSendRequired(media) {\n    Janus.debug(\"isVideoSendRequired:\", media);\n    if (media === undefined || media === null) return false; // Default\n\n    if (media.video === false || media.videoSend === false) return false; // If we're not asking to capture video, it's not required\n\n    if (media.failIfNoVideo === undefined || media.failIfNoVideo === null) return false; // Default\n\n    return media.failIfNoVideo === true;\n  }\n\n  function isVideoRecvEnabled(media) {\n    Janus.debug(\"isVideoRecvEnabled:\", media);\n    if (media === undefined || media === null) return true; // Default\n\n    if (media.video === false) return false; // Generic video has precedence\n\n    if (media.videoRecv === undefined || media.videoRecv === null) return true; // Default\n\n    return media.videoRecv === true;\n  }\n\n  function isDataEnabled(media) {\n    Janus.debug(\"isDataEnabled:\", media);\n\n    if (adapter.browserDetails.browser == \"edge\") {\n      Janus.warn(\"Edge doesn't support data channels yet\");\n      return false;\n    }\n\n    if (media === undefined || media === null) return false; // Default\n\n    return media.data === true;\n  }\n\n  function isTrickleEnabled(trickle) {\n    Janus.debug(\"isTrickleEnabled:\", trickle);\n    if (trickle === undefined || trickle === null) return true; // Default is true\n\n    return trickle === true;\n  }\n}\n\n;","map":{"version":3,"sources":["/home/abu/Documents/dev/experiments/exp1/client/node_modules/janus-gateway/html/janus.js"],"names":["Janus","sessions","extensionId","isExtensionEnabled","window","navigator","userAgent","match","chromever","parseInt","maxver","$","length","noop","init","options","callback","initDone","console","log","trace","debug","vdebug","warn","error","bind","Array","isArray","i","d","listDevices","config","audio","video","mediaDevices","getUserMedia","then","stream","enumerateDevices","devices","stop","e","tracks","getTracks","mst","undefined","catch","err","attachMediaStream","element","adapter","browserDetails","browser","version","srcObject","src","URL","createObjectURL","reattachMediaStream","to","from","oldOBF","onbeforeunload","s","destroyOnUnload","destroy","asyncRequest","isWebrtcSupported","RTCPeerConnection","randomString","len","charSet","randomPoz","Math","floor","random","substring","gatewayCallbacks","success","jQuery","destroyed","server","websockets","ws","wsHandlers","wsKeepaliveTimeoutId","servers","serversIndex","indexOf","iceServers","urls","iceTransportPolicy","ipv6Support","ipv6","withCredentials","maxev","max_poll_events","token","apisecret","connected","sessionId","pluginHandles","that","retries","transactions","createSession","getServer","isConnected","getSessionId","callbacks","destroySession","attach","createHandle","eventHandler","longpoll","Date","getTime","ajax","type","url","xhrFields","cache","timeout","handleEvent","XMLHttpRequest","textStatus","errorThrown","dataType","json","skipTimeout","setTimeout","transaction","reportSuccess","sender","pluginHandle","webrtcState","hangup","detached","ondetached","detach","mediaState","slowLink","code","reason","plugindata","data","jsep","onmessage","keepAlive","request","send","JSON","stringify","WebSocket","event","parse","eventName","addEventListener","contentType","unbindWebSocket","removeEventListener","onUnbindMessage","onUnbindError","clearTimeout","session_id","async","consentDialog","iceState","onlocalstream","onremotestream","ondata","ondataopen","oncleanup","plugin","opaqueId","handleId","session","id","webrtcStuff","started","myStream","streamExternal","remoteStream","mySdp","pc","dataChannel","dtmfSender","trickle","iceDone","sdpSent","volume","value","timer","bitrate","bsnow","bsbefore","tsnow","tsbefore","getId","getPlugin","getVolume","isAudioMuted","isMuted","muteAudio","mute","unmuteAudio","isVideoMuted","muteVideo","unmuteVideo","getBitrate","sendMessage","sendData","dtmf","sendDtmf","createOffer","prepareWebrtc","createAnswer","handleRemoteJsep","prepareWebrtcPeer","sendRequest","cleanupWebrtc","destroyHandle","message","sendTrickleCandidate","candidate","text","getAudioTracks","local_audio_track","createDTMFSender","ontonechange","tone","tones","duration","gap","insertDTMF","streamsDone","media","pc_config","pc_constraints","optional","push","bundlePolicy","getStats","oniceconnectionstatechange","iceConnectionState","onicecandidate","sendSDP","sdpMid","sdpMLineIndex","addStream","onaddstream","isDataEnabled","onDataChannelMessage","onDataChannelStateChange","dcState","readyState","onDataChannelError","createDataChannel","ordered","onopen","onclose","onerror","sdp","setRemoteDescription","RTCSessionDescription","webrtcError","isTrickleEnabled","isAudioSendEnabled","isVideoSendEnabled","constraints","mandatory","audioSupport","videoSupport","width","height","maxHeight","mozGetUserMedia","firefoxVer","screenshareFrameRate","location","protocol","callbackUserMedia","name","getScreenMedia","gsmCallback","useAudio","audioStream","addTrack","googLeakyBucket","maxWidth","screen","minFrameRate","maxFrameRate","chromeMediaSource","pending","Error","postMessage","ffver","mozMediaSource","mediaSource","lastTime","currentTime","polly","setInterval","clearInterval","onended","origin","sourceId","googTemporalLayeredScreencast","chromeMediaSourceId","audioExist","some","device","kind","videoExist","audioSend","videoSend","needAudioDevice","isAudioSendRequired","needVideoDevice","isVideoSendRequired","haveAudioDevice","haveVideoDevice","mediaConstraints","isAudioRecvEnabled","isVideoRecvEnabled","offer","setLocalDescription","answer","localDescription","stats","results","result","res","stat","getVideoTracks","enabled","timestamp","bitRate","round","streams","videoTracks","cb","inbound_rtp_video_1","bytesReceived","hangupRequest","close","failIfNoAudio","audioRecv","failIfNoVideo","videoRecv"],"mappings":"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","sourcesContent":["/*\n\tThe MIT License (MIT)\n\n\tCopyright (c) 2016 Meetecho\n\n\tPermission is hereby granted, free of charge, to any person obtaining\n\ta copy of this software and associated documentation files (the \"Software\"),\n\tto deal in the Software without restriction, including without limitation\n\tthe rights to use, copy, modify, merge, publish, distribute, sublicense,\n\tand/or sell copies of the Software, and to permit persons to whom the\n\tSoftware is furnished to do so, subject to the following conditions:\n\n\tThe above copyright notice and this permission notice shall be included\n\tin all copies or substantial portions of the Software.\n\n\tTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS\n\tOR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n\tFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL\n\tTHE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR\n\tOTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,\n\tARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR\n\tOTHER DEALINGS IN THE SOFTWARE.\n */\n\n// List of sessions\nJanus.sessions = {};\n\n// Screensharing Chrome Extension ID\nJanus.extensionId = \"hapfgfdkleiggjjpfpenajgdnfckjpaj\";\nJanus.isExtensionEnabled = function() {\n\tif(window.navigator.userAgent.match('Chrome')) {\n\t\tvar chromever = parseInt(window.navigator.userAgent.match(/Chrome\\/(.*) /)[1], 10);\n\t\tvar maxver = 33;\n\t\tif(window.navigator.userAgent.match('Linux'))\n\t\t\tmaxver = 35;\t// \"known\" crash in chrome 34 and 35 on linux\n\t\tif(chromever >= 26 && chromever <= maxver) {\n\t\t\t// Older versions of Chrome don't support this extension-based approach, so lie\n\t\t\treturn true;\n\t\t}\n\t\treturn ($('#janus-extension-installed').length > 0);\n\t} else {\n\t\t// Firefox of others, no need for the extension (but this doesn't mean it will work)\n\t\treturn true;\n\t}\n};\n\nJanus.noop = function() {};\n\n// Initialization\nJanus.init = function(options) {\n\toptions = options || {};\n\toptions.callback = (typeof options.callback == \"function\") ? options.callback : Janus.noop;\n\tif(Janus.initDone === true) {\n\t\t// Already initialized\n\t\toptions.callback();\n\t} else {\n\t\tif(typeof console == \"undefined\" || typeof console.log == \"undefined\")\n\t\t\tconsole = { log: function() {} };\n\t\t// Console logging (all debugging disabled by default)\n\t\tJanus.trace = Janus.noop;\n\t\tJanus.debug = Janus.noop;\n\t\tJanus.vdebug = Janus.noop;\n\t\tJanus.log = Janus.noop;\n\t\tJanus.warn = Janus.noop;\n\t\tJanus.error = Janus.noop;\n\t\tif(options.debug === true || options.debug === \"all\") {\n\t\t\t// Enable all debugging levels\n\t\t\tJanus.trace = console.trace.bind(console);\n\t\t\tJanus.debug = console.debug.bind(console);\n\t\t\tJanus.vdebug = console.debug.bind(console);\n\t\t\tJanus.log = console.log.bind(console);\n\t\t\tJanus.warn = console.warn.bind(console);\n\t\t\tJanus.error = console.error.bind(console);\n\t\t} else if(Array.isArray(options.debug)) {\n\t\t\tfor(var i in options.debug) {\n\t\t\t\tvar d = options.debug[i];\n\t\t\t\tswitch(d) {\n\t\t\t\t\tcase \"trace\":\n\t\t\t\t\t\tJanus.trace = console.trace.bind(console);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"debug\":\n\t\t\t\t\t\tJanus.debug = console.debug.bind(console);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"vdebug\":\n\t\t\t\t\t\tJanus.vdebug = console.debug.bind(console);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"log\":\n\t\t\t\t\t\tJanus.log = console.log.bind(console);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"warn\":\n\t\t\t\t\t\tJanus.warn = console.warn.bind(console);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"error\":\n\t\t\t\t\t\tJanus.error = console.error.bind(console);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tconsole.error(\"Unknown debugging option '\" + d + \"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')\");\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tJanus.log(\"Initializing library\");\n\t\t// Helper method to enumerate devices\n\t\tJanus.listDevices = function(callback, config) {\n\t\t\tcallback = (typeof callback == \"function\") ? callback : Janus.noop;\n\t\t\tif (config == null) config = { audio: true, video: true };\n\t\t\tif(navigator.mediaDevices) {\n\t\t\t\tnavigator.mediaDevices.getUserMedia(config)\n\t\t\t\t.then(function(stream) {\n\t\t\t\t\tnavigator.mediaDevices.enumerateDevices().then(function(devices) {\n\t\t\t\t\t\tJanus.debug(devices);\n\t\t\t\t\t\tcallback(devices);\n\t\t\t\t\t\t// Get rid of the now useless stream\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tstream.stop();\n\t\t\t\t\t\t} catch(e) {}\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tvar tracks = stream.getTracks();\n\t\t\t\t\t\t\tfor(var i in tracks) {\n\t\t\t\t\t\t\t\tvar mst = tracks[i];\n\t\t\t\t\t\t\t\tif(mst !== null && mst !== undefined)\n\t\t\t\t\t\t\t\t\tmst.stop();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} catch(e) {}\n\t\t\t\t\t});\n\t\t\t\t})\n\t\t\t\t.catch(function(err) {\n\t\t\t\t\tJanus.error(err);\n\t\t\t\t\tcallback([]);\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tJanus.warn(\"navigator.mediaDevices unavailable\");\n\t\t\t\tcallback([]);\n\t\t\t}\n\t\t}\n\t\t// Helper methods to attach/reattach a stream to a video element (previously part of adapter.js)\n\t\tJanus.attachMediaStream = function(element, stream) {\n\t\t\tif(adapter.browserDetails.browser === 'chrome') {\n\t\t\t\tvar chromever = adapter.browserDetails.version;\n\t\t\t\tif(chromever >= 43) {\n\t\t\t\t\telement.srcObject = stream;\n\t\t\t\t} else if(typeof element.src !== 'undefined') {\n\t\t\t\t\telement.src = URL.createObjectURL(stream);\n\t\t\t\t} else {\n\t\t\t\t\tJanus.error(\"Error attaching stream to element\");\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\telement.srcObject = stream;\n\t\t\t}\n\t\t};\n\t\tJanus.reattachMediaStream = function(to, from) {\n\t\t\tif(adapter.browserDetails.browser === 'chrome') {\n\t\t\t\tvar chromever = adapter.browserDetails.version;\n\t\t\t\tif(chromever >= 43) {\n\t\t\t\t\tto.srcObject = from.srcObject;\n\t\t\t\t} else if(typeof to.src !== 'undefined') {\n\t\t\t\t\tto.src = from.src;\n\t\t\t\t}\n\t\t\t} else if(adapter.browserDetails.browser === 'safari' || window.navigator.userAgent.match(/iPad/i) || window.navigator.userAgent.match(/iPhone/i)) {\n\t\t\t\tto.src = from.src;\n\t\t\t} else {\n\t\t\t\tto.srcObject = from.srcObject;\n\t\t\t}\n\t\t};\n\t\t// Detect tab close: make sure we don't loose existing onbeforeunload handlers\n\t\tvar oldOBF = window.onbeforeunload;\n\t\twindow.onbeforeunload = function() {\n\t\t\tJanus.log(\"Closing window\");\n\t\t\tfor(var s in Janus.sessions) {\n\t\t\t\tif(Janus.sessions[s] !== null && Janus.sessions[s] !== undefined &&\n\t\t\t\t\t\tJanus.sessions[s].destroyOnUnload) {\n\t\t\t\t\tJanus.log(\"Destroying session \" + s);\n\t\t\t\t\tJanus.sessions[s].destroy({asyncRequest: false});\n\t\t\t\t}\n\t\t\t}\n\t\t\tif(oldOBF && typeof oldOBF == \"function\")\n\t\t\t\toldOBF();\n\t\t}\n\t\tJanus.initDone = true;\n\t\toptions.callback();\n\t}\n};\n\n// Helper method to check whether WebRTC is supported by this browser\nJanus.isWebrtcSupported = function() {\n\treturn window.RTCPeerConnection !== undefined && window.RTCPeerConnection !== null &&\n\t\tnavigator.getUserMedia !== undefined && navigator.getUserMedia !== null;\n};\n\n// Helper method to create random identifiers (e.g., transaction)\nJanus.randomString = function(len) {\n\tvar charSet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\n\tvar randomString = '';\n\tfor (var i = 0; i < len; i++) {\n\t\tvar randomPoz = Math.floor(Math.random() * charSet.length);\n\t\trandomString += charSet.substring(randomPoz,randomPoz+1);\n\t}\n\treturn randomString;\n}\n\n\nfunction Janus(gatewayCallbacks) {\n\tif(Janus.initDone === undefined) {\n\t\tgatewayCallbacks.error(\"Library not initialized\");\n\t\treturn {};\n\t}\n\tif(!Janus.isWebrtcSupported()) {\n\t\tgatewayCallbacks.error(\"WebRTC not supported by this browser\");\n\t\treturn {};\n\t}\n\tJanus.log(\"Library initialized: \" + Janus.initDone);\n\tgatewayCallbacks = gatewayCallbacks || {};\n\tgatewayCallbacks.success = (typeof gatewayCallbacks.success == \"function\") ? gatewayCallbacks.success : jQuery.noop;\n\tgatewayCallbacks.error = (typeof gatewayCallbacks.error == \"function\") ? gatewayCallbacks.error : jQuery.noop;\n\tgatewayCallbacks.destroyed = (typeof gatewayCallbacks.destroyed == \"function\") ? gatewayCallbacks.destroyed : jQuery.noop;\n\tif(gatewayCallbacks.server === null || gatewayCallbacks.server === undefined) {\n\t\tgatewayCallbacks.error(\"Invalid gateway url\");\n\t\treturn {};\n\t}\n\tvar websockets = false;\n\tvar ws = null;\n\tvar wsHandlers = {};\n\tvar wsKeepaliveTimeoutId = null;\n\n\tvar servers = null, serversIndex = 0;\n\tvar server = gatewayCallbacks.server;\n\tif($.isArray(server)) {\n\t\tJanus.log(\"Multiple servers provided (\" + server.length + \"), will use the first that works\");\n\t\tserver = null;\n\t\tservers = gatewayCallbacks.server;\n\t\tJanus.debug(servers);\n\t} else {\n\t\tif(server.indexOf(\"ws\") === 0) {\n\t\t\twebsockets = true;\n\t\t\tJanus.log(\"Using WebSockets to contact Janus: \" + server);\n\t\t} else {\n\t\t\twebsockets = false;\n\t\t\tJanus.log(\"Using REST API to contact Janus: \" + server);\n\t\t}\n\t}\n\tvar iceServers = gatewayCallbacks.iceServers;\n\tif(iceServers === undefined || iceServers === null)\n\t\ticeServers = [{urls: \"stun:stun.l.google.com:19302\"}];\n\tvar iceTransportPolicy = gatewayCallbacks.iceTransportPolicy;\n\t// Whether IPv6 candidates should be gathered\n\tvar ipv6Support = gatewayCallbacks.ipv6;\n\tif(ipv6Support === undefined || ipv6Support === null)\n\t\tipv6Support = false;\n\t// Whether we should enable the withCredentials flag for XHR requests\n\tvar withCredentials = false;\n\tif(gatewayCallbacks.withCredentials !== undefined && gatewayCallbacks.withCredentials !== null)\n\t\twithCredentials = gatewayCallbacks.withCredentials === true;\n\t// Optional max events\n\tvar maxev = null;\n\tif(gatewayCallbacks.max_poll_events !== undefined && gatewayCallbacks.max_poll_events !== null)\n\t\tmaxev = gatewayCallbacks.max_poll_events;\n\tif(maxev < 1)\n\t\tmaxev = 1;\n\t// Token to use (only if the token based authentication mechanism is enabled)\n\tvar token = null;\n\tif(gatewayCallbacks.token !== undefined && gatewayCallbacks.token !== null)\n\t\ttoken = gatewayCallbacks.token;\n\t// API secret to use (only if the shared API secret is enabled)\n\tvar apisecret = null;\n\tif(gatewayCallbacks.apisecret !== undefined && gatewayCallbacks.apisecret !== null)\n\t\tapisecret = gatewayCallbacks.apisecret;\n\t// Whether we should destroy this session when onbeforeunload is called\n\tthis.destroyOnUnload = true;\n\tif(gatewayCallbacks.destroyOnUnload !== undefined && gatewayCallbacks.destroyOnUnload !== null)\n\t\tthis.destroyOnUnload = (gatewayCallbacks.destroyOnUnload === true);\n\n\tvar connected = false;\n\tvar sessionId = null;\n\tvar pluginHandles = {};\n\tvar that = this;\n\tvar retries = 0;\n\tvar transactions = {};\n\tcreateSession(gatewayCallbacks);\n\n\t// Public methods\n\tthis.getServer = function() { return server; };\n\tthis.isConnected = function() { return connected; };\n\tthis.getSessionId = function() { return sessionId; };\n\tthis.destroy = function(callbacks) { destroySession(callbacks); };\n\tthis.attach = function(callbacks) { createHandle(callbacks); };\n\n\tfunction eventHandler() {\n\t\tif(sessionId == null)\n\t\t\treturn;\n\t\tJanus.debug('Long poll...');\n\t\tif(!connected) {\n\t\t\tJanus.warn(\"Is the gateway down? (connected=false)\");\n\t\t\treturn;\n\t\t}\n\t\tvar longpoll = server + \"/\" + sessionId + \"?rid=\" + new Date().getTime();\n\t\tif(maxev !== undefined && maxev !== null)\n\t\t\tlongpoll = longpoll + \"&maxev=\" + maxev;\n\t\tif(token !== null && token !== undefined)\n\t\t\tlongpoll = longpoll + \"&token=\" + token;\n\t\tif(apisecret !== null && apisecret !== undefined)\n\t\t\tlongpoll = longpoll + \"&apisecret=\" + apisecret;\n\t\t$.ajax({\n\t\t\ttype: 'GET',\n\t\t\turl: longpoll,\n\t\t\txhrFields: {\n\t\t\t\twithCredentials: withCredentials\n\t\t\t},\n\t\t\tcache: false,\n\t\t\ttimeout: 60000,\t// FIXME\n\t\t\tsuccess: handleEvent,\n\t\t\terror: function(XMLHttpRequest, textStatus, errorThrown) {\n\t\t\t\tJanus.error(textStatus + \": \" + errorThrown);\n\t\t\t\tretries++;\n\t\t\t\tif(retries > 3) {\n\t\t\t\t\t// Did we just lose the gateway? :-(\n\t\t\t\t\tconnected = false;\n\t\t\t\t\tgatewayCallbacks.error(\"Lost connection to the gateway (is it down?)\");\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\teventHandler();\n\t\t\t},\n\t\t\tdataType: \"json\"\n\t\t});\n\t}\n\n\t// Private event handler: this will trigger plugin callbacks, if set\n\tfunction handleEvent(json, skipTimeout) {\n\t\tretries = 0;\n\t\tif(!websockets && sessionId !== undefined && sessionId !== null && skipTimeout !== true)\n\t\t\tsetTimeout(eventHandler, 200);\n\t\tif(!websockets && $.isArray(json)) {\n\t\t\t// We got an array: it means we passed a maxev > 1, iterate on all objects\n\t\t\tfor(var i=0; i<json.length; i++) {\n\t\t\t\thandleEvent(json[i], true);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\t\tif(json[\"janus\"] === \"keepalive\") {\n\t\t\t// Nothing happened\n\t\t\tJanus.vdebug(\"Got a keepalive on session \" + sessionId);\n\t\t\treturn;\n\t\t} else if(json[\"janus\"] === \"ack\") {\n\t\t\t// Just an ack, we can probably ignore\n\t\t\tJanus.debug(\"Got an ack on session \" + sessionId);\n\t\t\tJanus.debug(json);\n\t\t\tvar transaction = json[\"transaction\"];\n\t\t\tif(transaction !== null && transaction !== undefined) {\n\t\t\t\tvar reportSuccess = transactions[transaction];\n\t\t\t\tif(reportSuccess !== null && reportSuccess !== undefined) {\n\t\t\t\t\treportSuccess(json);\n\t\t\t\t}\n\t\t\t\tdelete transactions[transaction];\n\t\t\t}\n\t\t\treturn;\n\t\t} else if(json[\"janus\"] === \"success\") {\n\t\t\t// Success!\n\t\t\tJanus.debug(\"Got a success on session \" + sessionId);\n\t\t\tJanus.debug(json);\n\t\t\tvar transaction = json[\"transaction\"];\n\t\t\tif(transaction !== null && transaction !== undefined) {\n\t\t\t\tvar reportSuccess = transactions[transaction];\n\t\t\t\tif(reportSuccess !== null && reportSuccess !== undefined) {\n\t\t\t\t\treportSuccess(json);\n\t\t\t\t}\n\t\t\t\tdelete transactions[transaction];\n\t\t\t}\n\t\t\treturn;\n\t\t} else if(json[\"janus\"] === \"webrtcup\") {\n\t\t\t// The PeerConnection with the gateway is up! Notify this\n\t\t\tJanus.debug(\"Got a webrtcup event on session \" + sessionId);\n\t\t\tJanus.debug(json);\n\t\t\tvar sender = json[\"sender\"];\n\t\t\tif(sender === undefined || sender === null) {\n\t\t\t\tJanus.warn(\"Missing sender...\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvar pluginHandle = pluginHandles[sender];\n\t\t\tif(pluginHandle === undefined || pluginHandle === null) {\n\t\t\t\tJanus.debug(\"This handle is not attached to this session\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tpluginHandle.webrtcState(true);\n\t\t\treturn;\n\t\t} else if(json[\"janus\"] === \"hangup\") {\n\t\t\t// A plugin asked the core to hangup a PeerConnection on one of our handles\n\t\t\tJanus.debug(\"Got a hangup event on session \" + sessionId);\n\t\t\tJanus.debug(json);\n\t\t\tvar sender = json[\"sender\"];\n\t\t\tif(sender === undefined || sender === null) {\n\t\t\t\tJanus.warn(\"Missing sender...\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvar pluginHandle = pluginHandles[sender];\n\t\t\tif(pluginHandle === undefined || pluginHandle === null) {\n\t\t\t\tJanus.debug(\"This handle is not attached to this session\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tpluginHandle.webrtcState(false, json[\"reason\"]);\n\t\t\tpluginHandle.hangup();\n\t\t} else if(json[\"janus\"] === \"detached\") {\n\t\t\t// A plugin asked the core to detach one of our handles\n\t\t\tJanus.debug(\"Got a detached event on session \" + sessionId);\n\t\t\tJanus.debug(json);\n\t\t\tvar sender = json[\"sender\"];\n\t\t\tif(sender === undefined || sender === null) {\n\t\t\t\tJanus.warn(\"Missing sender...\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvar pluginHandle = pluginHandles[sender];\n\t\t\tif(pluginHandle === undefined || pluginHandle === null) {\n\t\t\t\t// Don't warn here because destroyHandle causes this situation.\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tpluginHandle.detached = true;\n\t\t\tpluginHandle.ondetached();\n\t\t\tpluginHandle.detach();\n\t\t} else if(json[\"janus\"] === \"media\") {\n\t\t\t// Media started/stopped flowing\n\t\t\tJanus.debug(\"Got a media event on session \" + sessionId);\n\t\t\tJanus.debug(json);\n\t\t\tvar sender = json[\"sender\"];\n\t\t\tif(sender === undefined || sender === null) {\n\t\t\t\tJanus.warn(\"Missing sender...\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvar pluginHandle = pluginHandles[sender];\n\t\t\tif(pluginHandle === undefined || pluginHandle === null) {\n\t\t\t\tJanus.debug(\"This handle is not attached to this session\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tpluginHandle.mediaState(json[\"type\"], json[\"receiving\"]);\n\t\t} else if(json[\"janus\"] === \"slowlink\") {\n\t\t\tJanus.debug(\"Got a slowlink event on session \" + sessionId);\n\t\t\tJanus.debug(json);\n\t\t\t// Trouble uplink or downlink\n\t\t\tvar sender = json[\"sender\"];\n\t\t\tif(sender === undefined || sender === null) {\n\t\t\t\tJanus.warn(\"Missing sender...\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvar pluginHandle = pluginHandles[sender];\n\t\t\tif(pluginHandle === undefined || pluginHandle === null) {\n\t\t\t\tJanus.debug(\"This handle is not attached to this session\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tpluginHandle.slowLink(json[\"uplink\"], json[\"nacks\"]);\n\t\t} else if(json[\"janus\"] === \"error\") {\n\t\t\t// Oops, something wrong happened\n\t\t\tJanus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason);\t// FIXME\n\t\t\tJanus.debug(json);\n\t\t\tvar transaction = json[\"transaction\"];\n\t\t\tif(transaction !== null && transaction !== undefined) {\n\t\t\t\tvar reportSuccess = transactions[transaction];\n\t\t\t\tif(reportSuccess !== null && reportSuccess !== undefined) {\n\t\t\t\t\treportSuccess(json);\n\t\t\t\t}\n\t\t\t\tdelete transactions[transaction];\n\t\t\t}\n\t\t\treturn;\n\t\t} else if(json[\"janus\"] === \"event\") {\n\t\t\tJanus.debug(\"Got a plugin event on session \" + sessionId);\n\t\t\tJanus.debug(json);\n\t\t\tvar sender = json[\"sender\"];\n\t\t\tif(sender === undefined || sender === null) {\n\t\t\t\tJanus.warn(\"Missing sender...\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvar plugindata = json[\"plugindata\"];\n\t\t\tif(plugindata === undefined || plugindata === null) {\n\t\t\t\tJanus.warn(\"Missing plugindata...\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tJanus.debug(\"  -- Event is coming from \" + sender + \" (\" + plugindata[\"plugin\"] + \")\");\n\t\t\tvar data = plugindata[\"data\"];\n\t\t\tJanus.debug(data);\n\t\t\tvar pluginHandle = pluginHandles[sender];\n\t\t\tif(pluginHandle === undefined || pluginHandle === null) {\n\t\t\t\tJanus.warn(\"This handle is not attached to this session\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvar jsep = json[\"jsep\"];\n\t\t\tif(jsep !== undefined && jsep !== null) {\n\t\t\t\tJanus.debug(\"Handling SDP as well...\");\n\t\t\t\tJanus.debug(jsep);\n\t\t\t}\n\t\t\tvar callback = pluginHandle.onmessage;\n\t\t\tif(callback !== null && callback !== undefined) {\n\t\t\t\tJanus.debug(\"Notifying application...\");\n\t\t\t\t// Send to callback specified when attaching plugin handle\n\t\t\t\tcallback(data, jsep);\n\t\t\t} else {\n\t\t\t\t// Send to generic callback (?)\n\t\t\t\tJanus.debug(\"No provided notification callback\");\n\t\t\t}\n\t\t} else {\n\t\t\tJanus.warn(\"Unkown message/event  '\" + json[\"janus\"] + \"' on session \" + sessionId);\n\t\t\tJanus.debug(json);\n\t\t}\n\t}\n\n\t// Private helper to send keep-alive messages on WebSockets\n\tfunction keepAlive() {\n\t\tif(server === null || !websockets || !connected)\n\t\t\treturn;\n\t\twsKeepaliveTimeoutId = setTimeout(keepAlive, 30000);\n\t\tvar request = { \"janus\": \"keepalive\", \"session_id\": sessionId, \"transaction\": Janus.randomString(12) };\n\t\tif(token !== null && token !== undefined)\n\t\t\trequest[\"token\"] = token;\n\t\tif(apisecret !== null && apisecret !== undefined)\n\t\t\trequest[\"apisecret\"] = apisecret;\n\t\tws.send(JSON.stringify(request));\n\t}\n\n\t// Private method to create a session\n\tfunction createSession(callbacks) {\n\t\tvar transaction = Janus.randomString(12);\n\t\tvar request = { \"janus\": \"create\", \"transaction\": transaction };\n\t\tif(token !== null && token !== undefined)\n\t\t\trequest[\"token\"] = token;\n\t\tif(apisecret !== null && apisecret !== undefined)\n\t\t\trequest[\"apisecret\"] = apisecret;\n\t\tif(server === null && $.isArray(servers)) {\n\t\t\t// We still need to find a working server from the list we were given\n\t\t\tserver = servers[serversIndex];\n\t\t\tif(server.indexOf(\"ws\") === 0) {\n\t\t\t\twebsockets = true;\n\t\t\t\tJanus.log(\"Server #\" + (serversIndex+1) + \": trying WebSockets to contact Janus (\" + server + \")\");\n\t\t\t} else {\n\t\t\t\twebsockets = false;\n\t\t\t\tJanus.log(\"Server #\" + (serversIndex+1) + \": trying REST API to contact Janus (\" + server + \")\");\n\t\t\t}\n\t\t}\n\t\tif(websockets) {\n\t\t\tws = new WebSocket(server, 'janus-protocol');\n\t\t\twsHandlers = {\n\t\t\t\t'error': function() {\n\t\t\t\t\tJanus.error(\"Error connecting to the Janus WebSockets server... \" + server);\n\t\t\t\t\tif ($.isArray(servers)) {\n\t\t\t\t\t\tserversIndex++;\n\t\t\t\t\t\tif (serversIndex == servers.length) {\n\t\t\t\t\t\t\t// We tried all the servers the user gave us and they all failed\n\t\t\t\t\t\t\tcallbacks.error(\"Error connecting to any of the provided Janus servers: Is the gateway down?\");\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// Let's try the next server\n\t\t\t\t\t\tserver = null;\n\t\t\t\t\t\tsetTimeout(function() {\n\t\t\t\t\t\t\tcreateSession(callbacks);\n\t\t\t\t\t\t}, 200);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tcallbacks.error(\"Error connecting to the Janus WebSockets server: Is the gateway down?\");\n\t\t\t\t},\n\n\t\t\t\t'open': function() {\n\t\t\t\t\t// We need to be notified about the success\n\t\t\t\t\ttransactions[transaction] = function(json) {\n\t\t\t\t\t\tJanus.debug(json);\n\t\t\t\t\t\tif (json[\"janus\"] !== \"success\") {\n\t\t\t\t\t\t\tJanus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason);\t// FIXME\n\t\t\t\t\t\t\tcallbacks.error(json[\"error\"].reason);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\twsKeepaliveTimeoutId = setTimeout(keepAlive, 30000);\n\t\t\t\t\t\tconnected = true;\n\t\t\t\t\t\tsessionId = json.data[\"id\"];\n\t\t\t\t\t\tJanus.log(\"Created session: \" + sessionId);\n\t\t\t\t\t\tJanus.sessions[sessionId] = that;\n\t\t\t\t\t\tcallbacks.success();\n\t\t\t\t\t};\n\t\t\t\t\tws.send(JSON.stringify(request));\n\t\t\t\t},\n\n\t\t\t\t'message': function(event) {\n\t\t\t\t\thandleEvent(JSON.parse(event.data));\n\t\t\t\t},\n\n\t\t\t\t'close': function() {\n\t\t\t\t\tif (server === null || !connected) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tconnected = false;\n\t\t\t\t\t// FIXME What if this is called when the page is closed?\n\t\t\t\t\tgatewayCallbacks.error(\"Lost connection to the gateway (is it down?)\");\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tfor(var eventName in wsHandlers) {\n\t\t\t\tws.addEventListener(eventName, wsHandlers[eventName]);\n\t\t\t}\n\n\t\t\treturn;\n\t\t}\n\t\t$.ajax({\n\t\t\ttype: 'POST',\n\t\t\turl: server,\n\t\t\txhrFields: {\n\t\t\t\twithCredentials: withCredentials\n\t\t\t},\n\t\t\tcache: false,\n\t\t\tcontentType: \"application/json\",\n\t\t\tdata: JSON.stringify(request),\n\t\t\tsuccess: function(json) {\n\t\t\t\tJanus.debug(json);\n\t\t\t\tif(json[\"janus\"] !== \"success\") {\n\t\t\t\t\tJanus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason);\t// FIXME\n\t\t\t\t\tcallbacks.error(json[\"error\"].reason);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tconnected = true;\n\t\t\t\tsessionId = json.data[\"id\"];\n\t\t\t\tJanus.log(\"Created session: \" + sessionId);\n\t\t\t\tJanus.sessions[sessionId] = that;\n\t\t\t\teventHandler();\n\t\t\t\tcallbacks.success();\n\t\t\t},\n\t\t\terror: function(XMLHttpRequest, textStatus, errorThrown) {\n\t\t\t\tJanus.error(textStatus + \": \" + errorThrown);\t// FIXME\n\t\t\t\tif($.isArray(servers)) {\n\t\t\t\t\tserversIndex++;\n\t\t\t\t\tif(serversIndex == servers.length) {\n\t\t\t\t\t\t// We tried all the servers the user gave us and they all failed\n\t\t\t\t\t\tcallbacks.error(\"Error connecting to any of the provided Janus servers: Is the gateway down?\");\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\t// Let's try the next server\n\t\t\t\t\tserver = null;\n\t\t\t\t\tsetTimeout(function() { createSession(callbacks); }, 200);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tif(errorThrown === \"\")\n\t\t\t\t\tcallbacks.error(textStatus + \": Is the gateway down?\");\n\t\t\t\telse\n\t\t\t\t\tcallbacks.error(textStatus + \": \" + errorThrown);\n\t\t\t},\n\t\t\tdataType: \"json\"\n\t\t});\n\t}\n\n\t// Private method to destroy a session\n\tfunction destroySession(callbacks) {\n\t\tcallbacks = callbacks || {};\n\t\t// FIXME This method triggers a success even when we fail\n\t\tcallbacks.success = (typeof callbacks.success == \"function\") ? callbacks.success : jQuery.noop;\n\t\tvar asyncRequest = true;\n\t\tif(callbacks.asyncRequest !== undefined && callbacks.asyncRequest !== null)\n\t\t\tasyncRequest = (callbacks.asyncRequest === true);\n\t\tJanus.log(\"Destroying session \" + sessionId + \" (async=\" + asyncRequest + \")\");\n\t\tif(!connected) {\n\t\t\tJanus.warn(\"Is the gateway down? (connected=false)\");\n\t\t\tcallbacks.success();\n\t\t\treturn;\n\t\t}\n\t\tif(sessionId === undefined || sessionId === null) {\n\t\t\tJanus.warn(\"No session to destroy\");\n\t\t\tcallbacks.success();\n\t\t\tgatewayCallbacks.destroyed();\n\t\t\treturn;\n\t\t}\n\t\tdelete Janus.sessions[sessionId];\n\t\t// No need to destroy all handles first, Janus will do that itself\n\t\tvar request = { \"janus\": \"destroy\", \"transaction\": Janus.randomString(12) };\n\t\tif(token !== null && token !== undefined)\n\t\t\trequest[\"token\"] = token;\n\t\tif(apisecret !== null && apisecret !== undefined)\n\t\t\trequest[\"apisecret\"] = apisecret;\n\t\tif(websockets) {\n\t\t\trequest[\"session_id\"] = sessionId;\n\n\t\t\tvar unbindWebSocket = function() {\n\t\t\t\tfor(var eventName in wsHandlers) {\n\t\t\t\t\tws.removeEventListener(eventName, wsHandlers[eventName]);\n\t\t\t\t}\n\t\t\t\tws.removeEventListener('message', onUnbindMessage);\n\t\t\t\tws.removeEventListener('error', onUnbindError);\n\t\t\t\tif(wsKeepaliveTimeoutId) {\n\t\t\t\t\tclearTimeout(wsKeepaliveTimeoutId);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tvar onUnbindMessage = function(event){\n\t\t\t\tvar data = JSON.parse(event.data);\n\t\t\t\tif(data.session_id == request.session_id && data.transaction == request.transaction) {\n\t\t\t\t\tunbindWebSocket();\n\t\t\t\t\tcallbacks.success();\n\t\t\t\t\tgatewayCallbacks.destroyed();\n\t\t\t\t}\n\t\t\t};\n\t\t\tvar onUnbindError = function(event) {\n\t\t\t\tunbindWebSocket();\n\t\t\t\tcallbacks.error(\"Failed to destroy the gateway: Is the gateway down?\");\n\t\t\t\tgatewayCallbacks.destroyed();\n\t\t\t};\n\n\t\t\tws.addEventListener('message', onUnbindMessage);\n\t\t\tws.addEventListener('error', onUnbindError);\n\n\t\t\tws.send(JSON.stringify(request));\n\t\t\treturn;\n\t\t}\n\t\t$.ajax({\n\t\t\ttype: 'POST',\n\t\t\turl: server + \"/\" + sessionId,\n\t\t\tasync: asyncRequest,\t// Sometimes we need false here, or destroying in onbeforeunload won't work\n\t\t\txhrFields: {\n\t\t\t\twithCredentials: withCredentials\n\t\t\t},\n\t\t\tcache: false,\n\t\t\tcontentType: \"application/json\",\n\t\t\tdata: JSON.stringify(request),\n\t\t\tsuccess: function(json) {\n\t\t\t\tJanus.log(\"Destroyed session:\");\n\t\t\t\tJanus.debug(json);\n\t\t\t\tsessionId = null;\n\t\t\t\tconnected = false;\n\t\t\t\tif(json[\"janus\"] !== \"success\") {\n\t\t\t\t\tJanus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason);\t// FIXME\n\t\t\t\t}\n\t\t\t\tcallbacks.success();\n\t\t\t\tgatewayCallbacks.destroyed();\n\t\t\t},\n\t\t\terror: function(XMLHttpRequest, textStatus, errorThrown) {\n\t\t\t\tJanus.error(textStatus + \": \" + errorThrown);\t// FIXME\n\t\t\t\t// Reset everything anyway\n\t\t\t\tsessionId = null;\n\t\t\t\tconnected = false;\n\t\t\t\tcallbacks.success();\n\t\t\t\tgatewayCallbacks.destroyed();\n\t\t\t},\n\t\t\tdataType: \"json\"\n\t\t});\n\t}\n\n\t// Private method to create a plugin handle\n\tfunction createHandle(callbacks) {\n\t\tcallbacks = callbacks || {};\n\t\tcallbacks.success = (typeof callbacks.success == \"function\") ? callbacks.success : jQuery.noop;\n\t\tcallbacks.error = (typeof callbacks.error == \"function\") ? callbacks.error : jQuery.noop;\n\t\tcallbacks.consentDialog = (typeof callbacks.consentDialog == \"function\") ? callbacks.consentDialog : jQuery.noop;\n\t\tcallbacks.iceState = (typeof callbacks.iceState == \"function\") ? callbacks.iceState : jQuery.noop;\n\t\tcallbacks.mediaState = (typeof callbacks.mediaState == \"function\") ? callbacks.mediaState : jQuery.noop;\n\t\tcallbacks.webrtcState = (typeof callbacks.webrtcState == \"function\") ? callbacks.webrtcState : jQuery.noop;\n\t\tcallbacks.slowLink = (typeof callbacks.slowLink == \"function\") ? callbacks.slowLink : jQuery.noop;\n\t\tcallbacks.onmessage = (typeof callbacks.onmessage == \"function\") ? callbacks.onmessage : jQuery.noop;\n\t\tcallbacks.onlocalstream = (typeof callbacks.onlocalstream == \"function\") ? callbacks.onlocalstream : jQuery.noop;\n\t\tcallbacks.onremotestream = (typeof callbacks.onremotestream == \"function\") ? callbacks.onremotestream : jQuery.noop;\n\t\tcallbacks.ondata = (typeof callbacks.ondata == \"function\") ? callbacks.ondata : jQuery.noop;\n\t\tcallbacks.ondataopen = (typeof callbacks.ondataopen == \"function\") ? callbacks.ondataopen : jQuery.noop;\n\t\tcallbacks.oncleanup = (typeof callbacks.oncleanup == \"function\") ? callbacks.oncleanup : jQuery.noop;\n\t\tcallbacks.ondetached = (typeof callbacks.ondetached == \"function\") ? callbacks.ondetached : jQuery.noop;\n\t\tif(!connected) {\n\t\t\tJanus.warn(\"Is the gateway down? (connected=false)\");\n\t\t\tcallbacks.error(\"Is the gateway down? (connected=false)\");\n\t\t\treturn;\n\t\t}\n\t\tvar plugin = callbacks.plugin;\n\t\tif(plugin === undefined || plugin === null) {\n\t\t\tJanus.error(\"Invalid plugin\");\n\t\t\tcallbacks.error(\"Invalid plugin\");\n\t\t\treturn;\n\t\t}\n\t\tvar opaqueId = callbacks.opaqueId;\n\t\tvar transaction = Janus.randomString(12);\n\t\tvar request = { \"janus\": \"attach\", \"plugin\": plugin, \"opaque_id\": opaqueId, \"transaction\": transaction };\n\t\tif(token !== null && token !== undefined)\n\t\t\trequest[\"token\"] = token;\n\t\tif(apisecret !== null && apisecret !== undefined)\n\t\t\trequest[\"apisecret\"] = apisecret;\n\t\t// If we know the browser supports BUNDLE and/or rtcp-mux, let's advertise those right away\n\t\tif(adapter.browserDetails.browser == \"chrome\" || adapter.browserDetails.browser == \"firefox\") {\n\t\t\trequest[\"force-bundle\"] = true;\n\t\t\trequest[\"force-rtcp-mux\"] = true;\n\t\t}\n\t\tif(websockets) {\n\t\t\ttransactions[transaction] = function(json) {\n\t\t\t\tJanus.debug(json);\n\t\t\t\tif(json[\"janus\"] !== \"success\") {\n\t\t\t\t\tJanus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason);\t// FIXME\n\t\t\t\t\tcallbacks.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tvar handleId = json.data[\"id\"];\n\t\t\t\tJanus.log(\"Created handle: \" + handleId);\n\t\t\t\tvar pluginHandle =\n\t\t\t\t\t{\n\t\t\t\t\t\tsession : that,\n\t\t\t\t\t\tplugin : plugin,\n\t\t\t\t\t\tid : handleId,\n\t\t\t\t\t\tdetached : false,\n\t\t\t\t\t\twebrtcStuff : {\n\t\t\t\t\t\t\tstarted : false,\n\t\t\t\t\t\t\tmyStream : null,\n\t\t\t\t\t\t\tstreamExternal : false,\n\t\t\t\t\t\t\tremoteStream : null,\n\t\t\t\t\t\t\tmySdp : null,\n\t\t\t\t\t\t\tpc : null,\n\t\t\t\t\t\t\tdataChannel : null,\n\t\t\t\t\t\t\tdtmfSender : null,\n\t\t\t\t\t\t\ttrickle : true,\n\t\t\t\t\t\t\ticeDone : false,\n\t\t\t\t\t\t\tsdpSent : false,\n\t\t\t\t\t\t\tvolume : {\n\t\t\t\t\t\t\t\tvalue : null,\n\t\t\t\t\t\t\t\ttimer : null\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tbitrate : {\n\t\t\t\t\t\t\t\tvalue : null,\n\t\t\t\t\t\t\t\tbsnow : null,\n\t\t\t\t\t\t\t\tbsbefore : null,\n\t\t\t\t\t\t\t\ttsnow : null,\n\t\t\t\t\t\t\t\ttsbefore : null,\n\t\t\t\t\t\t\t\ttimer : null\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\tgetId : function() { return handleId; },\n\t\t\t\t\t\tgetPlugin : function() { return plugin; },\n\t\t\t\t\t\tgetVolume : function() { return getVolume(handleId); },\n\t\t\t\t\t\tisAudioMuted : function() { return isMuted(handleId, false); },\n\t\t\t\t\t\tmuteAudio : function() { return mute(handleId, false, true); },\n\t\t\t\t\t\tunmuteAudio : function() { return mute(handleId, false, false); },\n\t\t\t\t\t\tisVideoMuted : function() { return isMuted(handleId, true); },\n\t\t\t\t\t\tmuteVideo : function() { return mute(handleId, true, true); },\n\t\t\t\t\t\tunmuteVideo : function() { return mute(handleId, true, false); },\n\t\t\t\t\t\tgetBitrate : function() { return getBitrate(handleId); },\n\t\t\t\t\t\tsend : function(callbacks) { sendMessage(handleId, callbacks); },\n\t\t\t\t\t\tdata : function(callbacks) { sendData(handleId, callbacks); },\n\t\t\t\t\t\tdtmf : function(callbacks) { sendDtmf(handleId, callbacks); },\n\t\t\t\t\t\tconsentDialog : callbacks.consentDialog,\n\t\t\t\t\t\ticeState : callbacks.iceState,\n\t\t\t\t\t\tmediaState : callbacks.mediaState,\n\t\t\t\t\t\twebrtcState : callbacks.webrtcState,\n\t\t\t\t\t\tslowLink : callbacks.slowLink,\n\t\t\t\t\t\tonmessage : callbacks.onmessage,\n\t\t\t\t\t\tcreateOffer : function(callbacks) { prepareWebrtc(handleId, callbacks); },\n\t\t\t\t\t\tcreateAnswer : function(callbacks) { prepareWebrtc(handleId, callbacks); },\n\t\t\t\t\t\thandleRemoteJsep : function(callbacks) { prepareWebrtcPeer(handleId, callbacks); },\n\t\t\t\t\t\tonlocalstream : callbacks.onlocalstream,\n\t\t\t\t\t\tonremotestream : callbacks.onremotestream,\n\t\t\t\t\t\tondata : callbacks.ondata,\n\t\t\t\t\t\tondataopen : callbacks.ondataopen,\n\t\t\t\t\t\toncleanup : callbacks.oncleanup,\n\t\t\t\t\t\tondetached : callbacks.ondetached,\n\t\t\t\t\t\thangup : function(sendRequest) { cleanupWebrtc(handleId, sendRequest === true); },\n\t\t\t\t\t\tdetach : function(callbacks) { destroyHandle(handleId, callbacks); }\n\t\t\t\t\t}\n\t\t\t\tpluginHandles[handleId] = pluginHandle;\n\t\t\t\tcallbacks.success(pluginHandle);\n\t\t\t};\n\t\t\trequest[\"session_id\"] = sessionId;\n\t\t\tws.send(JSON.stringify(request));\n\t\t\treturn;\n\t\t}\n\t\t$.ajax({\n\t\t\ttype: 'POST',\n\t\t\turl: server + \"/\" + sessionId,\n\t\t\txhrFields: {\n\t\t\t\twithCredentials: withCredentials\n\t\t\t},\n\t\t\tcache: false,\n\t\t\tcontentType: \"application/json\",\n\t\t\tdata: JSON.stringify(request),\n\t\t\tsuccess: function(json) {\n\t\t\t\tJanus.debug(json);\n\t\t\t\tif(json[\"janus\"] !== \"success\") {\n\t\t\t\t\tJanus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason);\t// FIXME\n\t\t\t\t\tcallbacks.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tvar handleId = json.data[\"id\"];\n\t\t\t\tJanus.log(\"Created handle: \" + handleId);\n\t\t\t\tvar pluginHandle =\n\t\t\t\t\t{\n\t\t\t\t\t\tsession : that,\n\t\t\t\t\t\tplugin : plugin,\n\t\t\t\t\t\tid : handleId,\n\t\t\t\t\t\tdetached : false,\n\t\t\t\t\t\twebrtcStuff : {\n\t\t\t\t\t\t\tstarted : false,\n\t\t\t\t\t\t\tmyStream : null,\n\t\t\t\t\t\t\tstreamExternal : false,\n\t\t\t\t\t\t\tremoteStream : null,\n\t\t\t\t\t\t\tmySdp : null,\n\t\t\t\t\t\t\tpc : null,\n\t\t\t\t\t\t\tdataChannel : null,\n\t\t\t\t\t\t\tdtmfSender : null,\n\t\t\t\t\t\t\ttrickle : true,\n\t\t\t\t\t\t\ticeDone : false,\n\t\t\t\t\t\t\tsdpSent : false,\n\t\t\t\t\t\t\tvolume : {\n\t\t\t\t\t\t\t\tvalue : null,\n\t\t\t\t\t\t\t\ttimer : null\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tbitrate : {\n\t\t\t\t\t\t\t\tvalue : null,\n\t\t\t\t\t\t\t\tbsnow : null,\n\t\t\t\t\t\t\t\tbsbefore : null,\n\t\t\t\t\t\t\t\ttsnow : null,\n\t\t\t\t\t\t\t\ttsbefore : null,\n\t\t\t\t\t\t\t\ttimer : null\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\tgetId : function() { return handleId; },\n\t\t\t\t\t\tgetPlugin : function() { return plugin; },\n\t\t\t\t\t\tgetVolume : function() { return getVolume(handleId); },\n\t\t\t\t\t\tisAudioMuted : function() { return isMuted(handleId, false); },\n\t\t\t\t\t\tmuteAudio : function() { return mute(handleId, false, true); },\n\t\t\t\t\t\tunmuteAudio : function() { return mute(handleId, false, false); },\n\t\t\t\t\t\tisVideoMuted : function() { return isMuted(handleId, true); },\n\t\t\t\t\t\tmuteVideo : function() { return mute(handleId, true, true); },\n\t\t\t\t\t\tunmuteVideo : function() { return mute(handleId, true, false); },\n\t\t\t\t\t\tgetBitrate : function() { return getBitrate(handleId); },\n\t\t\t\t\t\tsend : function(callbacks) { sendMessage(handleId, callbacks); },\n\t\t\t\t\t\tdata : function(callbacks) { sendData(handleId, callbacks); },\n\t\t\t\t\t\tdtmf : function(callbacks) { sendDtmf(handleId, callbacks); },\n\t\t\t\t\t\tconsentDialog : callbacks.consentDialog,\n\t\t\t\t\t\ticeState : callbacks.iceState,\n\t\t\t\t\t\tmediaState : callbacks.mediaState,\n\t\t\t\t\t\twebrtcState : callbacks.webrtcState,\n\t\t\t\t\t\tslowLink : callbacks.slowLink,\n\t\t\t\t\t\tonmessage : callbacks.onmessage,\n\t\t\t\t\t\tcreateOffer : function(callbacks) { prepareWebrtc(handleId, callbacks); },\n\t\t\t\t\t\tcreateAnswer : function(callbacks) { prepareWebrtc(handleId, callbacks); },\n\t\t\t\t\t\thandleRemoteJsep : function(callbacks) { prepareWebrtcPeer(handleId, callbacks); },\n\t\t\t\t\t\tonlocalstream : callbacks.onlocalstream,\n\t\t\t\t\t\tonremotestream : callbacks.onremotestream,\n\t\t\t\t\t\tondata : callbacks.ondata,\n\t\t\t\t\t\tondataopen : callbacks.ondataopen,\n\t\t\t\t\t\toncleanup : callbacks.oncleanup,\n\t\t\t\t\t\tondetached : callbacks.ondetached,\n\t\t\t\t\t\thangup : function(sendRequest) { cleanupWebrtc(handleId, sendRequest === true); },\n\t\t\t\t\t\tdetach : function(callbacks) { destroyHandle(handleId, callbacks); }\n\t\t\t\t\t}\n\t\t\t\tpluginHandles[handleId] = pluginHandle;\n\t\t\t\tcallbacks.success(pluginHandle);\n\t\t\t},\n\t\t\terror: function(XMLHttpRequest, textStatus, errorThrown) {\n\t\t\t\tJanus.error(textStatus + \": \" + errorThrown);\t// FIXME\n\t\t\t},\n\t\t\tdataType: \"json\"\n\t\t});\n\t}\n\n\t// Private method to send a message\n\tfunction sendMessage(handleId, callbacks) {\n\t\tcallbacks = callbacks || {};\n\t\tcallbacks.success = (typeof callbacks.success == \"function\") ? callbacks.success : jQuery.noop;\n\t\tcallbacks.error = (typeof callbacks.error == \"function\") ? callbacks.error : jQuery.noop;\n\t\tif(!connected) {\n\t\t\tJanus.warn(\"Is the gateway down? (connected=false)\");\n\t\t\tcallbacks.error(\"Is the gateway down? (connected=false)\");\n\t\t\treturn;\n\t\t}\n\t\tvar message = callbacks.message;\n\t\tvar jsep = callbacks.jsep;\n\t\tvar transaction = Janus.randomString(12);\n\t\tvar request = { \"janus\": \"message\", \"body\": message, \"transaction\": transaction };\n\t\tif(token !== null && token !== undefined)\n\t\t\trequest[\"token\"] = token;\n\t\tif(apisecret !== null && apisecret !== undefined)\n\t\t\trequest[\"apisecret\"] = apisecret;\n\t\tif(jsep !== null && jsep !== undefined)\n\t\t\trequest.jsep = jsep;\n\t\tJanus.debug(\"Sending message to plugin (handle=\" + handleId + \"):\");\n\t\tJanus.debug(request);\n\t\tif(websockets) {\n\t\t\trequest[\"session_id\"] = sessionId;\n\t\t\trequest[\"handle_id\"] = handleId;\n\t\t\ttransactions[transaction] = function(json) {\n\t\t\t\tJanus.debug(\"Message sent!\");\n\t\t\t\tJanus.debug(json);\n\t\t\t\tif(json[\"janus\"] === \"success\") {\n\t\t\t\t\t// We got a success, must have been a synchronous transaction\n\t\t\t\t\tvar plugindata = json[\"plugindata\"];\n\t\t\t\t\tif(plugindata === undefined || plugindata === null) {\n\t\t\t\t\t\tJanus.warn(\"Request succeeded, but missing plugindata...\");\n\t\t\t\t\t\tcallbacks.success();\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tJanus.log(\"Synchronous transaction successful (\" + plugindata[\"plugin\"] + \")\");\n\t\t\t\t\tvar data = plugindata[\"data\"];\n\t\t\t\t\tJanus.debug(data);\n\t\t\t\t\tcallbacks.success(data);\n\t\t\t\t\treturn;\n\t\t\t\t} else if(json[\"janus\"] !== \"ack\") {\n\t\t\t\t\t// Not a success and not an ack, must be an error\n\t\t\t\t\tif(json[\"error\"] !== undefined && json[\"error\"] !== null) {\n\t\t\t\t\t\tJanus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason);\t// FIXME\n\t\t\t\t\t\tcallbacks.error(json[\"error\"].code + \" \" + json[\"error\"].reason);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tJanus.error(\"Unknown error\");\t// FIXME\n\t\t\t\t\t\tcallbacks.error(\"Unknown error\");\n\t\t\t\t\t}\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t// If we got here, the plugin decided to handle the request asynchronously\n\t\t\t\tcallbacks.success();\n\t\t\t};\n\t\t\tws.send(JSON.stringify(request));\n\t\t\treturn;\n\t\t}\n\t\t$.ajax({\n\t\t\ttype: 'POST',\n\t\t\turl: server + \"/\" + sessionId + \"/\" + handleId,\n\t\t\txhrFields: {\n\t\t\t\twithCredentials: withCredentials\n\t\t\t},\n\t\t\tcache: false,\n\t\t\tcontentType: \"application/json\",\n\t\t\tdata: JSON.stringify(request),\n\t\t\tsuccess: function(json) {\n\t\t\t\tJanus.debug(\"Message sent!\");\n\t\t\t\tJanus.debug(json);\n\t\t\t\tif(json[\"janus\"] === \"success\") {\n\t\t\t\t\t// We got a success, must have been a synchronous transaction\n\t\t\t\t\tvar plugindata = json[\"plugindata\"];\n\t\t\t\t\tif(plugindata === undefined || plugindata === null) {\n\t\t\t\t\t\tJanus.warn(\"Request succeeded, but missing plugindata...\");\n\t\t\t\t\t\tcallbacks.success();\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tJanus.log(\"Synchronous transaction successful (\" + plugindata[\"plugin\"] + \")\");\n\t\t\t\t\tvar data = plugindata[\"data\"];\n\t\t\t\t\tJanus.debug(data);\n\t\t\t\t\tcallbacks.success(data);\n\t\t\t\t\treturn;\n\t\t\t\t} else if(json[\"janus\"] !== \"ack\") {\n\t\t\t\t\t// Not a success and not an ack, must be an error\n\t\t\t\t\tif(json[\"error\"] !== undefined && json[\"error\"] !== null) {\n\t\t\t\t\t\tJanus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason);\t// FIXME\n\t\t\t\t\t\tcallbacks.error(json[\"error\"].code + \" \" + json[\"error\"].reason);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tJanus.error(\"Unknown error\");\t// FIXME\n\t\t\t\t\t\tcallbacks.error(\"Unknown error\");\n\t\t\t\t\t}\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t// If we got here, the plugin decided to handle the request asynchronously\n\t\t\t\tcallbacks.success();\n\t\t\t},\n\t\t\terror: function(XMLHttpRequest, textStatus, errorThrown) {\n\t\t\t\tJanus.error(textStatus + \": \" + errorThrown);\t// FIXME\n\t\t\t\tcallbacks.error(textStatus + \": \" + errorThrown);\n\t\t\t},\n\t\t\tdataType: \"json\"\n\t\t});\n\t}\n\n\t// Private method to send a trickle candidate\n\tfunction sendTrickleCandidate(handleId, candidate) {\n\t\tif(!connected) {\n\t\t\tJanus.warn(\"Is the gateway down? (connected=false)\");\n\t\t\treturn;\n\t\t}\n\t\tvar request = { \"janus\": \"trickle\", \"candidate\": candidate, \"transaction\": Janus.randomString(12) };\n\t\tif(token !== null && token !== undefined)\n\t\t\trequest[\"token\"] = token;\n\t\tif(apisecret !== null && apisecret !== undefined)\n\t\t\trequest[\"apisecret\"] = apisecret;\n\t\tJanus.vdebug(\"Sending trickle candidate (handle=\" + handleId + \"):\");\n\t\tJanus.vdebug(request);\n\t\tif(websockets) {\n\t\t\trequest[\"session_id\"] = sessionId;\n\t\t\trequest[\"handle_id\"] = handleId;\n\t\t\tws.send(JSON.stringify(request));\n\t\t\treturn;\n\t\t}\n\t\t$.ajax({\n\t\t\ttype: 'POST',\n\t\t\turl: server + \"/\" + sessionId + \"/\" + handleId,\n\t\t\txhrFields: {\n\t\t\t\twithCredentials: withCredentials\n\t\t\t},\n\t\t\tcache: false,\n\t\t\tcontentType: \"application/json\",\n\t\t\tdata: JSON.stringify(request),\n\t\t\tsuccess: function(json) {\n\t\t\t\tJanus.vdebug(\"Candidate sent!\");\n\t\t\t\tJanus.vdebug(json);\n\t\t\t\tif(json[\"janus\"] !== \"ack\") {\n\t\t\t\t\tJanus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason);\t// FIXME\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t},\n\t\t\terror: function(XMLHttpRequest, textStatus, errorThrown) {\n\t\t\t\tJanus.error(textStatus + \": \" + errorThrown);\t// FIXME\n\t\t\t},\n\t\t\tdataType: \"json\"\n\t\t});\n\t}\n\n\t// Private method to send a data channel message\n\tfunction sendData(handleId, callbacks) {\n\t\tcallbacks = callbacks || {};\n\t\tcallbacks.success = (typeof callbacks.success == \"function\") ? callbacks.success : jQuery.noop;\n\t\tcallbacks.error = (typeof callbacks.error == \"function\") ? callbacks.error : jQuery.noop;\n\t\tvar pluginHandle = pluginHandles[handleId];\n\t\tif(pluginHandle === null || pluginHandle === undefined ||\n\t\t\t\tpluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n\t\t\tJanus.warn(\"Invalid handle\");\n\t\t\tcallbacks.error(\"Invalid handle\");\n\t\t\treturn;\n\t\t}\n\t\tvar config = pluginHandle.webrtcStuff;\n\t\tvar text = callbacks.text;\n\t\tif(text === null || text === undefined) {\n\t\t\tJanus.warn(\"Invalid text\");\n\t\t\tcallbacks.error(\"Invalid text\");\n\t\t\treturn;\n\t\t}\n\t\tJanus.log(\"Sending string on data channel: \" + text);\n\t\tconfig.dataChannel.send(text);\n\t\tcallbacks.success();\n\t}\n\n\t// Private method to send a DTMF tone\n\tfunction sendDtmf(handleId, callbacks) {\n\t\tcallbacks = callbacks || {};\n\t\tcallbacks.success = (typeof callbacks.success == \"function\") ? callbacks.success : jQuery.noop;\n\t\tcallbacks.error = (typeof callbacks.error == \"function\") ? callbacks.error : jQuery.noop;\n\t\tvar pluginHandle = pluginHandles[handleId];\n\t\tif(pluginHandle === null || pluginHandle === undefined ||\n\t\t\t\tpluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n\t\t\tJanus.warn(\"Invalid handle\");\n\t\t\tcallbacks.error(\"Invalid handle\");\n\t\t\treturn;\n\t\t}\n\t\tvar config = pluginHandle.webrtcStuff;\n\t\tif(config.dtmfSender === null || config.dtmfSender === undefined) {\n\t\t\t// Create the DTMF sender, if possible\n\t\t\tif(config.myStream !== undefined && config.myStream !== null) {\n\t\t\t\tvar tracks = config.myStream.getAudioTracks();\n\t\t\t\tif(tracks !== null && tracks !== undefined && tracks.length > 0) {\n\t\t\t\t\tvar local_audio_track = tracks[0];\n\t\t\t\t\tconfig.dtmfSender = config.pc.createDTMFSender(local_audio_track);\n\t\t\t\t\tJanus.log(\"Created DTMF Sender\");\n\t\t\t\t\tconfig.dtmfSender.ontonechange = function(tone) { Janus.debug(\"Sent DTMF tone: \" + tone.tone); };\n\t\t\t\t}\n\t\t\t}\n\t\t\tif(config.dtmfSender === null || config.dtmfSender === undefined) {\n\t\t\t\tJanus.warn(\"Invalid DTMF configuration\");\n\t\t\t\tcallbacks.error(\"Invalid DTMF configuration\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\tvar dtmf = callbacks.dtmf;\n\t\tif(dtmf === null || dtmf === undefined) {\n\t\t\tJanus.warn(\"Invalid DTMF parameters\");\n\t\t\tcallbacks.error(\"Invalid DTMF parameters\");\n\t\t\treturn;\n\t\t}\n\t\tvar tones = dtmf.tones;\n\t\tif(tones === null || tones === undefined) {\n\t\t\tJanus.warn(\"Invalid DTMF string\");\n\t\t\tcallbacks.error(\"Invalid DTMF string\");\n\t\t\treturn;\n\t\t}\n\t\tvar duration = dtmf.duration;\n\t\tif(duration === null || duration === undefined)\n\t\t\tduration = 500;\t// We choose 500ms as the default duration for a tone\n\t\tvar gap = dtmf.gap;\n\t\tif(gap === null || gap === undefined)\n\t\t\tgap = 50;\t// We choose 50ms as the default gap between tones\n\t\tJanus.debug(\"Sending DTMF string \" + tones + \" (duration \" + duration + \"ms, gap \" + gap + \"ms)\");\n\t\tconfig.dtmfSender.insertDTMF(tones, duration, gap);\n\t}\n\n\t// Private method to destroy a plugin handle\n\tfunction destroyHandle(handleId, callbacks) {\n\t\tcallbacks = callbacks || {};\n\t\tcallbacks.success = (typeof callbacks.success == \"function\") ? callbacks.success : jQuery.noop;\n\t\tcallbacks.error = (typeof callbacks.error == \"function\") ? callbacks.error : jQuery.noop;\n\t\tJanus.warn(callbacks);\n\t\tvar asyncRequest = true;\n\t\tif(callbacks.asyncRequest !== undefined && callbacks.asyncRequest !== null)\n\t\t\tasyncRequest = (callbacks.asyncRequest === true);\n\t\tJanus.log(\"Destroying handle \" + handleId + \" (async=\" + asyncRequest + \")\");\n\t\tcleanupWebrtc(handleId);\n\t\tif (pluginHandles[handleId].detached) {\n\t\t\t// Plugin was already detached by Janus, calling detach again will return a handle not found error, so just exit here\n\t\t\tdelete pluginHandles[handleId];\n\t\t\tcallbacks.success();\n\t\t\treturn;\n\t\t}\n\t\tif(!connected) {\n\t\t\tJanus.warn(\"Is the gateway down? (connected=false)\");\n\t\t\tcallbacks.error(\"Is the gateway down? (connected=false)\");\n\t\t\treturn;\n\t\t}\n\t\tvar request = { \"janus\": \"detach\", \"transaction\": Janus.randomString(12) };\n\t\tif(token !== null && token !== undefined)\n\t\t\trequest[\"token\"] = token;\n\t\tif(apisecret !== null && apisecret !== undefined)\n\t\t\trequest[\"apisecret\"] = apisecret;\n\t\tif(websockets) {\n\t\t\trequest[\"session_id\"] = sessionId;\n\t\t\trequest[\"handle_id\"] = handleId;\n\t\t\tws.send(JSON.stringify(request));\n\t\t\tdelete pluginHandles[handleId];\n\t\t\tcallbacks.success();\n\t\t\treturn;\n\t\t}\n\t\t$.ajax({\n\t\t\ttype: 'POST',\n\t\t\turl: server + \"/\" + sessionId + \"/\" + handleId,\n\t\t\tasync: asyncRequest,\t// Sometimes we need false here, or destroying in onbeforeunload won't work\n\t\t\txhrFields: {\n\t\t\t\twithCredentials: withCredentials\n\t\t\t},\n\t\t\tcache: false,\n\t\t\tcontentType: \"application/json\",\n\t\t\tdata: JSON.stringify(request),\n\t\t\tsuccess: function(json) {\n\t\t\t\tJanus.log(\"Destroyed handle:\");\n\t\t\t\tJanus.debug(json);\n\t\t\t\tif(json[\"janus\"] !== \"success\") {\n\t\t\t\t\tJanus.error(\"Ooops: \" + json[\"error\"].code + \" \" + json[\"error\"].reason);\t// FIXME\n\t\t\t\t}\n\t\t\t\tdelete pluginHandles[handleId];\n\t\t\t\tcallbacks.success();\n\t\t\t},\n\t\t\terror: function(XMLHttpRequest, textStatus, errorThrown) {\n\t\t\t\tJanus.error(textStatus + \": \" + errorThrown);\t// FIXME\n\t\t\t\t// We cleanup anyway\n\t\t\t\tdelete pluginHandles[handleId];\n\t\t\t\tcallbacks.success();\n\t\t\t},\n\t\t\tdataType: \"json\"\n\t\t});\n\t}\n\n\t// WebRTC stuff\n\tfunction streamsDone(handleId, jsep, media, callbacks, stream) {\n\t\tvar pluginHandle = pluginHandles[handleId];\n\t\tif(pluginHandle === null || pluginHandle === undefined ||\n\t\t\t\tpluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n\t\t\tJanus.warn(\"Invalid handle\");\n\t\t\tcallbacks.error(\"Invalid handle\");\n\t\t\treturn;\n\t\t}\n\t\tvar config = pluginHandle.webrtcStuff;\n\t\tJanus.debug(\"streamsDone:\", stream);\n\t\tconfig.myStream = stream;\n\t\tvar pc_config = {\"iceServers\": iceServers, \"iceTransportPolicy\": iceTransportPolicy};\n\t\t//~ var pc_constraints = {'mandatory': {'MozDontOfferDataChannel':true}};\n\t\tvar pc_constraints = {\n\t\t\t\"optional\": [{\"DtlsSrtpKeyAgreement\": true}]\n\t\t};\n\t\tif(ipv6Support === true) {\n\t\t\t// FIXME This is only supported in Chrome right now\n\t\t\t// For support in Firefox track this: https://bugzilla.mozilla.org/show_bug.cgi?id=797262\n\t\t\tpc_constraints.optional.push({\"googIPv6\":true});\n\t\t}\n\t\tif(adapter.browserDetails.browser === \"edge\") {\n\t\t\t// This is Edge, enable BUNDLE explicitly\n\t\t\tpc_config.bundlePolicy = \"max-bundle\";\n\t\t}\n\t\tJanus.log(\"Creating PeerConnection\");\n\t\tJanus.debug(pc_constraints);\n\t\tconfig.pc = new RTCPeerConnection(pc_config, pc_constraints);\n\t\tJanus.debug(config.pc);\n\t\tif(config.pc.getStats) {\t// FIXME\n\t\t\tconfig.volume.value = 0;\n\t\t\tconfig.bitrate.value = \"0 kbits/sec\";\n\t\t}\n\t\tJanus.log(\"Preparing local SDP and gathering candidates (trickle=\" + config.trickle + \")\");\n\t\tconfig.pc.oniceconnectionstatechange = function(e) {\n\t\t\tif(config.pc)\n\t\t\t\tpluginHandle.iceState(config.pc.iceConnectionState);\n\t\t};\n\t\tconfig.pc.onicecandidate = function(event) {\n\t\t\tif (event.candidate == null ||\n\t\t\t\t\t(adapter.browserDetails.browser === 'edge' && event.candidate.candidate.indexOf('endOfCandidates') > 0)) {\n\t\t\t\tJanus.log(\"End of candidates.\");\n\t\t\t\tconfig.iceDone = true;\n\t\t\t\tif(config.trickle === true) {\n\t\t\t\t\t// Notify end of candidates\n\t\t\t\t\tsendTrickleCandidate(handleId, {\"completed\": true});\n\t\t\t\t} else {\n\t\t\t\t\t// No trickle, time to send the complete SDP (including all candidates)\n\t\t\t\t\tsendSDP(handleId, callbacks);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// JSON.stringify doesn't work on some WebRTC objects anymore\n\t\t\t\t// See https://code.google.com/p/chromium/issues/detail?id=467366\n\t\t\t\tvar candidate = {\n\t\t\t\t\t\"candidate\": event.candidate.candidate,\n\t\t\t\t\t\"sdpMid\": event.candidate.sdpMid,\n\t\t\t\t\t\"sdpMLineIndex\": event.candidate.sdpMLineIndex\n\t\t\t\t};\n\t\t\t\tif(config.trickle === true) {\n\t\t\t\t\t// Send candidate\n\t\t\t\t\tsendTrickleCandidate(handleId, candidate);\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t\tif(stream !== null && stream !== undefined) {\n\t\t\tJanus.log('Adding local stream');\n\t\t\tconfig.pc.addStream(stream);\n\t\t\tpluginHandle.onlocalstream(stream);\n\t\t}\n\t\tconfig.pc.onaddstream = function(remoteStream) {\n\t\t\tJanus.log(\"Handling Remote Stream\");\n\t\t\tJanus.debug(remoteStream);\n\t\t\tconfig.remoteStream = remoteStream;\n\t\t\tpluginHandle.onremotestream(remoteStream.stream);\n\t\t};\n\t\t// Any data channel to create?\n\t\tif(isDataEnabled(media)) {\n\t\t\tJanus.log(\"Creating data channel\");\n\t\t\tvar onDataChannelMessage = function(event) {\n\t\t\t\tJanus.log('Received message on data channel: ' + event.data);\n\t\t\t\tpluginHandle.ondata(event.data);\t// FIXME\n\t\t\t}\n\t\t\tvar onDataChannelStateChange = function() {\n\t\t\t\tvar dcState = config.dataChannel !== null ? config.dataChannel.readyState : \"null\";\n\t\t\t\tJanus.log('State change on data channel: ' + dcState);\n\t\t\t\tif(dcState === 'open') {\n\t\t\t\t\tpluginHandle.ondataopen();\t// FIXME\n\t\t\t\t}\n\t\t\t}\n\t\t\tvar onDataChannelError = function(error) {\n\t\t\t\tJanus.error('Got error on data channel:', error);\n\t\t\t\t// TODO\n\t\t\t}\n\t\t\t// Until we implement the proxying of open requests within the Janus core, we open a channel ourselves whatever the case\n\t\t\tconfig.dataChannel = config.pc.createDataChannel(\"JanusDataChannel\", {ordered:false});\t// FIXME Add options (ordered, maxRetransmits, etc.)\n\t\t\tconfig.dataChannel.onmessage = onDataChannelMessage;\n\t\t\tconfig.dataChannel.onopen = onDataChannelStateChange;\n\t\t\tconfig.dataChannel.onclose = onDataChannelStateChange;\n\t\t\tconfig.dataChannel.onerror = onDataChannelError;\n\t\t}\n\t\t// Create offer/answer now\n\t\tif(jsep === null || jsep === undefined) {\n\t\t\tcreateOffer(handleId, media, callbacks);\n\t\t} else {\n\t\t\tif(adapter.browserDetails.browser === \"edge\") {\n\t\t\t\t// This is Edge, add an a=end-of-candidates at the end\n\t\t\t\tjsep.sdp += \"a=end-of-candidates\\r\\n\";\n\t\t\t}\n\t\t\tconfig.pc.setRemoteDescription(\n\t\t\t\t\tnew RTCSessionDescription(jsep),\n\t\t\t\t\tfunction() {\n\t\t\t\t\t\tJanus.log(\"Remote description accepted!\");\n\t\t\t\t\t\tcreateAnswer(handleId, media, callbacks);\n\t\t\t\t\t}, callbacks.error);\n\t\t}\n\t}\n\n\tfunction prepareWebrtc(handleId, callbacks) {\n\t\tcallbacks = callbacks || {};\n\t\tcallbacks.success = (typeof callbacks.success == \"function\") ? callbacks.success : jQuery.noop;\n\t\tcallbacks.error = (typeof callbacks.error == \"function\") ? callbacks.error : webrtcError;\n\t\tvar jsep = callbacks.jsep;\n\t\tvar media = callbacks.media;\n\t\tvar pluginHandle = pluginHandles[handleId];\n\t\tif(pluginHandle === null || pluginHandle === undefined ||\n\t\t\t\tpluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n\t\t\tJanus.warn(\"Invalid handle\");\n\t\t\tcallbacks.error(\"Invalid handle\");\n\t\t\treturn;\n\t\t}\n\t\tvar config = pluginHandle.webrtcStuff;\n\t\t// Are we updating a session?\n\t\tif(config.pc !== undefined && config.pc !== null) {\n\t\t\tJanus.log(\"Updating existing media session\");\n\t\t\t// Create offer/answer now\n\t\t\tif(jsep === null || jsep === undefined) {\n\t\t\t\tcreateOffer(handleId, media, callbacks);\n\t\t\t} else {\n\t\t\t\tif(adapter.browserDetails.browser === \"edge\") {\n\t\t\t\t\t// This is Edge, add an a=end-of-candidates at the end\n\t\t\t\t\tjsep.sdp += \"a=end-of-candidates\\r\\n\";\n\t\t\t\t}\n\t\t\t\tconfig.pc.setRemoteDescription(\n\t\t\t\t\t\tnew RTCSessionDescription(jsep),\n\t\t\t\t\t\tfunction() {\n\t\t\t\t\t\t\tJanus.log(\"Remote description accepted!\");\n\t\t\t\t\t\t\tcreateAnswer(handleId, media, callbacks);\n\t\t\t\t\t\t}, callbacks.error);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\t\t// Was a MediaStream object passed, or do we need to take care of that?\n\t\tif(callbacks.stream !== null && callbacks.stream !== undefined) {\n\t\t\tvar stream = callbacks.stream;\n\t\t\tJanus.log(\"MediaStream provided by the application\");\n\t\t\tJanus.debug(stream);\n\t\t\t// Skip the getUserMedia part\n\t\t\tconfig.streamExternal = true;\n\t\t\tstreamsDone(handleId, jsep, media, callbacks, stream);\n\t\t\treturn;\n\t\t}\n\t\tconfig.trickle = isTrickleEnabled(callbacks.trickle);\n\t\tif(isAudioSendEnabled(media) || isVideoSendEnabled(media)) {\n\t\t\tvar constraints = { mandatory: {}, optional: []};\n\t\t\tpluginHandle.consentDialog(true);\n\t\t\tvar audioSupport = isAudioSendEnabled(media);\n\t\t\tif(audioSupport === true && media != undefined && media != null) {\n\t\t\t\tif(typeof media.audio === 'object') {\n\t\t\t\t\taudioSupport = media.audio;\n\t\t\t\t}\n\t\t\t}\n\t\t\tvar videoSupport = isVideoSendEnabled(media);\n\t\t\tif(videoSupport === true && media != undefined && media != null) {\n\t\t\t\tif(media.video && media.video != 'screen' && media.video != 'window') {\n\t\t\t\t\tvar width = 0;\n\t\t\t\t\tvar height = 0, maxHeight = 0;\n\t\t\t\t\tif(media.video === 'lowres') {\n\t\t\t\t\t\t// Small resolution, 4:3\n\t\t\t\t\t\theight = 240;\n\t\t\t\t\t\tmaxHeight = 240;\n\t\t\t\t\t\twidth = 320;\n\t\t\t\t\t} else if(media.video === 'lowres-16:9') {\n\t\t\t\t\t\t// Small resolution, 16:9\n\t\t\t\t\t\theight = 180;\n\t\t\t\t\t\tmaxHeight = 180;\n\t\t\t\t\t\twidth = 320;\n\t\t\t\t\t} else if(media.video === 'hires' || media.video === 'hires-16:9' ) {\n\t\t\t\t\t\t// High resolution is only 16:9\n\t\t\t\t\t\theight = 720;\n\t\t\t\t\t\tmaxHeight = 720;\n\t\t\t\t\t\twidth = 1280;\n\t\t\t\t\t\tif(navigator.mozGetUserMedia) {\n\t\t\t\t\t\t\tvar firefoxVer = parseInt(window.navigator.userAgent.match(/Firefox\\/(.*)/)[1], 10);\n\t\t\t\t\t\t\tif(firefoxVer < 38) {\n\t\t\t\t\t\t\t\t// Unless this is and old Firefox, which doesn't support it\n\t\t\t\t\t\t\t\tJanus.warn(media.video + \" unsupported, falling back to stdres (old Firefox)\");\n\t\t\t\t\t\t\t\theight = 480;\n\t\t\t\t\t\t\t\tmaxHeight = 480;\n\t\t\t\t\t\t\t\twidth  = 640;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if(media.video === 'stdres') {\n\t\t\t\t\t\t// Normal resolution, 4:3\n\t\t\t\t\t\theight = 480;\n\t\t\t\t\t\tmaxHeight = 480;\n\t\t\t\t\t\twidth  = 640;\n\t\t\t\t\t} else if(media.video === 'stdres-16:9') {\n\t\t\t\t\t\t// Normal resolution, 16:9\n\t\t\t\t\t\theight = 360;\n\t\t\t\t\t\tmaxHeight = 360;\n\t\t\t\t\t\twidth = 640;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tJanus.log(\"Default video setting (\" + media.video + \") is stdres 4:3\");\n\t\t\t\t\t\theight = 480;\n\t\t\t\t\t\tmaxHeight = 480;\n\t\t\t\t\t\twidth = 640;\n\t\t\t\t\t}\n\t\t\t\t\tJanus.log(\"Adding media constraint \" + media.video);\n\t\t\t\t\tif(navigator.mozGetUserMedia) {\n\t\t\t\t\t\tvar firefoxVer = parseInt(window.navigator.userAgent.match(/Firefox\\/(.*)/)[1], 10);\n\t\t\t\t\t\tif(firefoxVer < 38) {\n\t\t\t\t\t\t\tvideoSupport = {\n\t\t\t\t\t\t\t\t'require': ['height', 'width'],\n\t\t\t\t\t\t\t\t'height': {'max': maxHeight, 'min': height},\n\t\t\t\t\t\t\t\t'width':  {'max': width,  'min': width}\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// http://stackoverflow.com/questions/28282385/webrtc-firefox-constraints/28911694#28911694\n\t\t\t\t\t\t\t// https://github.com/meetecho/janus-gateway/pull/246\n\t\t\t\t\t\t\tvideoSupport = {\n\t\t\t\t\t\t\t\t'height': {'ideal': height},\n\t\t\t\t\t\t\t\t'width':  {'ideal': width}\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tvideoSupport = {\n\t\t\t\t\t\t    'mandatory': {\n\t\t\t\t\t\t        'maxHeight': maxHeight,\n\t\t\t\t\t\t        'minHeight': height,\n\t\t\t\t\t\t        'maxWidth':  width,\n\t\t\t\t\t\t        'minWidth':  width\n\t\t\t\t\t\t    },\n\t\t\t\t\t\t    'optional': []\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\t\t\t\t\tif(typeof media.video === 'object') {\n\t\t\t\t\t\tvideoSupport = media.video;\n\t\t\t\t\t}\n\t\t\t\t\tJanus.debug(videoSupport);\n\t\t\t\t} else if(media.video === 'screen' || media.video === 'window') {\n\t\t\t\t\tif (!media.screenshareFrameRate) {\n\t\t\t\t\t\tmedia.screenshareFrameRate = 3;\n\t\t\t\t\t}\n\t\t\t\t\t// Not a webcam, but screen capture\n\t\t\t\t\tif(window.location.protocol !== 'https:') {\n\t\t\t\t\t\t// Screen sharing mandates HTTPS\n\t\t\t\t\t\tJanus.warn(\"Screen sharing only works on HTTPS, try the https:// version of this page\");\n\t\t\t\t\t\tpluginHandle.consentDialog(false);\n\t\t\t\t\t\tcallbacks.error(\"Screen sharing only works on HTTPS, try the https:// version of this page\");\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\t// We're going to try and use the extension for Chrome 34+, the old approach\n\t\t\t\t\t// for older versions of Chrome, or the experimental support in Firefox 33+\n\t\t\t\t\tvar cache = {};\n\t\t\t\t\tfunction callbackUserMedia (error, stream) {\n\t\t\t\t\t\tpluginHandle.consentDialog(false);\n\t\t\t\t\t\tif(error) {\n\t\t\t\t\t\t\tcallbacks.error({code: error.code, name: error.name, message: error.message});\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tstreamsDone(handleId, jsep, media, callbacks, stream);\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t\tfunction getScreenMedia(constraints, gsmCallback, useAudio) {\n\t\t\t\t\t\tJanus.log(\"Adding media constraint (screen capture)\");\n\t\t\t\t\t\tJanus.debug(constraints);\n\t\t\t\t\t\tnavigator.mediaDevices.getUserMedia(constraints)\n\t\t\t\t\t\t\t.then(function(stream) { \n\t\t\t\t\t\t\t\tif(useAudio){\n\t\t\t\t\t\t\t\t\tnavigator.mediaDevices.getUserMedia({ audio: true, video: false })\n\t\t\t\t\t\t\t\t\t.then(function (audioStream) {\n\t\t\t\t\t\t\t\t\t\tstream.addTrack(audioStream.getAudioTracks()[0]);\n\t\t\t\t\t\t\t\t\t\tgsmCallback(null, stream);\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tgsmCallback(null, stream);\n\t\t\t\t\t\t\t\t} \n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.catch(function(error) { pluginHandle.consentDialog(false); gsmCallback(error); });\n\t\t\t\t\t};\n\t\t\t\t\tif(adapter.browserDetails.browser === 'chrome') {\n\t\t\t\t\t\tvar chromever = adapter.browserDetails.version;\n\t\t\t\t\t\tvar maxver = 33;\n\t\t\t\t\t\tif(window.navigator.userAgent.match('Linux'))\n\t\t\t\t\t\t\tmaxver = 35;\t// \"known\" crash in chrome 34 and 35 on linux\n\t\t\t\t\t\tif(chromever >= 26 && chromever <= maxver) {\n\t\t\t\t\t\t\t// Chrome 26->33 requires some awkward chrome://flags manipulation\n\t\t\t\t\t\t\tconstraints = {\n\t\t\t\t\t\t\t\tvideo: {\n\t\t\t\t\t\t\t\t\tmandatory: {\n\t\t\t\t\t\t\t\t\t\tgoogLeakyBucket: true,\n\t\t\t\t\t\t\t\t\t\tmaxWidth: window.screen.width,\n\t\t\t\t\t\t\t\t\t\tmaxHeight: window.screen.height,\n\t\t\t\t\t\t\t\t\t\tminFrameRate: media.screenshareFrameRate,\n\t\t\t\t\t\t\t\t\t\tmaxFrameRate: media.screenshareFrameRate,\n\t\t\t\t\t\t\t\t\t\tchromeMediaSource: 'screen'\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\taudio: isAudioSendEnabled(media)\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\tgetScreenMedia(constraints, callbackUserMedia);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// Chrome 34+ requires an extension\n\t\t\t\t\t\t\tvar pending = window.setTimeout(\n\t\t\t\t\t\t\t\tfunction () {\n\t\t\t\t\t\t\t\t\terror = new Error('NavigatorUserMediaError');\n\t\t\t\t\t\t\t\t\terror.name = 'The required Chrome extension is not installed: click <a href=\"#\">here</a> to install it. (NOTE: this will need you to refresh the page)';\n\t\t\t\t\t\t\t\t\tpluginHandle.consentDialog(false);\n\t\t\t\t\t\t\t\t\treturn callbacks.error(error);\n\t\t\t\t\t\t\t\t}, 1000);\n\t\t\t\t\t\t\tcache[pending] = [callbackUserMedia, null];\n\t\t\t\t\t\t\twindow.postMessage({ type: 'janusGetScreen', id: pending }, '*');\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if (window.navigator.userAgent.match('Firefox')) {\n\t\t\t\t\t\tvar ffver = parseInt(window.navigator.userAgent.match(/Firefox\\/(.*)/)[1], 10);\n\t\t\t\t\t\tif(ffver >= 33) {\n\t\t\t\t\t\t\t// Firefox 33+ has experimental support for screen sharing\n\t\t\t\t\t\t\tconstraints = {\n\t\t\t\t\t\t\t\tvideo: {\n\t\t\t\t\t\t\t\t\tmozMediaSource: media.video,\n\t\t\t\t\t\t\t\t\tmediaSource: media.video\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\taudio: isAudioSendEnabled(media)\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\tgetScreenMedia(constraints, function (err, stream) {\n\t\t\t\t\t\t\t\tcallbackUserMedia(err, stream);\n\t\t\t\t\t\t\t\t// Workaround for https://bugzilla.mozilla.org/show_bug.cgi?id=1045810\n\t\t\t\t\t\t\t\tif (!err) {\n\t\t\t\t\t\t\t\t\tvar lastTime = stream.currentTime;\n\t\t\t\t\t\t\t\t\tvar polly = window.setInterval(function () {\n\t\t\t\t\t\t\t\t\t\tif(!stream)\n\t\t\t\t\t\t\t\t\t\t\twindow.clearInterval(polly);\n\t\t\t\t\t\t\t\t\t\tif(stream.currentTime == lastTime) {\n\t\t\t\t\t\t\t\t\t\t\twindow.clearInterval(polly);\n\t\t\t\t\t\t\t\t\t\t\tif(stream.onended) {\n\t\t\t\t\t\t\t\t\t\t\t\tstream.onended();\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\tlastTime = stream.currentTime;\n\t\t\t\t\t\t\t\t\t}, 500);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tvar error = new Error('NavigatorUserMediaError');\n\t\t\t\t\t\t\terror.name = 'Your version of Firefox does not support screen sharing, please install Firefox 33 (or more recent versions)';\n\t\t\t\t\t\t\tpluginHandle.consentDialog(false);\n\t\t\t\t\t\t\tcallbacks.error(error);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// Wait for events from the Chrome Extension\n\t\t\t\t\twindow.addEventListener('message', function (event) {\n\t\t\t\t\t\tif(event.origin != window.location.origin)\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\tif(event.data.type == 'janusGotScreen' && cache[event.data.id]) {\n\t\t\t\t\t\t\tvar data = cache[event.data.id];\n\t\t\t\t\t\t\tvar callback = data[0];\n\t\t\t\t\t\t\tdelete cache[event.data.id];\n\n\t\t\t\t\t\t\tif (event.data.sourceId === '') {\n\t\t\t\t\t\t\t\t// user canceled\n\t\t\t\t\t\t\t\tvar error = new Error('NavigatorUserMediaError');\n\t\t\t\t\t\t\t\terror.name = 'You cancelled the request for permission, giving up...';\n\t\t\t\t\t\t\t\tpluginHandle.consentDialog(false);\n\t\t\t\t\t\t\t\tcallbacks.error(error);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tconstraints = {\n\t\t\t\t\t\t\t\t\taudio: false,\n\t\t\t\t\t\t\t\t\tvideo: {\n\t\t\t\t\t\t\t\t\t\tmandatory: {\n\t\t\t\t\t\t\t\t\t\t\tchromeMediaSource: 'desktop',\n\t\t\t\t\t\t\t\t\t\t\tmaxWidth: window.screen.width,\n\t\t\t\t\t\t\t\t\t\t\tmaxHeight: window.screen.height,\n\t\t\t\t\t\t\t\t\t\t\tminFrameRate: media.screenshareFrameRate,\n\t\t\t\t\t\t\t\t\t\t\tmaxFrameRate: media.screenshareFrameRate,\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\toptional: [\n\t\t\t\t\t\t\t\t\t\t\t{googLeakyBucket: true},\n\t\t\t\t\t\t\t\t\t\t\t{googTemporalLayeredScreencast: true}\n\t\t\t\t\t\t\t\t\t\t]\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\tconstraints.video.mandatory.chromeMediaSourceId = event.data.sourceId;\n\t\t\t\t\t\t\t\tgetScreenMedia(constraints, callback, isAudioSendEnabled(media));\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if (event.data.type == 'janusGetScreenPending') {\n\t\t\t\t\t\t\twindow.clearTimeout(event.data.id);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\t// If we got here, we're not screensharing\n\t\t\tif(media === null || media === undefined || media.video !== 'screen') {\n\t\t\t\t// Check whether all media sources are actually available or not\n\t\t\t\tnavigator.mediaDevices.enumerateDevices().then(function(devices) {\n\t\t\t\t\tvar audioExist = devices.some(function(device) {\n\t\t\t\t\t\treturn device.kind === 'audioinput';\n\t\t\t\t\t}),\n\t\t\t\t\tvideoExist = devices.some(function(device) {\n\t\t\t\t\t\treturn device.kind === 'videoinput';\n\t\t\t\t\t});\n\n\t\t\t\t\t// Check whether a missing device is really a problem\n\t\t\t\t\tvar audioSend = isAudioSendEnabled(media);\n\t\t\t\t\tvar videoSend = isVideoSendEnabled(media);\n\t\t\t\t\tvar needAudioDevice = isAudioSendRequired(media);\n\t\t\t\t\tvar needVideoDevice = isVideoSendRequired(media);\n\t\t\t\t\tif(audioSend || videoSend || needAudioDevice || needVideoDevice) {\n\t\t\t\t\t\t// We need to send either audio or video\n\t\t\t\t\t\tvar haveAudioDevice = audioSend ? audioExist : false;\n\t\t\t\t\t\tvar haveVideoDevice = videoSend ? videoExist : false;\n\t\t\t\t\t\tif(!haveAudioDevice && !haveVideoDevice) {\n\t\t\t\t\t\t\t// FIXME Should we really give up, or just assume recvonly for both?\n\t\t\t\t\t\t\tpluginHandle.consentDialog(false);\n\t\t\t\t\t\t\tcallbacks.error('No capture device found');\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t} else if(!haveAudioDevice && needAudioDevice) {\n\t\t\t\t\t\t\tpluginHandle.consentDialog(false);\n\t\t\t\t\t\t\tcallbacks.error('Audio capture is required, but no capture device found');\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t} else if(!haveVideoDevice && needVideoDevice) {\n\t\t\t\t\t\t\tpluginHandle.consentDialog(false);\n\t\t\t\t\t\t\tcallbacks.error('Video capture is required, but no capture device found');\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tnavigator.mediaDevices.getUserMedia({\n\t\t\t\t\t\taudio: audioExist ? audioSupport : false,\n\t\t\t\t\t\tvideo: videoExist ? videoSupport : false\n\t\t\t\t\t})\n\t\t\t\t\t.then(function(stream) { pluginHandle.consentDialog(false); streamsDone(handleId, jsep, media, callbacks, stream); })\n\t\t\t\t\t.catch(function(error) { pluginHandle.consentDialog(false); callbacks.error({code: error.code, name: error.name, message: error.message}); });\n\t\t\t\t})\n\t\t\t\t.catch(function(error) {\n\t\t\t\t\tpluginHandle.consentDialog(false);\n\t\t\t\t\tcallbacks.error('enumerateDevices error', error);\n\t\t\t\t});\n\t\t\t}\n\t\t} else {\n\t\t\t// No need to do a getUserMedia, create offer/answer right away\n\t\t\tstreamsDone(handleId, jsep, media, callbacks);\n\t\t}\n\t}\n\n\tfunction prepareWebrtcPeer(handleId, callbacks) {\n\t\tcallbacks = callbacks || {};\n\t\tcallbacks.success = (typeof callbacks.success == \"function\") ? callbacks.success : jQuery.noop;\n\t\tcallbacks.error = (typeof callbacks.error == \"function\") ? callbacks.error : webrtcError;\n\t\tvar jsep = callbacks.jsep;\n\t\tvar pluginHandle = pluginHandles[handleId];\n\t\tif(pluginHandle === null || pluginHandle === undefined ||\n\t\t\t\tpluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n\t\t\tJanus.warn(\"Invalid handle\");\n\t\t\tcallbacks.error(\"Invalid handle\");\n\t\t\treturn;\n\t\t}\n\t\tvar config = pluginHandle.webrtcStuff;\n\t\tif(jsep !== undefined && jsep !== null) {\n\t\t\tif(config.pc === null) {\n\t\t\t\tJanus.warn(\"Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep\");\n\t\t\t\tcallbacks.error(\"No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif(adapter.browserDetails.browser === \"edge\") {\n\t\t\t\t// This is Edge, add an a=end-of-candidates at the end\n\t\t\t\tjsep.sdp += \"a=end-of-candidates\\r\\n\";\n\t\t\t}\n\t\t\tconfig.pc.setRemoteDescription(\n\t\t\t\t\tnew RTCSessionDescription(jsep),\n\t\t\t\t\tfunction() {\n\t\t\t\t\t\tJanus.log(\"Remote description accepted!\");\n\t\t\t\t\t\tcallbacks.success();\n\t\t\t\t\t}, callbacks.error);\n\t\t} else {\n\t\t\tcallbacks.error(\"Invalid JSEP\");\n\t\t}\n\t}\n\n\tfunction createOffer(handleId, media, callbacks) {\n\t\tcallbacks = callbacks || {};\n\t\tcallbacks.success = (typeof callbacks.success == \"function\") ? callbacks.success : jQuery.noop;\n\t\tcallbacks.error = (typeof callbacks.error == \"function\") ? callbacks.error : jQuery.noop;\n\t\tvar pluginHandle = pluginHandles[handleId];\n\t\tif(pluginHandle === null || pluginHandle === undefined ||\n\t\t\t\tpluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n\t\t\tJanus.warn(\"Invalid handle\");\n\t\t\tcallbacks.error(\"Invalid handle\");\n\t\t\treturn;\n\t\t}\n\t\tvar config = pluginHandle.webrtcStuff;\n\t\tJanus.log(\"Creating offer (iceDone=\" + config.iceDone + \")\");\n\t\t// https://code.google.com/p/webrtc/issues/detail?id=3508\n\t\tvar mediaConstraints = null;\n\t\tif(adapter.browserDetails.browser == \"firefox\" || adapter.browserDetails.browser == \"edge\") {\n\t\t\tmediaConstraints = {\n\t\t\t\t'offerToReceiveAudio':isAudioRecvEnabled(media),\n\t\t\t\t'offerToReceiveVideo':isVideoRecvEnabled(media)\n\t\t\t};\n\t\t} else {\n\t\t\tmediaConstraints = {\n\t\t\t\t'mandatory': {\n\t\t\t\t\t'OfferToReceiveAudio':isAudioRecvEnabled(media),\n\t\t\t\t\t'OfferToReceiveVideo':isVideoRecvEnabled(media)\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t\tJanus.debug(mediaConstraints);\n\t\tconfig.pc.createOffer(\n\t\t\tfunction(offer) {\n\t\t\t\tJanus.debug(offer);\n\t\t\t\tif(config.mySdp === null || config.mySdp === undefined) {\n\t\t\t\t\tJanus.log(\"Setting local description\");\n\t\t\t\t\tconfig.mySdp = offer.sdp;\n\t\t\t\t\tconfig.pc.setLocalDescription(offer);\n\t\t\t\t}\n\t\t\t\tif(!config.iceDone && !config.trickle) {\n\t\t\t\t\t// Don't do anything until we have all candidates\n\t\t\t\t\tJanus.log(\"Waiting for all candidates...\");\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tif(config.sdpSent) {\n\t\t\t\t\tJanus.log(\"Offer already sent, not sending it again\");\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tJanus.log(\"Offer ready\");\n\t\t\t\tJanus.debug(callbacks);\n\t\t\t\tconfig.sdpSent = true;\n\t\t\t\t// JSON.stringify doesn't work on some WebRTC objects anymore\n\t\t\t\t// See https://code.google.com/p/chromium/issues/detail?id=467366\n\t\t\t\tvar jsep = {\n\t\t\t\t\t\"type\": offer.type,\n\t\t\t\t\t\"sdp\": offer.sdp\n\t\t\t\t};\n\t\t\t\tcallbacks.success(jsep);\n\t\t\t}, callbacks.error, mediaConstraints);\n\t}\n\n\tfunction createAnswer(handleId, media, callbacks) {\n\t\tcallbacks = callbacks || {};\n\t\tcallbacks.success = (typeof callbacks.success == \"function\") ? callbacks.success : jQuery.noop;\n\t\tcallbacks.error = (typeof callbacks.error == \"function\") ? callbacks.error : jQuery.noop;\n\t\tvar pluginHandle = pluginHandles[handleId];\n\t\tif(pluginHandle === null || pluginHandle === undefined ||\n\t\t\t\tpluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n\t\t\tJanus.warn(\"Invalid handle\");\n\t\t\tcallbacks.error(\"Invalid handle\");\n\t\t\treturn;\n\t\t}\n\t\tvar config = pluginHandle.webrtcStuff;\n\t\tJanus.log(\"Creating answer (iceDone=\" + config.iceDone + \")\");\n\t\tvar mediaConstraints = null;\n\t\tif(adapter.browserDetails.browser == \"firefox\" || adapter.browserDetails.browser == \"edge\") {\n\t\t\tmediaConstraints = {\n\t\t\t\t'offerToReceiveAudio':isAudioRecvEnabled(media),\n\t\t\t\t'offerToReceiveVideo':isVideoRecvEnabled(media)\n\t\t\t};\n\t\t} else {\n\t\t\tmediaConstraints = {\n\t\t\t\t'mandatory': {\n\t\t\t\t\t'OfferToReceiveAudio':isAudioRecvEnabled(media),\n\t\t\t\t\t'OfferToReceiveVideo':isVideoRecvEnabled(media)\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t\tJanus.debug(mediaConstraints);\n\t\tconfig.pc.createAnswer(\n\t\t\tfunction(answer) {\n\t\t\t\tJanus.debug(answer);\n\t\t\t\tif(config.mySdp === null || config.mySdp === undefined) {\n\t\t\t\t\tJanus.log(\"Setting local description\");\n\t\t\t\t\tconfig.mySdp = answer.sdp;\n\t\t\t\t\tconfig.pc.setLocalDescription(answer);\n\t\t\t\t}\n\t\t\t\tif(!config.iceDone && !config.trickle) {\n\t\t\t\t\t// Don't do anything until we have all candidates\n\t\t\t\t\tJanus.log(\"Waiting for all candidates...\");\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tif(config.sdpSent) {\t// FIXME badly\n\t\t\t\t\tJanus.log(\"Answer already sent, not sending it again\");\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tconfig.sdpSent = true;\n\t\t\t\t// JSON.stringify doesn't work on some WebRTC objects anymore\n\t\t\t\t// See https://code.google.com/p/chromium/issues/detail?id=467366\n\t\t\t\tvar jsep = {\n\t\t\t\t\t\"type\": answer.type,\n\t\t\t\t\t\"sdp\": answer.sdp\n\t\t\t\t};\n\t\t\t\tcallbacks.success(jsep);\n\t\t\t}, callbacks.error, mediaConstraints);\n\t}\n\n\tfunction sendSDP(handleId, callbacks) {\n\t\tcallbacks = callbacks || {};\n\t\tcallbacks.success = (typeof callbacks.success == \"function\") ? callbacks.success : jQuery.noop;\n\t\tcallbacks.error = (typeof callbacks.error == \"function\") ? callbacks.error : jQuery.noop;\n\t\tvar pluginHandle = pluginHandles[handleId];\n\t\tif(pluginHandle === null || pluginHandle === undefined ||\n\t\t\t\tpluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n\t\t\tJanus.warn(\"Invalid handle, not sending anything\");\n\t\t\treturn;\n\t\t}\n\t\tvar config = pluginHandle.webrtcStuff;\n\t\tJanus.log(\"Sending offer/answer SDP...\");\n\t\tif(config.mySdp === null || config.mySdp === undefined) {\n\t\t\tJanus.warn(\"Local SDP instance is invalid, not sending anything...\");\n\t\t\treturn;\n\t\t}\n\t\tconfig.mySdp = {\n\t\t\t\"type\": config.pc.localDescription.type,\n\t\t\t\"sdp\": config.pc.localDescription.sdp\n\t\t};\n\t\tif(config.sdpSent) {\n\t\t\tJanus.log(\"Offer/Answer SDP already sent, not sending it again\");\n\t\t\treturn;\n\t\t}\n\t\tif(config.trickle === false)\n\t\t\tconfig.mySdp[\"trickle\"] = false;\n\t\tJanus.debug(callbacks);\n\t\tconfig.sdpSent = true;\n\t\tcallbacks.success(config.mySdp);\n\t}\n\n\tfunction getVolume(handleId) {\n\t\tvar pluginHandle = pluginHandles[handleId];\n\t\tif(pluginHandle === null || pluginHandle === undefined ||\n\t\t\t\tpluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n\t\t\tJanus.warn(\"Invalid handle\");\n\t\t\treturn 0;\n\t\t}\n\t\tvar config = pluginHandle.webrtcStuff;\n\t\t// Start getting the volume, if getStats is supported\n\t\tif(config.pc.getStats && adapter.browserDetails.browser == \"chrome\") {\t// FIXME\n\t\t\tif(config.remoteStream === null || config.remoteStream === undefined) {\n\t\t\t\tJanus.warn(\"Remote stream unavailable\");\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\t// http://webrtc.googlecode.com/svn/trunk/samples/js/demos/html/constraints-and-stats.html\n\t\t\tif(config.volume.timer === null || config.volume.timer === undefined) {\n\t\t\t\tJanus.log(\"Starting volume monitor\");\n\t\t\t\tconfig.volume.timer = setInterval(function() {\n\t\t\t\t\tconfig.pc.getStats(function(stats) {\n\t\t\t\t\t\tvar results = stats.result();\n\t\t\t\t\t\tfor(var i=0; i<results.length; i++) {\n\t\t\t\t\t\t\tvar res = results[i];\n\t\t\t\t\t\t\tif(res.type == 'ssrc' && res.stat('audioOutputLevel')) {\n\t\t\t\t\t\t\t\tconfig.volume.value = res.stat('audioOutputLevel');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}, 200);\n\t\t\t\treturn 0;\t// We don't have a volume to return yet\n\t\t\t}\n\t\t\treturn config.volume.value;\n\t\t} else {\n\t\t\tJanus.log(\"Getting the remote volume unsupported by browser\");\n\t\t\treturn 0;\n\t\t}\n\t}\n\n\tfunction isMuted(handleId, video) {\n\t\tvar pluginHandle = pluginHandles[handleId];\n\t\tif(pluginHandle === null || pluginHandle === undefined ||\n\t\t\t\tpluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n\t\t\tJanus.warn(\"Invalid handle\");\n\t\t\treturn true;\n\t\t}\n\t\tvar config = pluginHandle.webrtcStuff;\n\t\tif(config.pc === null || config.pc === undefined) {\n\t\t\tJanus.warn(\"Invalid PeerConnection\");\n\t\t\treturn true;\n\t\t}\n\t\tif(config.myStream === undefined || config.myStream === null) {\n\t\t\tJanus.warn(\"Invalid local MediaStream\");\n\t\t\treturn true;\n\t\t}\n\t\tif(video) {\n\t\t\t// Check video track\n\t\t\tif(config.myStream.getVideoTracks() === null\n\t\t\t\t\t|| config.myStream.getVideoTracks() === undefined\n\t\t\t\t\t|| config.myStream.getVideoTracks().length === 0) {\n\t\t\t\tJanus.warn(\"No video track\");\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\treturn !config.myStream.getVideoTracks()[0].enabled;\n\t\t} else {\n\t\t\t// Check audio track\n\t\t\tif(config.myStream.getAudioTracks() === null\n\t\t\t\t\t|| config.myStream.getAudioTracks() === undefined\n\t\t\t\t\t|| config.myStream.getAudioTracks().length === 0) {\n\t\t\t\tJanus.warn(\"No audio track\");\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\treturn !config.myStream.getAudioTracks()[0].enabled;\n\t\t}\n\t}\n\n\tfunction mute(handleId, video, mute) {\n\t\tvar pluginHandle = pluginHandles[handleId];\n\t\tif(pluginHandle === null || pluginHandle === undefined ||\n\t\t\t\tpluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n\t\t\tJanus.warn(\"Invalid handle\");\n\t\t\treturn false;\n\t\t}\n\t\tvar config = pluginHandle.webrtcStuff;\n\t\tif(config.pc === null || config.pc === undefined) {\n\t\t\tJanus.warn(\"Invalid PeerConnection\");\n\t\t\treturn false;\n\t\t}\n\t\tif(config.myStream === undefined || config.myStream === null) {\n\t\t\tJanus.warn(\"Invalid local MediaStream\");\n\t\t\treturn false;\n\t\t}\n\t\tif(video) {\n\t\t\t// Mute/unmute video track\n\t\t\tif(config.myStream.getVideoTracks() === null\n\t\t\t\t\t|| config.myStream.getVideoTracks() === undefined\n\t\t\t\t\t|| config.myStream.getVideoTracks().length === 0) {\n\t\t\t\tJanus.warn(\"No video track\");\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tconfig.myStream.getVideoTracks()[0].enabled = mute ? false : true;\n\t\t\treturn true;\n\t\t} else {\n\t\t\t// Mute/unmute audio track\n\t\t\tif(config.myStream.getAudioTracks() === null\n\t\t\t\t\t|| config.myStream.getAudioTracks() === undefined\n\t\t\t\t\t|| config.myStream.getAudioTracks().length === 0) {\n\t\t\t\tJanus.warn(\"No audio track\");\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tconfig.myStream.getAudioTracks()[0].enabled = mute ? false : true;\n\t\t\treturn true;\n\t\t}\n\t}\n\n\tfunction getBitrate(handleId) {\n\t\tvar pluginHandle = pluginHandles[handleId];\n\t\tif(pluginHandle === null || pluginHandle === undefined ||\n\t\t\t\tpluginHandle.webrtcStuff === null || pluginHandle.webrtcStuff === undefined) {\n\t\t\tJanus.warn(\"Invalid handle\");\n\t\t\treturn \"Invalid handle\";\n\t\t}\n\t\tvar config = pluginHandle.webrtcStuff;\n\t\tif(config.pc === null || config.pc === undefined)\n\t\t\treturn \"Invalid PeerConnection\";\n\t\t// Start getting the bitrate, if getStats is supported\n\t\tif(config.pc.getStats && adapter.browserDetails.browser == \"chrome\") {\n\t\t\t// Do it the Chrome way\n\t\t\tif(config.remoteStream === null || config.remoteStream === undefined) {\n\t\t\t\tJanus.warn(\"Remote stream unavailable\");\n\t\t\t\treturn \"Remote stream unavailable\";\n\t\t\t}\n\t\t\t// http://webrtc.googlecode.com/svn/trunk/samples/js/demos/html/constraints-and-stats.html\n\t\t\tif(config.bitrate.timer === null || config.bitrate.timer === undefined) {\n\t\t\t\tJanus.log(\"Starting bitrate timer (Chrome)\");\n\t\t\t\tconfig.bitrate.timer = setInterval(function() {\n\t\t\t\t\tconfig.pc.getStats(function(stats) {\n\t\t\t\t\t\tvar results = stats.result();\n\t\t\t\t\t\tfor(var i=0; i<results.length; i++) {\n\t\t\t\t\t\t\tvar res = results[i];\n\t\t\t\t\t\t\tif(res.type == 'ssrc' && res.stat('googFrameHeightReceived')) {\n\t\t\t\t\t\t\t\tconfig.bitrate.bsnow = res.stat('bytesReceived');\n\t\t\t\t\t\t\t\tconfig.bitrate.tsnow = res.timestamp;\n\t\t\t\t\t\t\t\tif(config.bitrate.bsbefore === null || config.bitrate.tsbefore === null) {\n\t\t\t\t\t\t\t\t\t// Skip this round\n\t\t\t\t\t\t\t\t\tconfig.bitrate.bsbefore = config.bitrate.bsnow;\n\t\t\t\t\t\t\t\t\tconfig.bitrate.tsbefore = config.bitrate.tsnow;\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t// Calculate bitrate\n\t\t\t\t\t\t\t\t\tvar bitRate = Math.round((config.bitrate.bsnow - config.bitrate.bsbefore) * 8 / (config.bitrate.tsnow - config.bitrate.tsbefore));\n\t\t\t\t\t\t\t\t\tconfig.bitrate.value = bitRate + ' kbits/sec';\n\t\t\t\t\t\t\t\t\t//~ Janus.log(\"Estimated bitrate is \" + config.bitrate.value);\n\t\t\t\t\t\t\t\t\tconfig.bitrate.bsbefore = config.bitrate.bsnow;\n\t\t\t\t\t\t\t\t\tconfig.bitrate.tsbefore = config.bitrate.tsnow;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}, 1000);\n\t\t\t\treturn \"0 kbits/sec\";\t// We don't have a bitrate value yet\n\t\t\t}\n\t\t\treturn config.bitrate.value;\n\t\t} else if(config.pc.getStats && adapter.browserDetails.browser == \"firefox\") {\n\t\t\t// Do it the Firefox way\n\t\t\tif(config.remoteStream === null || config.remoteStream === undefined\n\t\t\t\t\t|| config.remoteStream.streams[0] === null || config.remoteStream.streams[0] === undefined) {\n\t\t\t\tJanus.warn(\"Remote stream unavailable\");\n\t\t\t\treturn \"Remote stream unavailable\";\n\t\t\t}\n\t\t\tvar videoTracks = config.remoteStream.streams[0].getVideoTracks();\n\t\t\tif(videoTracks === null || videoTracks === undefined || videoTracks.length < 1) {\n\t\t\t\tJanus.warn(\"No video track\");\n\t\t\t\treturn \"No video track\";\n\t\t\t}\n\t\t\t// https://github.com/muaz-khan/getStats/blob/master/getStats.js\n\t\t\tif(config.bitrate.timer === null || config.bitrate.timer === undefined) {\n\t\t\t\tJanus.log(\"Starting bitrate timer (Firefox)\");\n\t\t\t\tconfig.bitrate.timer = setInterval(function() {\n\t\t\t\t\t// We need a helper callback\n\t\t\t\t\tvar cb = function(res) {\n\t\t\t\t\t\tif(res === null || res === undefined ||\n\t\t\t\t\t\t\t\tres.inbound_rtp_video_1 == null || res.inbound_rtp_video_1 == null) {\n\t\t\t\t\t\t\tconfig.bitrate.value = \"Missing inbound_rtp_video_1\";\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconfig.bitrate.bsnow = res.inbound_rtp_video_1.bytesReceived;\n\t\t\t\t\t\tconfig.bitrate.tsnow = res.inbound_rtp_video_1.timestamp;\n\t\t\t\t\t\tif(config.bitrate.bsbefore === null || config.bitrate.tsbefore === null) {\n\t\t\t\t\t\t\t// Skip this round\n\t\t\t\t\t\t\tconfig.bitrate.bsbefore = config.bitrate.bsnow;\n\t\t\t\t\t\t\tconfig.bitrate.tsbefore = config.bitrate.tsnow;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// Calculate bitrate\n\t\t\t\t\t\t\tvar bitRate = Math.round((config.bitrate.bsnow - config.bitrate.bsbefore) * 8 / (config.bitrate.tsnow - config.bitrate.tsbefore));\n\t\t\t\t\t\t\tconfig.bitrate.value = bitRate + ' kbits/sec';\n\t\t\t\t\t\t\tconfig.bitrate.bsbefore = config.bitrate.bsnow;\n\t\t\t\t\t\t\tconfig.bitrate.tsbefore = config.bitrate.tsnow;\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t\t// Actually get the stats\n\t\t\t\t\tconfig.pc.getStats(videoTracks[0], function(stats) {\n\t\t\t\t\t\tcb(stats);\n\t\t\t\t\t}, cb);\n\t\t\t\t}, 1000);\n\t\t\t\treturn \"0 kbits/sec\";\t// We don't have a bitrate value yet\n\t\t\t}\n\t\t\treturn config.bitrate.value;\n\t\t} else {\n\t\t\tJanus.warn(\"Getting the video bitrate unsupported by browser\");\n\t\t\treturn \"Feature unsupported by browser\";\n\t\t}\n\t}\n\n\tfunction webrtcError(error) {\n\t\tJanus.error(\"WebRTC error:\", error);\n\t}\n\n\tfunction cleanupWebrtc(handleId, hangupRequest) {\n\t\tJanus.log(\"Cleaning WebRTC stuff\");\n\t\tvar pluginHandle = pluginHandles[handleId];\n\t\tif(pluginHandle === null || pluginHandle === undefined) {\n\t\t\t// Nothing to clean\n\t\t\treturn;\n\t\t}\n\t\tvar config = pluginHandle.webrtcStuff;\n\t\tif(config !== null && config !== undefined) {\n\t\t\tif(hangupRequest === true) {\n\t\t\t\t// Send a hangup request (we don't really care about the response)\n\t\t\t\tvar request = { \"janus\": \"hangup\", \"transaction\": Janus.randomString(12) };\n\t\t\t\tif(token !== null && token !== undefined)\n\t\t\t\t\trequest[\"token\"] = token;\n\t\t\t\tif(apisecret !== null && apisecret !== undefined)\n\t\t\t\t\trequest[\"apisecret\"] = apisecret;\n\t\t\t\tJanus.debug(\"Sending hangup request (handle=\" + handleId + \"):\");\n\t\t\t\tJanus.debug(request);\n\t\t\t\tif(websockets) {\n\t\t\t\t\trequest[\"session_id\"] = sessionId;\n\t\t\t\t\trequest[\"handle_id\"] = handleId;\n\t\t\t\t\tws.send(JSON.stringify(request));\n\t\t\t\t} else {\n\t\t\t\t\t$.ajax({\n\t\t\t\t\t\ttype: 'POST',\n\t\t\t\t\t\turl: server + \"/\" + sessionId + \"/\" + handleId,\n\t\t\t\t\t\txhrFields: {\n\t\t\t\t\t\t\twithCredentials: withCredentials\n\t\t\t\t\t\t},\n\t\t\t\t\t\tcache: false,\n\t\t\t\t\t\tcontentType: \"application/json\",\n\t\t\t\t\t\tdata: JSON.stringify(request),\n\t\t\t\t\t\tdataType: \"json\"\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t\t// Cleanup stack\n\t\t\tconfig.remoteStream = null;\n\t\t\tif(config.volume.timer)\n\t\t\t\tclearInterval(config.volume.timer);\n\t\t\tconfig.volume.value = null;\n\t\t\tif(config.bitrate.timer)\n\t\t\t\tclearInterval(config.bitrate.timer);\n\t\t\tconfig.bitrate.timer = null;\n\t\t\tconfig.bitrate.bsnow = null;\n\t\t\tconfig.bitrate.bsbefore = null;\n\t\t\tconfig.bitrate.tsnow = null;\n\t\t\tconfig.bitrate.tsbefore = null;\n\t\t\tconfig.bitrate.value = null;\n\t\t\ttry {\n\t\t\t\t// Try a MediaStream.stop() first\n\t\t\t\tif(!config.streamExternal && config.myStream !== null && config.myStream !== undefined) {\n\t\t\t\t\tJanus.log(\"Stopping local stream\");\n\t\t\t\t\tconfig.myStream.stop();\n\t\t\t\t}\n\t\t\t} catch(e) {\n\t\t\t\t// Do nothing if this fails\n\t\t\t}\n\t\t\ttry {\n\t\t\t\t// Try a MediaStreamTrack.stop() for each track as well\n\t\t\t\tif(!config.streamExternal && config.myStream !== null && config.myStream !== undefined) {\n\t\t\t\t\tJanus.log(\"Stopping local stream tracks\");\n\t\t\t\t\tvar tracks = config.myStream.getTracks();\n\t\t\t\t\tfor(var i in tracks) {\n\t\t\t\t\t\tvar mst = tracks[i];\n\t\t\t\t\t\tJanus.log(mst);\n\t\t\t\t\t\tif(mst !== null && mst !== undefined)\n\t\t\t\t\t\t\tmst.stop();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch(e) {\n\t\t\t\t// Do nothing if this fails\n\t\t\t}\n\t\t\tconfig.streamExternal = false;\n\t\t\tconfig.myStream = null;\n\t\t\t// Close PeerConnection\n\t\t\ttry {\n\t\t\t\tconfig.pc.close();\n\t\t\t} catch(e) {\n\t\t\t\t// Do nothing\n\t\t\t}\n\t\t\tconfig.pc = null;\n\t\t\tconfig.mySdp = null;\n\t\t\tconfig.iceDone = false;\n\t\t\tconfig.sdpSent = false;\n\t\t\tconfig.dataChannel = null;\n\t\t\tconfig.dtmfSender = null;\n\t\t}\n\t\tpluginHandle.oncleanup();\n\t}\n\n\t// Helper methods to parse a media object\n\tfunction isAudioSendEnabled(media) {\n\t\tJanus.debug(\"isAudioSendEnabled:\", media);\n\t\tif(media === undefined || media === null)\n\t\t\treturn true;\t// Default\n\t\tif(media.audio === false)\n\t\t\treturn false;\t// Generic audio has precedence\n\t\tif(media.audioSend === undefined || media.audioSend === null)\n\t\t\treturn true;\t// Default\n\t\treturn (media.audioSend === true);\n\t}\n\n\tfunction isAudioSendRequired(media) {\n\t\tJanus.debug(\"isAudioSendRequired:\", media);\n\t\tif(media === undefined || media === null)\n\t\t\treturn false;\t// Default\n\t\tif(media.audio === false || media.audioSend === false)\n\t\t\treturn false;\t// If we're not asking to capture audio, it's not required\n\t\tif(media.failIfNoAudio === undefined || media.failIfNoAudio === null)\n\t\t\treturn false;\t// Default\n\t\treturn (media.failIfNoAudio === true);\n\t}\n\n\tfunction isAudioRecvEnabled(media) {\n\t\tJanus.debug(\"isAudioRecvEnabled:\", media);\n\t\tif(media === undefined || media === null)\n\t\t\treturn true;\t// Default\n\t\tif(media.audio === false)\n\t\t\treturn false;\t// Generic audio has precedence\n\t\tif(media.audioRecv === undefined || media.audioRecv === null)\n\t\t\treturn true;\t// Default\n\t\treturn (media.audioRecv === true);\n\t}\n\n\tfunction isVideoSendEnabled(media) {\n\t\tJanus.debug(\"isVideoSendEnabled:\", media);\n\t\tif(media === undefined || media === null)\n\t\t\treturn true;\t// Default\n\t\tif(media.video === false)\n\t\t\treturn false;\t// Generic video has precedence\n\t\tif(media.videoSend === undefined || media.videoSend === null)\n\t\t\treturn true;\t// Default\n\t\treturn (media.videoSend === true);\n\t}\n\n\tfunction isVideoSendRequired(media) {\n\t\tJanus.debug(\"isVideoSendRequired:\", media);\n\t\tif(media === undefined || media === null)\n\t\t\treturn false;\t// Default\n\t\tif(media.video === false || media.videoSend === false)\n\t\t\treturn false;\t// If we're not asking to capture video, it's not required\n\t\tif(media.failIfNoVideo === undefined || media.failIfNoVideo === null)\n\t\t\treturn false;\t// Default\n\t\treturn (media.failIfNoVideo === true);\n\t}\n\n\tfunction isVideoRecvEnabled(media) {\n\t\tJanus.debug(\"isVideoRecvEnabled:\", media);\n\t\tif(media === undefined || media === null)\n\t\t\treturn true;\t// Default\n\t\tif(media.video === false)\n\t\t\treturn false;\t// Generic video has precedence\n\t\tif(media.videoRecv === undefined || media.videoRecv === null)\n\t\t\treturn true;\t// Default\n\t\treturn (media.videoRecv === true);\n\t}\n\n\tfunction isDataEnabled(media) {\n\t\tJanus.debug(\"isDataEnabled:\", media);\n\t\tif(adapter.browserDetails.browser == \"edge\") {\n\t\t\tJanus.warn(\"Edge doesn't support data channels yet\");\n\t\t\treturn false;\n\t\t}\n\t\tif(media === undefined || media === null)\n\t\t\treturn false;\t// Default\n\t\treturn (media.data === true);\n\t}\n\n\tfunction isTrickleEnabled(trickle) {\n\t\tJanus.debug(\"isTrickleEnabled:\", trickle);\n\t\tif(trickle === undefined || trickle === null)\n\t\t\treturn true;\t// Default is true\n\t\treturn (trickle === true);\n\t}\n};\n"]},"metadata":{},"sourceType":"script"}